---
alwaysApply: true
---

# Repository Guidelines

## Project Structure & Module Organization
The workspace is managed via Bun workspaces. The main application lives in `apps/mesh/` and contains the full-stack MCP Mesh implementation (Hono API server + Vite/React client). Documentation site lives in `apps/docs/` (Astro-based). Shared logic sits in `packages/`:
- `packages/bindings/` - Core MCP bindings and connection abstractions
- `packages/runtime/` - Runtime utilities for MCP proxy, OAuth, and tools
- `packages/ui/` - Shared React components (shadcn-based design system)
- `packages/cli/` - CLI tooling for project scaffolding and management
- `packages/vite-plugin-deco/` - Vite plugin for Deco projects
- `packages/create-deco/` - Project scaffolding tool (npm init)

Database migrations live in `apps/mesh/migrations/`, code quality plugins in `plugins/`, and infrastructure/deploy configs in `deploy/`.

## Build, Test, and Development Commands
- `bun run dev`: boots the Mesh client (Vite) and server (Hono) locally, runs migrations first
- `bun run check`: TypeScript compile-only check for all workspaces
- `bun run lint`: runs oxlint with custom plugins (kebab-case enforcement, ban-use-effect, etc.)
- `bun run fmt` / `bun run fmt:check`: format or verify via Biome
- `bun test` / `bun test .`: run all tests in Bun test runner
- `bun run build:runtime`: build the runtime package
- `bun run docs:dev`: run documentation site locally

### Mesh-specific commands (from `apps/mesh/`)
- `bun run dev:client`: Vite dev server (port 4000)
- `bun run dev:server`: Hono server with hot reload
- `bun run build:client`: production client build
- `bun run build:server`: bundle server for deployment
- `bun run migrate`: run Kysely migrations
- `bun run better-auth:migrate`: run Better Auth schema migrations

## Database & Storage
Uses Kysely ORM with support for both SQLite (default, via `kysely-bun-worker`) and PostgreSQL. Database URL is configured via `DATABASE_URL` environment variable. Defaults to `file:./data/mesh.db`. Migrations use Kysely's migration system combined with Better Auth migrations.

## Coding Style & Naming Conventions
Biome enforces two-space indentation and double quotes. Components and classes use PascalCase, hooks and utilities use camelCase. Oxlint plugins enforce additional rules:
- `plugins/enforce-kebab-case-file-names.ts` - kebab-case for files in shared packages
- `plugins/enforce-query-key-constants.ts` - query keys must use constants
- `plugins/ban-use-effect.ts` - ban useEffect (prefer alternatives)
- `plugins/ban-memoization.ts` - ban useMemo/useCallback/memo (React 19 compiler handles this)
- `plugins/ensure-tailwind-design-system-tokens.ts` - enforce Tailwind design system consistency

Favor TypeScript types over `any`. The repository uses React 19 with the React Compiler (babel-plugin-react-compiler) and Tailwind v4.

## Testing Guidelines
Bun is the test runner throughout. Co-locate test files next to source as `*.test.ts` or `*.test.tsx`. Test files use Bun's built-in test framework. Run `bun test` before raising a PR. Add targeted integration tests when touching API endpoints or database operations. Document any intentional coverage gaps in PR descriptions.

## Authentication & Authorization
Uses Better Auth for authentication (OAuth 2.1 + SSO + API keys). Authorization uses custom AccessControl layer with organization/project-level RBAC. Auth configuration is in `apps/mesh/auth-config.json` (example: `auth-config.example.json`).

## Event Bus
The MCP Mesh includes an event bus for pub/sub between connections. Key components:
- **Events**: Follow CloudEvents v1.0 spec with `type`, `source`, `id`, `time`, `data`
- **Subscriptions**: Connect subscribers to event types with optional publisher filter
- **Delivery**: At-least-once with exponential backoff (1s to 1hr, max 20 attempts)
- **Scheduling**: Supports immediate, scheduled (`deliverAt`), and recurring (`cron`) delivery
- **Per-event results**: Subscribers can return individual results per event in batch

### Event Bus Files
- `packages/bindings/src/well-known/event-bus.ts` - EVENT_BUS_BINDING (PUBLISH, SUBSCRIBE, UNSUBSCRIBE, CANCEL, ACK)
- `packages/bindings/src/well-known/event-subscriber.ts` - EVENT_SUBSCRIBER_BINDING (ON_EVENTS)
- `apps/mesh/src/event-bus/` - EventBus implementation and worker
- `apps/mesh/src/event-bus/polling.ts` - Timer-based NotifyStrategy (for SQLite/other)
- `apps/mesh/src/event-bus/postgres-notify.ts` - LISTEN/NOTIFY NotifyStrategy (for PostgreSQL)
- `apps/mesh/src/storage/event-bus.ts` - Database operations
- `apps/mesh/src/tools/eventbus/` - MCP tools (publish, subscribe, unsubscribe, list, cancel, ack)
- `apps/mesh/migrations/008-event-bus.ts` - Database schema

### Event Bus MCP Tools
- `EVENT_PUBLISH` - Publish events (supports `deliverAt` for scheduled, `cron` for recurring)
- `EVENT_SUBSCRIBE` - Subscribe to event types
- `EVENT_UNSUBSCRIBE` - Remove subscriptions
- `EVENT_SUBSCRIPTION_LIST` - List subscriptions
- `EVENT_CANCEL` - Cancel a recurring cron event (only publisher can cancel)
- `EVENT_ACK` - Acknowledge event delivery (used with `retryAfter` flow)

### Event Bus Bindings
- `EVENT_BUS_BINDING` - For connections using the event bus (PUBLISH, SUBSCRIBE, UNSUBSCRIBE, CANCEL, ACK)
- `EVENT_SUBSCRIBER_BINDING` - For connections receiving events (implements `ON_EVENTS`)

### ON_EVENTS Response
Subscribers can return batch or per-event results:
```typescript
// Batch mode
{ success: true }

// Per-event mode
{
  results: {
    "event-1": { success: true },
    "event-2": { success: false, error: "Validation failed" },
    "event-3": { retryAfter: 60000 }  // Retry in 1 minute, use EVENT_ACK to confirm
  }
}
```

### NotifyStrategy Architecture
The worker doesn't poll internally - it relies on a NotifyStrategy to trigger processing:
- `PollingStrategy(intervalMs)` - Timer-based, for SQLite or databases without pub/sub
- `PostgresNotifyStrategy(pool)` - Event-based via LISTEN/NOTIFY, no polling

### Event Bus Configuration (EventBusConfig)
```typescript
{
  pollIntervalMs: 5000,    // Poll interval for PollingStrategy (default 5s)
  batchSize: 100,          // Max events per batch
  maxAttempts: 20,         // Delivery attempts before failure
  retryDelayMs: 1000,      // Base delay (1s)
  maxDelayMs: 3600000,     // Max delay cap (1hr)
}
```

## Commit & Pull Request Guidelines
Follow Conventional Commit-style history: `type(scope): message`, optionally wrapping the type in brackets for chores (e.g., `[chore]: update deps`). Reference issues with `(#1234)` when applicable. PRs should include:
- Succinct summary of changes
- Testing notes and affected areas
- Screenshots for UI changes
- Confirm formatting (`bun run fmt`) and linting (`bun run lint`) pass
- Run tests (`bun test`) before requesting review
- Flag follow-up work with TODOs linked to issues
