---
phase: 01-plugin-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mesh-plugin-site-builder/package.json
  - packages/mesh-plugin-site-builder/tsconfig.json
  - packages/mesh-plugin-site-builder/index.tsx
  - packages/mesh-plugin-site-builder/lib/binding.ts
  - packages/mesh-plugin-site-builder/lib/router.ts
  - packages/mesh-plugin-site-builder/lib/query-keys.ts
autonomous: true

must_haves:
  truths:
    - "Plugin package compiles without TypeScript errors"
    - "Plugin exports siteBuilderPlugin object with correct interface"
    - "SITE_BUILDER_BINDING extends OBJECT_STORAGE_BINDING"
    - "Router defines / and /$connectionId routes"
  artifacts:
    - path: "packages/mesh-plugin-site-builder/package.json"
      provides: "Package manifest with dependencies"
      contains: "mesh-plugin-site-builder"
    - path: "packages/mesh-plugin-site-builder/index.tsx"
      provides: "Plugin definition and registration"
      exports: ["siteBuilderPlugin"]
    - path: "packages/mesh-plugin-site-builder/lib/binding.ts"
      provides: "SITE_BUILDER_BINDING type definition"
      exports: ["SITE_BUILDER_BINDING"]
    - path: "packages/mesh-plugin-site-builder/lib/router.ts"
      provides: "Typed router with routes"
      exports: ["siteBuilderRouter"]
    - path: "packages/mesh-plugin-site-builder/lib/query-keys.ts"
      provides: "Query key factory"
      exports: ["KEYS"]
  key_links:
    - from: "packages/mesh-plugin-site-builder/index.tsx"
      to: "packages/mesh-plugin-site-builder/lib/binding.ts"
      via: "import SITE_BUILDER_BINDING"
      pattern: "import.*SITE_BUILDER_BINDING.*from.*binding"
    - from: "packages/mesh-plugin-site-builder/index.tsx"
      to: "packages/mesh-plugin-site-builder/lib/router.ts"
      via: "import siteBuilderRouter"
      pattern: "import.*siteBuilderRouter.*from.*router"
---

<objective>
Create the Site Builder plugin scaffold with package configuration, binding definition, router setup, and query key factory.

Purpose: Establish the foundational files that all other plugin components will depend on. This follows the exact patterns from mesh-plugin-task-runner.

Output: A compilable plugin package with proper TypeScript types, binding definition that extends OBJECT_STORAGE_BINDING, and router configured for /sites routes.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-plugin-foundation/01-RESEARCH.md

# Reference implementation to follow
@packages/mesh-plugin-task-runner/package.json
@packages/mesh-plugin-task-runner/index.tsx
@packages/mesh-plugin-task-runner/lib/router.ts
@packages/bindings/src/well-known/object-storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plugin package scaffold</name>
  <files>
    packages/mesh-plugin-site-builder/package.json
    packages/mesh-plugin-site-builder/tsconfig.json
  </files>
  <action>
Create the plugin package directory and configuration files.

**package.json:**
- name: "mesh-plugin-site-builder"
- version: "0.1.0"
- private: true
- type: "module"
- main: "./index.tsx"
- scripts: { "check": "tsc --noEmit" }
- dependencies (copy from mesh-plugin-task-runner):
  - "@decocms/bindings": "workspace:*"
  - "@deco/ui": "workspace:*"
  - "@tanstack/react-query": "5.90.11"
  - "@untitledui/icons": "^0.0.19"
  - "react": "^19.2.0"
  - "sonner": "^2.0.7"
  - "zod": "^3.24.4"

**tsconfig.json:**
- extends: "../../tsconfig.json" (standard monorepo pattern)
- compilerOptions.outDir: "./dist"
- include: ["./**/*.ts", "./**/*.tsx"]
  </action>
  <verify>
Run `cd packages/mesh-plugin-site-builder && cat package.json && cat tsconfig.json` to verify files exist with correct content.
  </verify>
  <done>
package.json has correct name, dependencies, and main entry point. tsconfig.json extends root config.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create binding definition and query keys</name>
  <files>
    packages/mesh-plugin-site-builder/lib/binding.ts
    packages/mesh-plugin-site-builder/lib/query-keys.ts
  </files>
  <action>
Create the lib directory with binding and query key definitions.

**lib/binding.ts:**
```typescript
/**
 * Site Builder Binding
 *
 * Extends OBJECT_STORAGE_BINDING to inherit file operations.
 * Site detection is done via runtime file checks (deno.json with deco imports),
 * not via additional binding requirements.
 */

import { OBJECT_STORAGE_BINDING } from "@decocms/bindings";
import type { Binder } from "@decocms/bindings";

/**
 * Site Builder uses the same binding as object storage.
 * Connection filtering for "site" detection happens at runtime
 * by checking for deno.json with deco/ imports.
 */
export const SITE_BUILDER_BINDING = [
  ...OBJECT_STORAGE_BINDING,
] as const satisfies Binder;

export type SiteBuilderBinding = typeof SITE_BUILDER_BINDING;
```

**lib/query-keys.ts:**
```typescript
/**
 * Query Key Factory for Site Builder Plugin
 *
 * Prefixes all keys with "site-builder" to prevent cache collisions.
 */

export const KEYS = {
  all: ["site-builder"] as const,
  siteDetection: (connectionId: string) =>
    ["site-builder", "site-detection", connectionId] as const,
  workspace: (connectionId: string) =>
    ["site-builder", "workspace", connectionId] as const,
  devServer: (connectionId: string) =>
    ["site-builder", "dev-server", connectionId] as const,
  pages: (connectionId: string) =>
    ["site-builder", "pages", connectionId] as const,
};
```
  </action>
  <verify>
Run `cd packages/mesh-plugin-site-builder && ls -la lib/` to verify files exist.
  </verify>
  <done>
binding.ts exports SITE_BUILDER_BINDING extending OBJECT_STORAGE_BINDING.
query-keys.ts exports KEYS factory with site-builder prefix.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create router and plugin entry point</name>
  <files>
    packages/mesh-plugin-site-builder/lib/router.ts
    packages/mesh-plugin-site-builder/index.tsx
  </files>
  <action>
Create the router configuration and main plugin entry point.

**lib/router.ts:**
```typescript
/**
 * Site Builder Plugin Router
 *
 * Provides typed routing for the site builder plugin.
 * Routes:
 * - / : Site list (shows filtered connections)
 * - /$connectionId : Site detail with preview
 */

import { createPluginRouter } from "@decocms/bindings/plugins";
import * as z from "zod";

/**
 * Search schema for site detail route.
 */
const siteDetailSearchSchema = z.object({
  page: z.string().optional().describe("Current page route being previewed"),
});

export type SiteDetailSearch = z.infer<typeof siteDetailSearchSchema>;

/**
 * Plugin router with typed hooks for navigation.
 */
export const siteBuilderRouter = createPluginRouter((ctx) => {
  const { createRoute, lazyRouteComponent } = ctx.routing;

  const indexRoute = createRoute({
    getParentRoute: () => ctx.parentRoute,
    path: "/",
    component: lazyRouteComponent(() => import("../components/site-list")),
  });

  const detailRoute = createRoute({
    getParentRoute: () => ctx.parentRoute,
    path: "/$connectionId",
    component: lazyRouteComponent(() => import("../components/site-detail")),
    validateSearch: siteDetailSearchSchema,
  });

  return [indexRoute, detailRoute];
});
```

**index.tsx:**
```typescript
/**
 * Site Builder Plugin
 *
 * Provides AI-assisted site building with live preview.
 * Filters connections to show only local-fs MCPs with deno.json containing deco imports.
 */

import { lazy } from "react";
import { Globe01 } from "@untitledui/icons";
import type { Plugin, PluginSetupContext } from "@decocms/bindings/plugins";
import { SITE_BUILDER_BINDING } from "./lib/binding";
import { siteBuilderRouter } from "./lib/router";

// Lazy load components
const PluginHeader = lazy(() => import("./components/plugin-header"));
const PluginEmptyState = lazy(() => import("./components/plugin-empty-state"));

/**
 * Site Builder Plugin Definition
 */
export const siteBuilderPlugin: Plugin<typeof SITE_BUILDER_BINDING> = {
  id: "site-builder",
  description: "AI-assisted site building with live preview",
  binding: SITE_BUILDER_BINDING,
  renderHeader: (props) => <PluginHeader {...props} />,
  renderEmptyState: () => <PluginEmptyState />,
  setup: (context: PluginSetupContext) => {
    const { registerRootSidebarItem, registerPluginRoutes } = context;

    // Register sidebar item with Globe icon
    registerRootSidebarItem({
      icon: <Globe01 size={20} />,
      label: "Sites",
    });

    // Create and register plugin routes
    const routes = siteBuilderRouter.createRoutes(context);
    registerPluginRoutes(routes);
  },
};
```

Note: The lazy imports for PluginHeader and PluginEmptyState will cause compile errors until Plan 02 creates those components. Create placeholder files to allow compilation:

**components/plugin-header.tsx (placeholder):**
```typescript
export default function PluginHeader() {
  return <div>Header placeholder</div>;
}
```

**components/plugin-empty-state.tsx (placeholder):**
```typescript
export default function PluginEmptyState() {
  return <div>Empty state placeholder</div>;
}
```

**components/site-list.tsx (placeholder):**
```typescript
export default function SiteList() {
  return <div>Site list placeholder</div>;
}
```

**components/site-detail.tsx (placeholder):**
```typescript
export default function SiteDetail() {
  return <div>Site detail placeholder</div>;
}
```
  </action>
  <verify>
Run `cd packages/mesh-plugin-site-builder && npx tsc --noEmit` to verify TypeScript compiles without errors.
  </verify>
  <done>
- index.tsx exports siteBuilderPlugin implementing Plugin interface
- Router defines / and /$connectionId routes with lazy loading
- Plugin registers "Sites" sidebar item with Globe01 icon
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Structure check:**
   ```bash
   ls -la packages/mesh-plugin-site-builder/
   ls -la packages/mesh-plugin-site-builder/lib/
   ls -la packages/mesh-plugin-site-builder/components/
   ```

2. **TypeScript compilation:**
   ```bash
   cd packages/mesh-plugin-site-builder && npx tsc --noEmit
   ```

3. **Export verification:**
   ```bash
   grep -r "export" packages/mesh-plugin-site-builder/index.tsx
   grep -r "export" packages/mesh-plugin-site-builder/lib/binding.ts
   ```
</verification>

<success_criteria>
- [ ] packages/mesh-plugin-site-builder/package.json exists with correct dependencies
- [ ] packages/mesh-plugin-site-builder/tsconfig.json extends root config
- [ ] packages/mesh-plugin-site-builder/index.tsx exports siteBuilderPlugin
- [ ] packages/mesh-plugin-site-builder/lib/binding.ts exports SITE_BUILDER_BINDING
- [ ] packages/mesh-plugin-site-builder/lib/router.ts exports siteBuilderRouter
- [ ] packages/mesh-plugin-site-builder/lib/query-keys.ts exports KEYS
- [ ] TypeScript compiles without errors
- [ ] Plugin uses Globe01 icon and "Sites" label
</success_criteria>

<output>
After completion, create `.planning/phases/01-plugin-foundation/01-01-SUMMARY.md`
</output>
