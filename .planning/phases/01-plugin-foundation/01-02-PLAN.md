---
phase: 01-plugin-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - packages/mesh-plugin-site-builder/hooks/use-site-detection.ts
  - packages/mesh-plugin-site-builder/components/plugin-header.tsx
  - packages/mesh-plugin-site-builder/components/plugin-empty-state.tsx
  - packages/mesh-plugin-site-builder/components/site-list.tsx
  - packages/mesh-plugin-site-builder/components/site-detail.tsx
autonomous: false

must_haves:
  truths:
    - "User sees 'Sites' sidebar item in Mesh UI"
    - "Connection dropdown shows only connections detected as Deco sites"
    - "Non-Deco connections are filtered out or shown with indicator"
    - "Navigating to /sites/:connectionId shows preview placeholder"
    - "Empty state shows when no site connections available"
  artifacts:
    - path: "packages/mesh-plugin-site-builder/hooks/use-site-detection.ts"
      provides: "Hook for detecting Deco sites via deno.json"
      exports: ["useSiteDetection"]
    - path: "packages/mesh-plugin-site-builder/components/plugin-header.tsx"
      provides: "Connection dropdown with site filtering"
      min_lines: 50
    - path: "packages/mesh-plugin-site-builder/components/plugin-empty-state.tsx"
      provides: "Empty state when no sites available"
      min_lines: 15
    - path: "packages/mesh-plugin-site-builder/components/site-list.tsx"
      provides: "List of detected sites"
      min_lines: 30
    - path: "packages/mesh-plugin-site-builder/components/site-detail.tsx"
      provides: "Site detail view with preview placeholder"
      min_lines: 40
  key_links:
    - from: "packages/mesh-plugin-site-builder/components/plugin-header.tsx"
      to: "packages/mesh-plugin-site-builder/hooks/use-site-detection.ts"
      via: "useSiteDetection hook call"
      pattern: "useSiteDetection"
    - from: "packages/mesh-plugin-site-builder/components/site-detail.tsx"
      to: "preview placeholder"
      via: "iframe or div placeholder"
      pattern: "preview|Preview|iframe"
---

<objective>
Implement the Site Builder UI components including stack detection hook, connection header, empty state, site list, and site detail with preview placeholder.

Purpose: Complete the Phase 1 deliverables by wiring up the UI layer that makes the plugin functional and user-facing.

Output: Working plugin UI where users can see "Sites" in sidebar, view filtered connections, and navigate to site detail with preview placeholder.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-plugin-foundation/01-RESEARCH.md
@.planning/phases/01-plugin-foundation/01-01-SUMMARY.md

# Reference implementation
@packages/mesh-plugin-task-runner/components/plugin-header.tsx
@packages/mesh-plugin-task-runner/components/plugin-empty-state.tsx
@packages/mesh-plugin-task-runner/components/task-board.tsx
@packages/mesh-plugin-task-runner/hooks/use-tasks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create site detection hook</name>
  <files>
    packages/mesh-plugin-site-builder/hooks/use-site-detection.ts
  </files>
  <action>
Create the stack detection hook that checks if a connection is a Deco site.

**hooks/use-site-detection.ts:**
```typescript
/**
 * Site Detection Hook
 *
 * Detects if a connection is a Deco/Fresh site by checking for deno.json
 * with deco/ imports. Uses TanStack Query for caching.
 */

import { useQuery } from "@tanstack/react-query";
import { usePluginContext } from "@decocms/bindings/plugins";
import { KEYS } from "../lib/query-keys";
import type { SiteBuilderBinding } from "../lib/binding";

export interface SiteDetectionResult {
  isSite: boolean;
  stack: "deno-deco" | "deno" | null;
  error?: string;
}

/**
 * Check if a connection is a Deco site by reading deno.json
 */
export function useSiteDetection(connectionId: string | undefined) {
  const { toolCaller, connection } =
    usePluginContext<SiteBuilderBinding>();

  return useQuery({
    queryKey: connectionId ? KEYS.siteDetection(connectionId) : ["disabled"],
    queryFn: async (): Promise<SiteDetectionResult> => {
      // Check if read_file tool is available
      const hasReadFile = connection?.tools?.some(
        (t) => t.name === "read_file"
      );

      if (!hasReadFile) {
        return {
          isSite: false,
          stack: null,
          error: "Connection does not support read_file",
        };
      }

      try {
        // Cast for untyped tool call
        const untypedToolCaller = toolCaller as unknown as (
          name: string,
          args: Record<string, unknown>
        ) => Promise<{ content?: string } | string>;

        const result = await untypedToolCaller("read_file", {
          path: "deno.json",
        });

        const content =
          typeof result === "string" ? result : result?.content;

        if (!content) {
          return { isSite: false, stack: null };
        }

        const config = JSON.parse(content);

        // Check for deco import in imports map
        const imports = config.imports || {};
        const hasDeco =
          imports["deco/"] ||
          imports.deco ||
          Object.values(imports).some(
            (val: unknown) =>
              typeof val === "string" && val.includes("deco")
          );

        if (hasDeco) {
          return { isSite: true, stack: "deno-deco" };
        }

        // Has deno.json but no deco
        return { isSite: false, stack: "deno" };
      } catch (error) {
        // No deno.json or parse error
        return {
          isSite: false,
          stack: null,
          error: error instanceof Error ? error.message : "Unknown error",
        };
      }
    },
    enabled: !!connectionId && !!toolCaller,
    staleTime: 60 * 1000, // Cache for 1 minute
    retry: false, // Don't retry on file not found
  });
}

/**
 * Hook to detect sites for multiple connections
 */
export function useMultiSiteDetection(connectionIds: string[]) {
  const { toolCaller, connection } =
    usePluginContext<SiteBuilderBinding>();

  // Use a single query that checks all connections
  // This is more efficient than multiple individual queries
  return useQuery({
    queryKey: ["site-builder", "multi-detection", connectionIds.join(",")],
    queryFn: async () => {
      const hasReadFile = connection?.tools?.some(
        (t) => t.name === "read_file"
      );

      if (!hasReadFile) {
        return {};
      }

      // Note: In a real implementation, you'd want to batch these
      // For now, return empty and let individual detection happen
      return {} as Record<string, SiteDetectionResult>;
    },
    enabled: connectionIds.length > 0 && !!toolCaller,
    staleTime: 60 * 1000,
  });
}
```
  </action>
  <verify>
Run `cd packages/mesh-plugin-site-builder && npx tsc --noEmit` to verify hook compiles.
  </verify>
  <done>
- useSiteDetection hook exports and checks for deno.json with deco imports
- Returns { isSite, stack, error? } result object
- Uses KEYS.siteDetection for query key
- Properly handles missing read_file tool
  </done>
</task>

<task type="auto">
  <name>Task 2: Create header and empty state components</name>
  <files>
    packages/mesh-plugin-site-builder/components/plugin-header.tsx
    packages/mesh-plugin-site-builder/components/plugin-empty-state.tsx
  </files>
  <action>
Replace the placeholder components with full implementations.

**components/plugin-header.tsx:**
```typescript
/**
 * Plugin Header Component
 *
 * Connection selector for the site builder plugin.
 * Shows site detection status badge for each connection.
 */

import type { PluginRenderHeaderProps } from "@decocms/bindings/plugins";
import { Globe01, ChevronDown, Check } from "@untitledui/icons";
import { useState, useRef } from "react";
import { useSiteDetection } from "../hooks/use-site-detection";

/**
 * Badge showing site detection status
 */
function SiteBadge({ connectionId }: { connectionId: string }) {
  const { data, isLoading } = useSiteDetection(connectionId);

  if (isLoading) {
    return (
      <span className="text-[10px] px-1.5 py-0.5 rounded bg-muted text-muted-foreground">
        ...
      </span>
    );
  }

  if (data?.isSite) {
    return (
      <span className="text-[10px] px-1.5 py-0.5 rounded bg-green-100 text-green-700">
        Deco
      </span>
    );
  }

  return null;
}

/**
 * Connection dropdown for selecting a site
 */
function ConnectionSelector({
  connections,
  selectedConnectionId,
  onConnectionChange,
}: PluginRenderHeaderProps) {
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);

  const selectedConnection = connections.find(
    (c) => c.id === selectedConnectionId
  );

  const handleBlur = (e: React.FocusEvent) => {
    if (!dropdownRef.current?.contains(e.relatedTarget as Node)) {
      setIsOpen(false);
    }
  };

  // Single connection - show static label
  if (connections.length === 1) {
    return (
      <div className="flex items-center gap-2 text-sm text-muted-foreground">
        {selectedConnection?.icon ? (
          <img
            src={selectedConnection.icon}
            alt=""
            className="size-4 rounded"
          />
        ) : (
          <Globe01 size={16} />
        )}
        <span>{selectedConnection?.title || "Site Builder"}</span>
        {selectedConnectionId && <SiteBadge connectionId={selectedConnectionId} />}
      </div>
    );
  }

  // Multiple connections - show dropdown
  return (
    <div className="relative" ref={dropdownRef} onBlur={handleBlur}>
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-md border border-border bg-background hover:bg-accent transition-colors"
      >
        {selectedConnection?.icon ? (
          <img
            src={selectedConnection.icon}
            alt=""
            className="size-4 rounded"
          />
        ) : (
          <Globe01 size={16} />
        )}
        <span>{selectedConnection?.title || "Select site"}</span>
        {selectedConnectionId && <SiteBadge connectionId={selectedConnectionId} />}
        <ChevronDown size={14} />
      </button>

      {isOpen && (
        <div className="absolute left-0 top-full mt-1 z-50 min-w-56 rounded-md border border-border bg-popover p-1 shadow-md">
          {connections.map((connection) => (
            <button
              key={connection.id}
              type="button"
              onClick={() => {
                onConnectionChange(connection.id);
                setIsOpen(false);
              }}
              className="flex items-center gap-2 w-full px-2 py-1.5 text-sm rounded-sm hover:bg-accent transition-colors"
            >
              {connection.icon ? (
                <img src={connection.icon} alt="" className="size-4 rounded" />
              ) : (
                <Globe01 size={16} />
              )}
              <span className="flex-1 text-left">{connection.title}</span>
              <SiteBadge connectionId={connection.id} />
              {connection.id === selectedConnectionId && (
                <Check size={14} className="text-primary" />
              )}
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

export default function PluginHeader(props: PluginRenderHeaderProps) {
  return (
    <div className="flex items-center justify-between px-5 py-3 border-b border-border">
      <ConnectionSelector {...props} />
    </div>
  );
}
```

**components/plugin-empty-state.tsx:**
```typescript
/**
 * Plugin Empty State Component
 *
 * Shown when no Site Builder compatible connection is available.
 */

import { Globe01 } from "@untitledui/icons";

export default function PluginEmptyState() {
  return (
    <div className="flex flex-col items-center justify-center h-full text-center p-8">
      <div className="w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4">
        <Globe01 size={32} className="text-muted-foreground" />
      </div>
      <h3 className="text-lg font-semibold mb-2">No Sites Connected</h3>
      <p className="text-muted-foreground max-w-md mb-4">
        Connect a local folder containing a Deno/Deco site to start building
        with AI assistance.
      </p>
      <p className="text-sm text-muted-foreground">
        Sites are detected by looking for{" "}
        <code className="bg-muted px-1 rounded">deno.json</code> with{" "}
        <code className="bg-muted px-1 rounded">deco/</code> imports.
      </p>
    </div>
  );
}
```
  </action>
  <verify>
Run `cd packages/mesh-plugin-site-builder && npx tsc --noEmit` to verify components compile.
  </verify>
  <done>
- plugin-header.tsx shows connection dropdown with Deco badge
- plugin-empty-state.tsx explains how to connect a site
- Both components follow task-runner patterns
  </done>
</task>

<task type="auto">
  <name>Task 3: Create site list and detail views</name>
  <files>
    packages/mesh-plugin-site-builder/components/site-list.tsx
    packages/mesh-plugin-site-builder/components/site-detail.tsx
  </files>
  <action>
Create the main route components for site list and detail views.

**components/site-list.tsx:**
```typescript
/**
 * Site List Component
 *
 * Shows available sites from connected storage.
 * This is a simple view since connection selection happens in the header.
 */

import { Globe01 } from "@untitledui/icons";
import { useSiteDetection } from "../hooks/use-site-detection";
import { usePluginContext, useParams } from "@decocms/bindings/plugins";
import type { SiteBuilderBinding } from "../lib/binding";

export default function SiteList() {
  const { connectionId } = usePluginContext<SiteBuilderBinding>();
  const { data: detection, isLoading } = useSiteDetection(connectionId);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-sm text-muted-foreground">Detecting site...</div>
      </div>
    );
  }

  if (!detection?.isSite) {
    return (
      <div className="flex flex-col items-center justify-center h-64 text-center p-8">
        <Globe01 size={48} className="text-muted-foreground mb-4" />
        <h3 className="text-lg font-semibold mb-2">Not a Deco Site</h3>
        <p className="text-muted-foreground max-w-md">
          This folder doesn't appear to be a Deco site. Make sure it has a{" "}
          <code className="bg-muted px-1 rounded">deno.json</code> with Deco
          imports.
        </p>
        {detection?.stack === "deno" && (
          <p className="text-sm text-muted-foreground mt-2">
            Detected: Deno project (but no Deco imports found)
          </p>
        )}
      </div>
    );
  }

  return (
    <div className="p-6 max-w-4xl mx-auto">
      <div className="flex items-center gap-3 mb-6">
        <div className="p-3 rounded-lg bg-green-100">
          <Globe01 size={24} className="text-green-700" />
        </div>
        <div>
          <h2 className="text-xl font-semibold">Deco Site Detected</h2>
          <p className="text-sm text-muted-foreground">
            Stack: {detection.stack}
          </p>
        </div>
      </div>

      <div className="bg-card border border-border rounded-lg p-6">
        <h3 className="font-medium mb-4">Getting Started</h3>
        <p className="text-sm text-muted-foreground mb-4">
          This site is ready for AI-assisted building. In the next phase, you'll
          be able to:
        </p>
        <ul className="list-disc list-inside text-sm text-muted-foreground space-y-2">
          <li>Start the dev server with live preview</li>
          <li>Select pages to preview and edit</li>
          <li>Create tasks for AI agents to implement</li>
        </ul>
      </div>
    </div>
  );
}
```

**components/site-detail.tsx:**
```typescript
/**
 * Site Detail Component
 *
 * Main view for a connected site. Shows:
 * - Preview area (placeholder in Phase 1)
 * - Collapsible task panel (Phase 3)
 */

import { Globe01, Play, Folder } from "@untitledui/icons";
import { usePluginContext, useParams, useSearch } from "@decocms/bindings/plugins";
import { useSiteDetection } from "../hooks/use-site-detection";
import type { SiteBuilderBinding } from "../lib/binding";
import type { SiteDetailSearch } from "../lib/router";

/**
 * Preview placeholder component
 * Will be replaced with actual iframe in Phase 2
 */
function PreviewPlaceholder() {
  return (
    <div className="flex-1 flex flex-col items-center justify-center bg-muted/30 border border-dashed border-border rounded-lg m-4">
      <div className="text-center p-8">
        <div className="w-16 h-16 rounded-full bg-muted flex items-center justify-center mx-auto mb-4">
          <Play size={32} className="text-muted-foreground" />
        </div>
        <h3 className="text-lg font-semibold mb-2">Live Preview</h3>
        <p className="text-muted-foreground max-w-md mb-4">
          Start the dev server to see your site here with hot module reloading.
        </p>
        <button
          type="button"
          disabled
          className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md bg-primary text-primary-foreground opacity-50 cursor-not-allowed"
        >
          <Play size={16} />
          Start Dev Server
        </button>
        <p className="text-xs text-muted-foreground mt-3">
          (Coming in Phase 2)
        </p>
      </div>
    </div>
  );
}

/**
 * Info bar showing workspace and status
 */
function InfoBar({ stack }: { stack: string | null }) {
  return (
    <div className="flex items-center justify-between px-4 py-2 border-b border-border bg-muted/30">
      <div className="flex items-center gap-4">
        <div className="flex items-center gap-2 text-sm">
          <Folder size={14} className="text-muted-foreground" />
          <span className="text-muted-foreground">Workspace connected</span>
        </div>
        {stack && (
          <span className="text-xs px-2 py-0.5 rounded bg-green-100 text-green-700">
            {stack}
          </span>
        )}
      </div>
      <div className="flex items-center gap-2">
        <span className="text-xs text-muted-foreground">
          Dev server: <span className="text-yellow-600">stopped</span>
        </span>
      </div>
    </div>
  );
}

export default function SiteDetail() {
  const { connectionId } = usePluginContext<SiteBuilderBinding>();
  const search = useSearch({ strict: false }) as SiteDetailSearch;
  const { data: detection, isLoading } = useSiteDetection(connectionId);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-full">
        <div className="text-sm text-muted-foreground">Loading site...</div>
      </div>
    );
  }

  if (!detection?.isSite) {
    return (
      <div className="flex flex-col items-center justify-center h-full text-center p-8">
        <Globe01 size={48} className="text-muted-foreground mb-4" />
        <h3 className="text-lg font-semibold mb-2">Not a Deco Site</h3>
        <p className="text-muted-foreground max-w-md">
          Select a connection with a valid Deco site (deno.json with deco/
          imports).
        </p>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-full">
      <InfoBar stack={detection.stack} />
      <PreviewPlaceholder />
    </div>
  );
}
```
  </action>
  <verify>
Run `cd packages/mesh-plugin-site-builder && npx tsc --noEmit` to verify all components compile.
  </verify>
  <done>
- site-list.tsx shows site detection result and getting started info
- site-detail.tsx shows preview placeholder with info bar
- Both use useSiteDetection hook for stack detection
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Site Builder plugin with:
- Plugin registered with "Sites" sidebar item (Globe icon)
- Connection dropdown with Deco detection badges
- Site detection via deno.json with deco/ imports
- Site list and detail views with preview placeholder
  </what-built>
  <how-to-verify>
1. Start the Mesh dev server: `cd apps/mesh && bun dev`
2. Open browser to http://localhost:3000
3. Verify "Sites" appears in the sidebar
4. Connect a local-fs MCP pointing to a Deco site folder
5. Verify connection shows "Deco" badge if site detected
6. Navigate to /sites/:connectionId and see preview placeholder
7. Try with a non-Deco folder and verify appropriate message
  </how-to-verify>
  <resume-signal>Type "approved" if the plugin appears and works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript compilation:**
   ```bash
   cd packages/mesh-plugin-site-builder && npx tsc --noEmit
   ```

2. **File structure:**
   ```bash
   find packages/mesh-plugin-site-builder -name "*.tsx" -o -name "*.ts" | head -20
   ```

3. **Export verification:**
   ```bash
   grep -r "export" packages/mesh-plugin-site-builder/hooks/
   grep -r "export default" packages/mesh-plugin-site-builder/components/
   ```
</verification>

<success_criteria>
- [ ] hooks/use-site-detection.ts exports useSiteDetection hook
- [ ] components/plugin-header.tsx shows connection dropdown with Deco badges
- [ ] components/plugin-empty-state.tsx shows helpful empty state
- [ ] components/site-list.tsx shows site detection result
- [ ] components/site-detail.tsx shows preview placeholder
- [ ] All TypeScript compiles without errors
- [ ] Human verification: Plugin visible in Mesh UI with working navigation
</success_criteria>

<output>
After completion, create `.planning/phases/01-plugin-foundation/01-02-SUMMARY.md`
</output>
