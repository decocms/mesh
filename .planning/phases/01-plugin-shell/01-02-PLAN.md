---
phase: 01-plugin-shell
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mesh-plugin-site-editor/client/components/preview-panel.tsx
  - packages/mesh-plugin-site-editor/client/lib/use-tunnel-url.ts
autonomous: true

must_haves:
  truths:
    - "Preview panel component renders an iframe pointing to a tunnel URL"
    - "Tunnel URL is discovered from project connection metadata or plugin config"
  artifacts:
    - path: "packages/mesh-plugin-site-editor/client/components/preview-panel.tsx"
      provides: "iframe-based preview panel component"
      exports: ["PreviewPanel"]
    - path: "packages/mesh-plugin-site-editor/client/lib/use-tunnel-url.ts"
      provides: "Hook to resolve tunnel URL from connection/project context"
      exports: ["useTunnelUrl"]
  key_links:
    - from: "packages/mesh-plugin-site-editor/client/components/preview-panel.tsx"
      to: "packages/mesh-plugin-site-editor/client/lib/use-tunnel-url.ts"
      via: "useTunnelUrl hook provides the iframe src"
      pattern: "useTunnelUrl"
---

<objective>
Create the preview panel component and tunnel URL discovery hook so users can see their running local dev server in the Mesh admin.

Purpose: Users start their dev server locally, run `deco link` to create a tunnel, and the Mesh admin shows their site in an iframe. This completes the local development loop: edit in admin, see changes in preview.

Output: A `PreviewPanel` component with responsive iframe and a `useTunnelUrl` hook that resolves the tunnel URL.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-plugin-shell/01-RESEARCH.md

# Reference files:
@packages/mesh-plugin-object-storage/components/   # UI component patterns
@packages/mesh-sdk/src/plugins/plugin-context-provider.tsx  # usePluginContext hook
@packages/cli/src/commands/dev/link.ts             # Tunnel URL pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preview panel and tunnel URL hook</name>
  <files>
    packages/mesh-plugin-site-editor/client/components/preview-panel.tsx
    packages/mesh-plugin-site-editor/client/lib/use-tunnel-url.ts
  </files>
  <action>
**Step 1: Create useTunnelUrl hook** at `packages/mesh-plugin-site-editor/client/lib/use-tunnel-url.ts`:

This hook resolves the tunnel URL for the current site project. The tunnel URL follows the pattern `https://{workspace}-{app}.deco.site` as created by `deco link`.

For Phase 1, the tunnel URL comes from the connection metadata or project plugin config. Check how other plugins read project-specific config:
- Look at `PROJECT_PLUGIN_CONFIG_GET` tool usage in existing plugins
- Or check if connection objects have a `metadata` field with custom properties

Implement as:
```typescript
import { usePluginContext } from "@decocms/mesh-sdk/plugins";
import type { SiteBinding } from "@decocms/bindings/site";

export function useTunnelUrl(): { url: string | null; isLoading: boolean } {
  const { connection } = usePluginContext<SiteBinding>();

  // The tunnel URL is stored in the connection's configuration/metadata
  // For Phase 1, extract it from the connection's URL or metadata
  // The connection URL itself might be the tunnel URL (the MCP server running
  // behind the tunnel), or it could be in connection metadata

  // Fallback: if no tunnel URL found, return null (preview shows placeholder)
  const url = connection?.url ?? null;

  return { url, isLoading: false };
}
```

NOTE: Check the actual shape of `connection` from `usePluginContext` to determine where the URL lives. The MCP connection URL is the tunnel endpoint. The preview URL might be different (the site URL, not the MCP URL). For Phase 1, make this configurable -- accept a `tunnelUrl` from connection metadata or plugin config, with a fallback to null showing "Start your dev server and run `deco link` to see a preview".

**Step 2: Create PreviewPanel component** at `packages/mesh-plugin-site-editor/client/components/preview-panel.tsx`:

```tsx
import { useTunnelUrl } from "../lib/use-tunnel-url";

interface PreviewPanelProps {
  path?: string;  // Page path to preview (e.g., "/", "/about")
}

export function PreviewPanel({ path = "/" }: PreviewPanelProps) {
  const { url, isLoading } = useTunnelUrl();

  if (isLoading) {
    return <div className="flex items-center justify-center h-full">Loading preview...</div>;
  }

  if (!url) {
    return (
      <div className="flex flex-col items-center justify-center h-full gap-4 text-muted-foreground">
        <p className="text-lg font-medium">No preview available</p>
        <p className="text-sm">Start your dev server and run <code className="px-1.5 py-0.5 bg-muted rounded text-xs">deco link</code> to see a live preview</p>
      </div>
    );
  }

  const previewUrl = path !== "/" ? `${url}${path}` : url;

  return (
    <div className="relative w-full h-full">
      <iframe
        src={previewUrl}
        className="w-full h-full border-0"
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
        title="Site preview"
      />
    </div>
  );
}

export default PreviewPanel;
```

Use Tailwind classes consistent with the Mesh admin UI. Check `@deco/ui` for any existing iframe or preview components to match styling.

IMPORTANT:
- The iframe `sandbox` attribute must include `allow-scripts allow-same-origin` for the site to function
- The preview panel should fill its parent container (100% width and height)
- No responsive toggle yet (that's Phase 3, EDIT-04)
- Export as both named and default export (default needed for lazy route loading)
  </action>
  <verify>
    - `packages/mesh-plugin-site-editor/client/components/preview-panel.tsx` exists and exports PreviewPanel
    - `packages/mesh-plugin-site-editor/client/lib/use-tunnel-url.ts` exists and exports useTunnelUrl
    - PreviewPanel renders an iframe when tunnel URL is available
    - PreviewPanel shows fallback message when no tunnel URL
  </verify>
  <done>PreviewPanel component renders a full-size iframe pointing to the tunnel URL. When no tunnel is configured, it shows instructions to run `deco link`. The useTunnelUrl hook resolves the URL from the plugin context's connection.</done>
</task>

</tasks>

<verification>
1. PreviewPanel renders iframe with correct sandbox attributes when tunnel URL exists
2. PreviewPanel shows helpful empty state when no tunnel URL is configured
3. useTunnelUrl hook integrates with usePluginContext to read connection data
4. Component follows Mesh UI patterns (Tailwind, @deco/ui)
</verification>

<success_criteria>
- PreviewPanel is a self-contained component that shows an iframe preview of the user's running dev server
- When no tunnel URL is available, user sees clear instructions on how to set it up
- Component accepts a `path` prop to preview specific pages
</success_criteria>

<output>
After completion, create `.planning/phases/01-plugin-shell/01-02-SUMMARY.md`
</output>
