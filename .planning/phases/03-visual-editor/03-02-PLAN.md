---
phase: 03-visual-editor
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - packages/mesh-plugin-site-editor/client/components/section-list-sidebar.tsx
  - packages/mesh-plugin-site-editor/client/components/block-picker.tsx
  - packages/mesh-plugin-site-editor/client/components/page-editor.tsx
  - packages/mesh-plugin-site-editor/client/components/page-composer.tsx
  - packages/mesh-plugin-site-editor/package.json

autonomous: true

must_haves:
  truths:
    - "Section list sidebar shows all blocks on the page with their names and selection state"
    - "Clicking a section in the sidebar selects it and opens its prop editor"
    - "Clicking a block in the iframe preview selects it and opens its prop editor"
    - "Changing a prop value in the prop editor updates the iframe preview within 1 second"
    - "User can add a new section from the block library to the page"
    - "User can remove a section from the page"
    - "Page editor route loads the visual composer instead of the metadata form"
    - "Drag-and-drop reordering works in the section list sidebar"
    - "Reordered sections persist to git via PUT_FILE"
  artifacts:
    - path: "packages/mesh-plugin-site-editor/client/components/section-list-sidebar.tsx"
      provides: "Sortable section list with select, delete, and DnD reordering"
      exports: ["SectionListSidebar"]
    - path: "packages/mesh-plugin-site-editor/client/components/block-picker.tsx"
      provides: "Modal dialog to select a block type from the library and add to page"
      exports: ["BlockPicker"]
    - path: "packages/mesh-plugin-site-editor/client/components/page-editor.tsx"
      provides: "Updated page editor route component using PageComposer"
      contains: "PageComposer"
  key_links:
    - from: "section-list-sidebar.tsx"
      to: "page-composer.tsx"
      via: "onSelect/onDelete/onReorder callbacks + blocks prop"
      pattern: "onSelect|onDelete|onReorder"
    - from: "page-composer.tsx"
      to: "preview-panel.tsx"
      via: "passes updated page with new block props for live preview"
      pattern: "deco:update-block|deco:page-config"
    - from: "block-picker.tsx"
      to: "block-api.ts"
      via: "lists available blocks via listBlocks"
      pattern: "listBlocks"
    - from: "section-list-sidebar.tsx"
      to: "@dnd-kit/sortable"
      via: "DndContext + SortableContext for drag reordering"
      pattern: "DndContext|SortableContext|useSortable"
---

<objective>
Build the section list sidebar with drag-and-drop reordering, block picker for adding sections, wire prop editing to live preview via postMessage, and replace the page editor route with the visual composer.

Purpose: This is the core editing experience -- users can see their page's sections, select them, edit props with live preview, add new sections, remove sections, and reorder via drag-and-drop. Changes persist to git.
Output: section-list-sidebar.tsx, block-picker.tsx, updated page-editor.tsx, updated page-composer.tsx, @dnd-kit dependencies
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-visual-editor/03-RESEARCH.md
@.planning/phases/03-visual-editor/03-01-SUMMARY.md

@packages/mesh-plugin-site-editor/client/components/page-composer.tsx
@packages/mesh-plugin-site-editor/client/components/preview-panel.tsx
@packages/mesh-plugin-site-editor/client/components/prop-editor.tsx
@packages/mesh-plugin-site-editor/client/lib/editor-protocol.ts
@packages/mesh-plugin-site-editor/client/lib/page-api.ts
@packages/mesh-plugin-site-editor/client/lib/block-api.ts
@packages/mesh-plugin-site-editor/client/lib/query-keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create section list sidebar with @dnd-kit sortable and block picker</name>
  <files>
    packages/mesh-plugin-site-editor/client/components/section-list-sidebar.tsx
    packages/mesh-plugin-site-editor/client/components/block-picker.tsx
    packages/mesh-plugin-site-editor/package.json
  </files>
  <action>
    **Add @dnd-kit dependencies** to `package.json`:
    ```json
    "@dnd-kit/core": "^6.1.0",
    "@dnd-kit/sortable": "^8.0.0",
    "@dnd-kit/utilities": "^3.2.2"
    ```
    Add these to the `dependencies` section (not peerDependencies -- these are direct deps of the plugin).

    **Create `section-list-sidebar.tsx`**:
    - Props: `{ blocks: BlockInstance[]; selectedBlockId: string | null; onSelect: (blockId: string) => void; onDelete: (blockId: string) => void; onReorder: (activeId: string, overId: string) => void; onAddClick: () => void }`
    - Import DnD: `DndContext, DragEndEvent, MouseSensor, TouchSensor, KeyboardSensor, useSensor, useSensors, closestCenter` from `@dnd-kit/core`; `SortableContext, useSortable, verticalListSortingStrategy, sortableKeyboardCoordinates` from `@dnd-kit/sortable`; `restrictToVerticalAxis` from `@dnd-kit/modifiers`; `CSS` from `@dnd-kit/utilities`
    - Create a `SortableSectionItem` subcomponent:
      - Props: `{ block: BlockInstance; isSelected: boolean; onSelect: () => void; onDelete: () => void }`
      - Uses `useSortable({ id: block.id })` to get `attributes, listeners, setNodeRef, transform, transition, isDragging`
      - Renders a row with: drag handle icon (GripVertical from lucide-react, spread `...listeners` and `...attributes` on it), block label (derive from blockType: replace "--" with "/", take last segment, e.g., "sections--Hero" -> "Hero"), selected state (highlight bg), delete button (Trash2 icon, small, on hover)
      - Apply `style={{ transform: CSS.Transform.toString(transform), transition }}` on the wrapper div
      - When `isDragging`, add `opacity-50` and `z-50` classes
      - Click on the row (excluding drag handle and delete button) calls `onSelect`
    - Main `SectionListSidebar` component:
      - Sets up sensors: `MouseSensor` (with activationConstraint distance: 8 to avoid accidental drags), `TouchSensor`, `KeyboardSensor` (with sortableKeyboardCoordinates)
      - Wraps list in `DndContext` with `sensors`, `collisionDetection={closestCenter}`, `modifiers={[restrictToVerticalAxis]}`, `onDragEnd` handler
      - `onDragEnd`: if `active.id !== over?.id`, call `onReorder(active.id as string, over.id as string)`
      - Wraps items in `SortableContext` with `items={blocks.map(b => b.id)}` and `strategy={verticalListSortingStrategy}`
      - Maps blocks to `SortableSectionItem` components
      - Footer: "Add Section" button (`Plus` icon from lucide-react) that calls `onAddClick`
      - Empty state: when blocks.length === 0, show "No sections yet" with "Add Section" button

    **Create `block-picker.tsx`**:
    - A dialog/modal for selecting a block type to add to the page
    - Props: `{ open: boolean; onClose: () => void; onSelect: (blockType: string, defaults: Record<string, unknown>) => void }`
    - Uses `usePluginContext` and `useQuery` with `blockKeys.all(connectionId)` to call `listBlocks(toolCaller)`
    - Shows a list of available block types grouped by category (reuse the groupByCategory pattern from sections-list.tsx)
    - Each item shows the block name and category
    - Clicking an item calls `onSelect(blockSummary.id, {})` and closes the dialog
    - Use `@deco/ui/components/dialog.tsx` (Dialog, DialogContent, DialogHeader, DialogTitle) for the modal -- check if this component exists in @deco/ui, if not use a simple overlay div with fixed positioning
    - Include a search/filter input at the top to filter blocks by name
  </action>
  <verify>
    Run type-check. Verify:
    - section-list-sidebar.tsx imports @dnd-kit and renders DndContext + SortableContext
    - block-picker.tsx lists blocks from block-api and fires onSelect with blockType
    - @dnd-kit packages are in package.json dependencies
  </verify>
  <done>
    Section list sidebar renders a drag-and-drop sortable list of BlockInstances with select, delete, and reorder. Block picker modal lets users browse and select from the block library to add sections.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire composer with section sidebar, prop editing, live preview, and save</name>
  <files>
    packages/mesh-plugin-site-editor/client/components/page-composer.tsx
    packages/mesh-plugin-site-editor/client/components/page-editor.tsx
  </files>
  <action>
    **Update `page-composer.tsx`** to replace the left panel placeholder with `SectionListSidebar` and wire everything together:

    - Import `SectionListSidebar` and `BlockPicker`
    - Add state: `showBlockPicker: boolean` (default false)
    - Add local `pageData` state (clone of fetched page) that tracks edits before saving. Initialize from the fetched page (use ref-based sync pattern from existing codebase -- `lastSyncedPageId` ref).
    - Left panel (260px): Render `SectionListSidebar` with:
      - `blocks={pageData.blocks}`
      - `selectedBlockId={selectedBlockId}`
      - `onSelect={(id) => setSelectedBlockId(id)}`
      - `onDelete={(id) => { remove block from pageData.blocks, if selected clear selection, trigger debounced save }}`
      - `onReorder={(activeId, overId) => { reorder blocks using arrayMove from @dnd-kit/sortable, update pageData, trigger debounced save }}`
      - `onAddClick={() => setShowBlockPicker(true)}`
    - Right panel (320px): When `selectedBlockId` is set:
      - Find the selected block in `pageData.blocks`
      - Fetch its block definition via `useQuery` with `blockKeys.detail(connectionId, block.blockType)` calling `getBlock(toolCaller, block.blockType)`
      - If block definition has a schema, render `PropEditor` with `schema={blockDef.schema}`, `formData={block.props}`, `onChange={(newProps) => { update block.props in pageData, send deco:update-block via postMessage for immediate preview, trigger debounced save }}`
      - If no schema found, show "No schema available for this block"
      - Show block name as header above the form
    - When no block is selected, right panel shows "Select a section to edit its properties"
    - Center panel: Pass `pageData` (not the fetched page) to `PreviewPanel` so live edits reflect immediately
    - Debounced save implementation:
      - Use a `useRef` for a timeout ID
      - On any edit (prop change, reorder, add, delete), clear existing timeout, set new 2-second timeout that calls `updatePage(toolCaller, pageId, { blocks: pageData.blocks })`
      - On save success, invalidate page query cache and show toast
      - On unmount, flush pending save immediately (useEffect cleanup)
    - `onBlockClicked` from PreviewPanel: set `selectedBlockId` (same as clicking in sidebar)
    - BlockPicker: render `<BlockPicker open={showBlockPicker} onClose={() => setShowBlockPicker(false)} onSelect={(blockType, defaults) => { create new BlockInstance with nanoid(8) id, add to end of pageData.blocks, close picker, select the new block, trigger debounced save }}>`

    **Rewrite `page-editor.tsx`** to use the visual composer:
    - Replace the entire metadata form with a simple wrapper that renders `<PageComposer pageId={pageId} />`
    - Keep the route params extraction (`siteEditorRouter.useParams({ from: "/pages/$pageId" })`)
    - Remove all the form state, save mutation, metadata display -- the composer handles everything now
    - The old title/path editing can be deferred or added as a settings popover in a future iteration. For now the composer focuses on visual block editing.
    - Import `PageComposer` from `./page-composer`
  </action>
  <verify>
    Run type-check. Verify:
    - page-composer.tsx imports SectionListSidebar, BlockPicker, PropEditor
    - page-composer.tsx handles onReorder with arrayMove from @dnd-kit/sortable
    - page-editor.tsx renders PageComposer instead of the metadata form
    - Debounced save calls updatePage with blocks array
  </verify>
  <done>
    Visual editor is fully wired: section list sidebar shows page blocks with DnD reorder, clicking a block (in sidebar or preview) opens prop editor, prop changes send deco:update-block for live preview, all edits debounce-save to git via PUT_FILE. Page editor route renders the visual composer.
  </done>
</task>

</tasks>

<verification>
1. Type-check passes with all new and modified files
2. SectionListSidebar renders blocks with DnD handles and fires onReorder on drag end
3. BlockPicker shows available blocks and fires onSelect on click
4. PropEditor onChange triggers both postMessage (live preview) and debounced save (git)
5. page-editor.tsx renders PageComposer (no more metadata form)
6. arrayMove correctly reorders blocks array on drag-and-drop
</verification>

<success_criteria>
- Section list sidebar shows block instances with drag handles, selection highlight, delete button
- @dnd-kit sortable reordering works with vertical constraint and keyboard accessibility
- Block picker modal lists blocks grouped by category with search filter
- PropEditor changes trigger deco:update-block postMessage immediately
- All edits (prop change, reorder, add, delete) debounce-save to git after 2 seconds
- page-editor.tsx route component renders PageComposer for the visual editing experience
</success_criteria>

<output>
After completion, create `.planning/phases/03-visual-editor/03-02-SUMMARY.md`
</output>
