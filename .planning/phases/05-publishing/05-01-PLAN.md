---
phase: 05-publishing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/bindings/src/well-known/site.ts
  - packages/mesh-plugin-site-editor/shared.ts
  - packages/mesh-plugin-site-editor/server/tools/branch-list.ts
  - packages/mesh-plugin-site-editor/server/tools/branch-create.ts
  - packages/mesh-plugin-site-editor/server/tools/branch-merge.ts
  - packages/mesh-plugin-site-editor/server/tools/branch-delete.ts
  - packages/mesh-plugin-site-editor/server/tools/index.ts
  - packages/mesh-plugin-site-editor/client/lib/branch-api.ts
  - packages/mesh-plugin-site-editor/client/lib/query-keys.ts
  - packages/mesh-plugin-site-editor/client/components/branch-switcher.tsx
  - packages/mesh-plugin-site-editor/client/components/publish-bar.tsx
  - packages/mesh-plugin-site-editor/client/components/plugin-header.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a list of branches for their site, with 'main' marked as the default/published branch"
    - "User can create a new draft branch from main with a descriptive name"
    - "User can switch between branches in the CMS UI and all page operations scope to the active branch"
    - "User can merge a draft branch to main (publish) and the draft branch is deleted after merge"
  artifacts:
    - path: "packages/bindings/src/well-known/site.ts"
      provides: "Extended SITE_BINDING with CREATE_BRANCH, MERGE_BRANCH, LIST_BRANCHES, DELETE_BRANCH tool binders"
      contains: "CREATE_BRANCH"
    - path: "packages/mesh-plugin-site-editor/client/lib/branch-api.ts"
      provides: "Client helpers for branch operations using SITE_BINDING tools"
      exports: ["listBranches", "createBranch", "mergeBranch", "deleteBranch"]
    - path: "packages/mesh-plugin-site-editor/client/components/branch-switcher.tsx"
      provides: "Branch dropdown and create-draft UI"
      min_lines: 40
    - path: "packages/mesh-plugin-site-editor/client/components/publish-bar.tsx"
      provides: "Draft status bar with publish button"
      min_lines: 30
  key_links:
    - from: "packages/mesh-plugin-site-editor/client/components/branch-switcher.tsx"
      to: "packages/mesh-plugin-site-editor/client/lib/branch-api.ts"
      via: "listBranches/createBranch calls"
      pattern: "listBranches|createBranch"
    - from: "packages/mesh-plugin-site-editor/client/components/publish-bar.tsx"
      to: "packages/mesh-plugin-site-editor/client/lib/branch-api.ts"
      via: "mergeBranch call"
      pattern: "mergeBranch"
    - from: "packages/mesh-plugin-site-editor/client/lib/branch-api.ts"
      to: "packages/bindings/src/well-known/site.ts"
      via: "toolCaller with branch tool names"
      pattern: "toolCaller.*CREATE_BRANCH|LIST_BRANCHES|MERGE_BRANCH"
---

<objective>
Extend SITE_BINDING with branch lifecycle tools and build the draft/publish workflow UI.

Purpose: Enable CMS users to create draft branches, switch between them, and merge (publish) drafts to main. This is the foundation of the draft/publish workflow (PUB-01).

Output: Extended SITE_BINDING with 4 new branch tools, server tools for AI access, client API helpers, branch switcher component, and publish bar component integrated into the plugin header.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-publishing/05-RESEARCH.md
@.planning/phases/01-plugin-shell/01-01-SUMMARY.md
@.planning/phases/01-plugin-shell/01-03-SUMMARY.md

# Key source files
@packages/bindings/src/well-known/site.ts
@packages/mesh-plugin-site-editor/shared.ts
@packages/mesh-plugin-site-editor/server/tools/index.ts
@packages/mesh-plugin-site-editor/client/lib/page-api.ts
@packages/mesh-plugin-site-editor/client/lib/query-keys.ts
@packages/mesh-plugin-site-editor/client/components/plugin-header.tsx
@packages/mesh-plugin-site-editor/client/lib/router.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SITE_BINDING with branch tools and create server tools + client API</name>
  <files>
    packages/bindings/src/well-known/site.ts
    packages/mesh-plugin-site-editor/shared.ts
    packages/mesh-plugin-site-editor/server/tools/branch-list.ts
    packages/mesh-plugin-site-editor/server/tools/branch-create.ts
    packages/mesh-plugin-site-editor/server/tools/branch-merge.ts
    packages/mesh-plugin-site-editor/server/tools/branch-delete.ts
    packages/mesh-plugin-site-editor/server/tools/index.ts
    packages/mesh-plugin-site-editor/client/lib/branch-api.ts
    packages/mesh-plugin-site-editor/client/lib/query-keys.ts
  </files>
  <action>
    **Extend SITE_BINDING** in `packages/bindings/src/well-known/site.ts`:

    Add 4 new tool binders to the SITE_BINDING array:

    1. `CREATE_BRANCH`:
       - Input: `{ name: z.string(), from: z.string().optional() }` (from defaults to "main")
       - Output: `{ success: z.boolean(), branch: z.string() }`

    2. `LIST_BRANCHES`:
       - Input: `{}` (empty object)
       - Output: `{ branches: z.array(z.object({ name: z.string(), isDefault: z.boolean() })) }`

    3. `MERGE_BRANCH`:
       - Input: `{ source: z.string(), target: z.string().optional(), deleteSource: z.boolean().optional() }` (target defaults to "main")
       - Output: `{ success: z.boolean(), message: z.string().optional() }`

    4. `DELETE_BRANCH`:
       - Input: `{ name: z.string() }`
       - Output: `{ success: z.boolean() }`

    Export all new types (CreateBranchInput, CreateBranchOutput, etc.) following the existing pattern.

    **IMPORTANT:** The SITE_BINDING array currently uses `as const satisfies Binder`. The new tools are OPTIONAL -- not all MCP implementations will support them. However, since the Binder type requires a fixed tuple, add them to the same array. The client-side branch-api will handle cases where tools aren't available (catch errors gracefully).

    **Add branch convention to shared.ts:**
    Add `DRAFT_BRANCH_PREFIX = "draft/"` constant. Draft branches follow naming convention: `draft/{descriptive-name}`.

    **Create 4 server tools** in `server/tools/`:
    Follow the exact same `ServerPluginToolDefinition` pattern as existing page tools (e.g., page-list.ts, page-create.ts). Each tool:
    - Takes `connectionId` in input schema
    - Creates MCP proxy client internally
    - Calls the corresponding SITE_BINDING tool via proxy
    - Tool names: `CMS_BRANCH_LIST`, `CMS_BRANCH_CREATE`, `CMS_BRANCH_MERGE`, `CMS_BRANCH_DELETE`

    Update `server/tools/index.ts` to include the 4 new branch tools in the exported array.

    **Create client/lib/branch-api.ts:**
    Follow page-api.ts pattern. Export 4 functions:
    - `listBranches(toolCaller)` -> calls `LIST_BRANCHES`, returns `{ branches: BranchInfo[] }`
    - `createBranch(toolCaller, name, from?)` -> calls `CREATE_BRANCH` with `draft/{name}` prefix
    - `mergeBranch(toolCaller, source, target?, deleteSource?)` -> calls `MERGE_BRANCH`
    - `deleteBranch(toolCaller, name)` -> calls `DELETE_BRANCH`
    All functions should wrap calls in try-catch and return `null` on error (graceful degradation if branch tools not supported by MCP).

    **Extend query-keys.ts:**
    Add `branches` key group:
    ```ts
    branches: {
      all: (connectionId: string) => ["site-editor", "branches", connectionId] as const,
    },
    ```
  </action>
  <verify>TypeScript compiles: run `npx tsc --noEmit` from packages/bindings and packages/mesh-plugin-site-editor. Check that SITE_BINDING now has 7 tool binders. Verify branch-api.ts exports all 4 functions.</verify>
  <done>SITE_BINDING extended with CREATE_BRANCH, LIST_BRANCHES, MERGE_BRANCH, DELETE_BRANCH. Server tools registered. Client API with 4 branch helper functions. Query keys include branches.</done>
</task>

<task type="auto">
  <name>Task 2: Build branch switcher and publish bar UI components</name>
  <files>
    packages/mesh-plugin-site-editor/client/components/branch-switcher.tsx
    packages/mesh-plugin-site-editor/client/components/publish-bar.tsx
    packages/mesh-plugin-site-editor/client/components/plugin-header.tsx
  </files>
  <action>
    **Create branch-switcher.tsx:**
    A dropdown component that shows the current branch and allows switching. Uses `usePluginContext` to get `toolCaller` and `connectionId`.

    Structure:
    - `useQuery` with `queryKeys.branches.all(connectionId)` calling `listBranches(toolCaller)`
    - Current branch stored in a signal/state, defaulting to "main"
    - Dropdown (use native `<select>` styled with Tailwind, or @deco/ui Select if available) listing all branches
    - "New Draft" button that opens a small inline form: text input for draft name + "Create" button
    - `useMutation` calling `createBranch(toolCaller, name)`, on success switches current branch to the new draft
    - When branch changes, the `toolCaller` needs to be branch-aware. Since SITE_BINDING tools don't currently take a `branch` param, store the active branch in a React context or URL search param. For now, expose `currentBranch` via a simple context: create a `BranchContext` (React.createContext) with `{ currentBranch, setCurrentBranch }` and wrap the plugin's root in it. Other components can consume this context to scope operations.

    Styling: Small, compact dropdown. Show a dot indicator -- green for "main" (published), yellow for "draft/*". Use Tailwind classes consistent with plugin-header.tsx.

    **Create publish-bar.tsx:**
    A horizontal bar shown ONLY when the current branch is NOT "main" (i.e., user is on a draft). Shows:
    - Draft name (e.g., "draft/homepage-redesign")
    - "Publish" button (primary/green) that calls `mergeBranch(toolCaller, currentBranch, "main", true)` -- merges to main and deletes the draft branch
    - "Discard" button (secondary/red outline) that calls `deleteBranch(toolCaller, currentBranch)` and switches back to "main"
    - Both buttons show loading state during mutation
    - On successful publish: invalidate branches query, switch to "main", show success state briefly
    - On discard: invalidate branches query, switch to "main"

    Styling: Fixed bar at the top of the editor area, subtle background (yellow-50 or amber-50), with left-aligned text and right-aligned action buttons.

    **Modify plugin-header.tsx:**
    Add the BranchSwitcher component to the plugin header, positioned next to the connection selector. Import and render `<BranchSwitcher />` inside the header layout. Also render `<PublishBar />` conditionally (when `currentBranch !== "main"`), placed below the header.

    **BranchContext pattern:**
    Create a `BranchProvider` component (can live in branch-switcher.tsx or a new branch-context.tsx) that wraps the plugin root. It provides `{ currentBranch, setCurrentBranch }`. The plugin's client/index.tsx should wrap its content in `<BranchProvider>`. Export `useBranch()` hook for consumers.

    **Important lint rules:**
    - No `useEffect` -- use ref-based sync or useSyncExternalStore patterns
    - No `useMemo`/`useCallback` -- React Compiler handles memoization
    - Use `cn()` from `@deco/ui/lib/utils.ts` for conditional classNames
  </action>
  <verify>TypeScript compiles. BranchSwitcher renders in the plugin header. PublishBar conditionally renders when not on main. BranchContext provides currentBranch to all child components.</verify>
  <done>Branch switcher dropdown integrated into plugin header. Publish bar shows on draft branches with Publish and Discard buttons. BranchContext provides active branch state to all CMS components.</done>
</task>

</tasks>

<verification>
1. SITE_BINDING in packages/bindings/src/well-known/site.ts has 7 tool binders (READ_FILE, PUT_FILE, LIST_FILES + CREATE_BRANCH, LIST_BRANCHES, MERGE_BRANCH, DELETE_BRANCH)
2. Server tools index exports all branch tools alongside existing page/block/loader tools
3. Client branch-api.ts exports listBranches, createBranch, mergeBranch, deleteBranch
4. BranchSwitcher component renders in plugin header with branch dropdown
5. PublishBar appears only on draft branches with Publish and Discard actions
6. BranchContext wraps plugin and provides currentBranch to all components
7. TypeScript compiles without errors across both packages
</verification>

<success_criteria>
- SITE_BINDING extended with 4 branch tools following exact same ToolBinder pattern
- Branch switcher UI allows creating drafts, switching branches, and publishing (merge to main)
- Draft/publish state is clearly communicated via publish bar
- All code follows existing conventions: no useEffect, Tailwind styling, React Query for data fetching
</success_criteria>

<output>
After completion, create `.planning/phases/05-publishing/05-01-SUMMARY.md`
</output>
