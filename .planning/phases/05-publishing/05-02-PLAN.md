---
phase: 05-publishing
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - packages/bindings/src/well-known/site.ts
  - packages/mesh-plugin-site-editor/server/tools/page-history.ts
  - packages/mesh-plugin-site-editor/server/tools/index.ts
  - packages/mesh-plugin-site-editor/client/lib/history-api.ts
  - packages/mesh-plugin-site-editor/client/lib/query-keys.ts
  - packages/mesh-plugin-site-editor/client/components/page-history.tsx
  - packages/mesh-plugin-site-editor/client/components/page-diff.tsx
  - packages/mesh-plugin-site-editor/client/components/page-editor.tsx
  - packages/mesh-plugin-site-editor/client/lib/router.ts
autonomous: true

must_haves:
  truths:
    - "User can view a chronological list of past versions for any page"
    - "User can see a diff between any two versions showing what changed"
    - "User can revert a page to any previous version with one click"
    - "Reverting creates a new version (not destructive -- old versions preserved)"
  artifacts:
    - path: "packages/bindings/src/well-known/site.ts"
      provides: "GET_FILE_HISTORY and READ_FILE_AT tool binders added to SITE_BINDING"
      contains: "GET_FILE_HISTORY"
    - path: "packages/mesh-plugin-site-editor/client/lib/history-api.ts"
      provides: "Client helpers for file history and revert"
      exports: ["getFileHistory", "readFileAt", "revertPage"]
    - path: "packages/mesh-plugin-site-editor/client/components/page-history.tsx"
      provides: "Version history timeline panel"
      min_lines: 60
    - path: "packages/mesh-plugin-site-editor/client/components/page-diff.tsx"
      provides: "Diff view comparing two page versions"
      min_lines: 40
  key_links:
    - from: "packages/mesh-plugin-site-editor/client/components/page-history.tsx"
      to: "packages/mesh-plugin-site-editor/client/lib/history-api.ts"
      via: "getFileHistory and revertPage calls"
      pattern: "getFileHistory|revertPage"
    - from: "packages/mesh-plugin-site-editor/client/lib/history-api.ts"
      to: "packages/bindings/src/well-known/site.ts"
      via: "toolCaller with history tool names"
      pattern: "toolCaller.*GET_FILE_HISTORY|READ_FILE_AT"
    - from: "packages/mesh-plugin-site-editor/client/components/page-editor.tsx"
      to: "packages/mesh-plugin-site-editor/client/components/page-history.tsx"
      via: "History tab/panel in page editor"
      pattern: "PageHistory"
---

<objective>
Add version history with diff view and one-click revert for CMS pages.

Purpose: Enable CMS users to see how a page changed over time, compare versions, and revert mistakes. This fulfills PUB-02.

Output: Extended SITE_BINDING with 2 history tools, history client API, page history timeline component, diff view component, and integration into the page editor.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-publishing/05-RESEARCH.md
@.planning/phases/05-publishing/05-01-SUMMARY.md

# Key source files
@packages/bindings/src/well-known/site.ts
@packages/mesh-plugin-site-editor/client/lib/page-api.ts
@packages/mesh-plugin-site-editor/client/lib/query-keys.ts
@packages/mesh-plugin-site-editor/client/components/page-editor.tsx
@packages/mesh-plugin-site-editor/client/lib/router.ts
@packages/mesh-plugin-site-editor/server/tools/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SITE_BINDING with history tools and create server tools + client API</name>
  <files>
    packages/bindings/src/well-known/site.ts
    packages/mesh-plugin-site-editor/server/tools/page-history.ts
    packages/mesh-plugin-site-editor/server/tools/index.ts
    packages/mesh-plugin-site-editor/client/lib/history-api.ts
    packages/mesh-plugin-site-editor/client/lib/query-keys.ts
  </files>
  <action>
    **Extend SITE_BINDING** in `packages/bindings/src/well-known/site.ts` (already modified in 05-01):

    Add 2 new tool binders:

    1. `GET_FILE_HISTORY`:
       - Input: `{ path: z.string(), branch: z.string().optional(), limit: z.number().optional() }`
       - Output: `{ entries: z.array(z.object({ commitHash: z.string(), timestamp: z.number(), author: z.string(), message: z.string() })) }`

    2. `READ_FILE_AT`:
       - Input: `{ path: z.string(), commitHash: z.string() }`
       - Output: `{ content: z.string() }`

    Export all new types following the existing pattern.

    **Create server/tools/page-history.ts:**
    Two server tools following existing ServerPluginToolDefinition pattern:
    - `CMS_FILE_HISTORY`: Takes `connectionId` + `path` + optional `branch`/`limit`. Proxies to GET_FILE_HISTORY.
    - `CMS_FILE_READ_AT`: Takes `connectionId` + `path` + `commitHash`. Proxies to READ_FILE_AT.

    Update `server/tools/index.ts` to include the 2 new history tools.

    **Create client/lib/history-api.ts:**
    Export 3 functions following page-api.ts pattern:

    ```ts
    interface HistoryEntry {
      commitHash: string;
      timestamp: number;
      author: string;
      message: string;
    }

    function getFileHistory(toolCaller, path, opts?: { branch?, limit? }): Promise<HistoryEntry[] | null>
    function readFileAt(toolCaller, path, commitHash): Promise<string | null>
    function revertPage(toolCaller, pageId, commitHash): Promise<boolean>
    ```

    `revertPage` implements the "revert as PUT_FILE" pattern from research:
    1. Call `readFileAt(toolCaller, `.deco/pages/${pageId}.json`, commitHash)` to get old content
    2. Parse the JSON, update `metadata.updatedAt` to now
    3. Call `toolCaller("PUT_FILE", { path, content: updatedJSON })` to write as new version
    4. Return true on success, false on failure

    All functions use try-catch with null/false return for graceful degradation.

    **Extend query-keys.ts:**
    Add `history` key group:
    ```ts
    history: {
      page: (connectionId: string, pageId: string) =>
        ["site-editor", "history", connectionId, pageId] as const,
    },
    ```
  </action>
  <verify>TypeScript compiles. SITE_BINDING now has 9 tool binders total. history-api.ts exports getFileHistory, readFileAt, revertPage. Server tools index includes CMS_FILE_HISTORY and CMS_FILE_READ_AT.</verify>
  <done>SITE_BINDING extended with GET_FILE_HISTORY and READ_FILE_AT. Server and client APIs for history operations created. Revert implemented as read-old-content + write-as-new-version.</done>
</task>

<task type="auto">
  <name>Task 2: Build page history panel with diff view and integrate into page editor</name>
  <files>
    packages/mesh-plugin-site-editor/client/components/page-history.tsx
    packages/mesh-plugin-site-editor/client/components/page-diff.tsx
    packages/mesh-plugin-site-editor/client/components/page-editor.tsx
    packages/mesh-plugin-site-editor/client/lib/router.ts
  </files>
  <action>
    **Create page-history.tsx:**
    A panel component showing version history for a page. Props: `{ pageId: string }`.

    Structure:
    - `useQuery` with `queryKeys.history.page(connectionId, pageId)` calling `getFileHistory(toolCaller, `.deco/pages/${pageId}.json`, { limit: 50 })`
    - Render a vertical timeline list. Each entry shows:
      - Relative timestamp (e.g., "2 hours ago", "Yesterday") -- use a simple `formatRelativeTime` helper, no library needed
      - Commit message (truncated to ~60 chars)
      - Author name
      - "View" button to expand diff
      - "Revert" button
    - When "View" is clicked, set `selectedEntry` state and show `<PageDiff>` below the entry
    - When "Revert" is clicked, call `revertPage(toolCaller, pageId, entry.commitHash)`, then invalidate both page detail and history queries
    - Show confirmation before revert: a small inline "Are you sure? Revert / Cancel" prompt (no modal needed -- just toggle inline UI)
    - Loading state while history loads (skeleton or spinner)
    - Empty state: "No version history available" text

    Styling: Vertical timeline with left border line, dots per entry. Use Tailwind: `border-l-2 border-gray-200` for the line, small circles for dots. Compact layout suitable for a right panel or drawer.

    **Create page-diff.tsx:**
    A component that shows the diff between two page versions. Props: `{ pageId: string, commitHash: string, currentContent: Page }`.

    Implementation:
    - `useQuery` calling `readFileAt(toolCaller, path, commitHash)` to get old version content
    - Parse both old and current as JSON Page objects
    - Compute a simple property-level diff:
      - Compare `title`, `path` fields (show old -> new if changed)
      - Compare `blocks` array: list added blocks, removed blocks, modified blocks (by block ID)
      - For modified blocks, show which props changed (key: oldValue -> newValue)
    - Render as a readable diff summary (not raw JSON diff). Use green/red background colors for added/removed, similar to GitHub diff style.
    - Do NOT use an external diff library. The page JSON is structured and shallow enough for custom comparison:
      ```ts
      function diffPages(oldPage: Page, newPage: Page): PageDiff {
        // Compare scalar fields
        // Compare blocks by ID (added, removed, modified)
        // For modified blocks, compare props shallowly
      }
      ```

    Styling: Compact diff cards with `bg-green-50`/`bg-red-50` for added/removed. Use monospace font for prop values.

    **Modify page-editor.tsx:**
    Add a "History" tab or toggle to the page editor. When active, show `<PageHistory pageId={pageId} />` in a side panel or below the editor.

    Implementation approach:
    - Add a "History" button/icon to the page editor toolbar (use Clock icon from @untitledui/icons or lucide-react)
    - When clicked, toggle a right-side panel (or replace the current right panel) showing PageHistory
    - The history panel should be collapsible/closable

    **Router update (if needed):**
    If the history view needs its own route (e.g., `/pages/$pageId/history`), add it to router.ts. Otherwise, keep it as an inline panel toggle within the existing page editor route.

    **Important lint rules:**
    - No `useEffect` -- use ref-based patterns for state derived from queries
    - No `useMemo`/`useCallback` -- React Compiler handles memoization
    - Use `cn()` for conditional classNames
    - Use `queryKeys.history.page()` for query keys (enforce-query-key-constants lint rule)
  </action>
  <verify>TypeScript compiles. PageHistory renders a timeline of versions. PageDiff shows readable differences between versions. Revert button writes old content as new version. History panel accessible from page editor.</verify>
  <done>Page history panel shows chronological version timeline with author and message. Diff view shows property-level changes between versions. One-click revert writes old content as new version. History integrated into page editor.</done>
</task>

</tasks>

<verification>
1. SITE_BINDING has GET_FILE_HISTORY and READ_FILE_AT tool binders (9 total)
2. Server tools include CMS_FILE_HISTORY and CMS_FILE_READ_AT
3. Client history-api exports getFileHistory, readFileAt, revertPage
4. PageHistory component renders version timeline for a given page
5. PageDiff shows human-readable comparison between two page versions
6. Revert creates a new version (non-destructive) by writing old content with updated timestamp
7. History panel accessible from page editor UI
8. TypeScript compiles without errors
</verification>

<success_criteria>
- User can see chronological version list for any page in the CMS
- User can view a diff showing what changed between versions (property-level, not raw JSON)
- One-click revert reads historical content and writes it as a new version (non-destructive)
- All code follows existing conventions: no useEffect, Tailwind styling, React Query caching
</success_criteria>

<output>
After completion, create `.planning/phases/05-publishing/05-02-SUMMARY.md`
</output>
