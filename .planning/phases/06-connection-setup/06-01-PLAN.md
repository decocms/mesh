---
phase: 06-connection-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mesh/src/tools/filesystem/validate-project.ts
  - apps/mesh/src/tools/filesystem/index.ts
  - packages/mesh-plugin-site-editor/client/components/plugin-empty-state.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking Connect validates the path contains tsconfig.json and package.json before creating a connection"
    - "Invalid paths show distinct inline error messages (path not found, missing tsconfig, missing package.json)"
    - "Successful connection shows a brief checkmark confirmation before transitioning to pages view"
    - "Empty state shows a friendly, guiding tone with folder icon and centered card layout"
  artifacts:
    - path: "apps/mesh/src/tools/filesystem/validate-project.ts"
      provides: "FILESYSTEM_VALIDATE_PROJECT SELF MCP tool"
      exports: ["FILESYSTEM_VALIDATE_PROJECT"]
    - path: "apps/mesh/src/tools/filesystem/index.ts"
      provides: "Re-export of new tool"
      contains: "FILESYSTEM_VALIDATE_PROJECT"
    - path: "packages/mesh-plugin-site-editor/client/components/plugin-empty-state.tsx"
      provides: "Enhanced empty state with validation and success confirmation"
      contains: "FILESYSTEM_VALIDATE_PROJECT"
  key_links:
    - from: "packages/mesh-plugin-site-editor/client/components/plugin-empty-state.tsx"
      to: "FILESYSTEM_VALIDATE_PROJECT"
      via: "selfClient.callTool"
      pattern: "callTool.*FILESYSTEM_VALIDATE_PROJECT"
---

<objective>
Create the FILESYSTEM_VALIDATE_PROJECT server tool and enhance the plugin empty state with path validation and success confirmation.

Purpose: Users connecting their project get clear feedback when the path is invalid, and a satisfying confirmation when connection succeeds — making the wizard feel polished and reliable.
Output: Working validation tool + enhanced empty state component with validation + success transition.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/mesh/src/tools/filesystem/pick-directory.ts
@apps/mesh/src/tools/filesystem/index.ts
@packages/mesh-plugin-site-editor/client/components/plugin-empty-state.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FILESYSTEM_VALIDATE_PROJECT tool</name>
  <files>
    apps/mesh/src/tools/filesystem/validate-project.ts
    apps/mesh/src/tools/filesystem/index.ts
  </files>
  <action>
Create `apps/mesh/src/tools/filesystem/validate-project.ts` following the exact pattern of `pick-directory.ts`:

1. Import `stat` from `node:fs/promises`, `join` from `node:path`, `z` from `zod`, `defineTool` from `../../core/define-tool`, `requireAuth` from `../../core/mesh-context`.

2. Define InputSchema: `z.object({ path: z.string().describe("Absolute path to project directory") })`.

3. Define OutputSchema: `z.object({ valid: z.boolean(), error: z.enum(["PATH_NOT_FOUND", "MISSING_TSCONFIG", "MISSING_PACKAGE_JSON"]).nullable() })`.

4. Create helper functions:
   - `fileExists(filePath: string): Promise<boolean>` — uses `stat()`, returns `s.isFile()`, catches to `false`
   - `dirExists(dirPath: string): Promise<boolean>` — uses `stat()`, returns `s.isDirectory()`, catches to `false`

5. Export `FILESYSTEM_VALIDATE_PROJECT` via `defineTool`:
   - name: `"FILESYSTEM_VALIDATE_PROJECT"`
   - description: `"Validate that a directory is a valid TypeScript project (has tsconfig.json and package.json)"`
   - annotations: `{ title: "Validate Project", readOnlyHint: true, destructiveHint: false, idempotentHint: true, openWorldHint: false }`
   - handler: `ctx.access.check()` + `requireAuth(ctx)`, then check dir exists, then check `tsconfig.json` exists, then check `package.json` exists. Return `{ valid: true, error: null }` or `{ valid: false, error: "ERROR_CODE" }`.

6. Add re-export to `apps/mesh/src/tools/filesystem/index.ts`:
   ```typescript
   export { FILESYSTEM_PICK_DIRECTORY } from "./pick-directory";
   export { FILESYSTEM_VALIDATE_PROJECT } from "./validate-project";
   ```

7. Verify the tool is registered in the server plugin tools array. Check `apps/mesh/src/api/` or wherever SELF MCP tools are aggregated — if filesystem tools are auto-discovered from index.ts, no change needed. If manually listed, add FILESYSTEM_VALIDATE_PROJECT to the list.
  </action>
  <verify>Run `bun run check` from the repo root to confirm TypeScript compiles without errors. Grep for `FILESYSTEM_VALIDATE_PROJECT` to confirm it's exported and discoverable.</verify>
  <done>FILESYSTEM_VALIDATE_PROJECT tool exists, compiles, is exported from filesystem/index.ts, and is registered in the SELF MCP tool set.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance empty state with validation and success confirmation</name>
  <files>
    packages/mesh-plugin-site-editor/client/components/plugin-empty-state.tsx
  </files>
  <action>
Modify `plugin-empty-state.tsx` to add validation before connection creation and a success confirmation phase:

1. Add a `phase` state: `const [phase, setPhase] = useState<"form" | "connecting" | "success">("form")`. Remove the separate `isConnecting` state — use `phase` instead.

2. Modify `handleConnect`:
   a. Before creating the STDIO connection, call validation:
      ```typescript
      const validation = await selfClient.callTool({
        name: "FILESYSTEM_VALIDATE_PROJECT",
        arguments: { path: trimmed },
      });
      const result = validation.structuredContent as { valid: boolean; error: string | null };
      if (!result.valid) {
        const errorMap: Record<string, string> = {
          PATH_NOT_FOUND: "Path not found",
          MISSING_TSCONFIG: "Not a TypeScript project (missing tsconfig.json)",
          MISSING_PACKAGE_JSON: "Not a Node project (missing package.json)",
        };
        setError(errorMap[result.error ?? ""] ?? "Invalid project");
        return; // Stop — don't create connection
      }
      ```
   b. After successful connection creation + config binding (steps 1-2 in existing code):
      - Set `setPhase("success")`
      - Wait 1500ms via `await new Promise(resolve => setTimeout(resolve, 1500))`
      - Then invalidate queries (existing step 3)
   c. In the catch block, set `setPhase("form")` to return to form state
   d. Remove the `finally` block that sets `setIsConnecting(false)` — phase transitions handle this

3. Update `busy` to use phase: `const busy = phase === "connecting" || isBrowsing`

4. Add success confirmation UI: When `phase === "success"`, render a centered checkmark with "Connected!" text instead of the form:
   ```tsx
   if (phase === "success") {
     return (
       <div className="flex flex-col items-center justify-center h-full p-8">
         <div className="flex flex-col items-center gap-3">
           <div className="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
             <svg className="w-6 h-6 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
               <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
             </svg>
           </div>
           <p className="text-sm font-medium">Connected!</p>
         </div>
       </div>
     );
   }
   ```

5. Keep the existing form UI structure (browse area, divider, manual input, connect button). Update button text to show phase: `phase === "connecting" ? "Connecting..." : "Connect"`.

6. Ensure error text appears below the input field (not centered — move `text-center` to just `text-left` or remove it so it aligns under the input). Per user decision: "Errors appear inline under the path input field (red text)."

7. Run `bun run fmt` after changes.
  </action>
  <verify>Run `bun run check` to confirm TypeScript compiles. Visually inspect the component renders: form state shows wizard, connecting state shows spinner, success state shows checkmark. Error state shows red text under input.</verify>
  <done>Empty state validates path before connection, shows distinct error messages for each failure type, and displays a brief success confirmation before transitioning to pages view.</done>
</task>

</tasks>

<verification>
1. `bun run check` passes (TypeScript compiles)
2. `bun run fmt` has been run
3. FILESYSTEM_VALIDATE_PROJECT tool exists and is exported
4. Empty state calls validation before creating connection
5. Three distinct error messages map to the three validation failures
6. Success phase shows checkmark for ~1.5s before query invalidation triggers transition
</verification>

<success_criteria>
- FILESYSTEM_VALIDATE_PROJECT tool validates directory existence, tsconfig.json, and package.json
- Plugin empty state calls validation on Connect click, shows inline errors on failure
- Successful connection shows brief "Connected!" confirmation before transitioning to pages view
- All sidebar routes (Pages, Sections, Loaders) show the same wizard when not connected (existing behavior preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/06-connection-setup/06-01-SUMMARY.md`
</output>
