---
phase: 09.1-multi-site-support
plan: 02
subsystem: ui
tags: [react, command-palette, cmdk, site-switching, plugin-layout]

requires:
  - phase: 09.1-multi-site-support
    plan: 01
    provides: "Site store, dirty state API, unsaved changes dialog"
provides:
  - "Site switcher top bar component with status indicators"
  - "Command palette for site selection with search"
  - "PluginLayout connectionIdOverride for multi-site support"
  - "Clean remount on site switch via key prop"
  - "Flush/cancel save API for unsaved changes flow"
affects: [10-validation]

tech-stack:
  added: []
  patterns: ["useConnectionId hook on ClientPlugin for per-plugin connection override", "PluginLayoutWithOverride wrapper for hook-based connection resolution"]

key-files:
  created:
    - packages/mesh-plugin-site-editor/client/components/site-switcher.tsx
    - packages/mesh-plugin-site-editor/client/components/site-palette.tsx
  modified:
    - packages/mesh-plugin-site-editor/client/components/plugin-header.tsx
    - packages/mesh-plugin-site-editor/client/index.tsx
    - packages/mesh-plugin-site-editor/client/lib/dirty-state.ts
    - packages/mesh-plugin-site-editor/client/components/page-composer.tsx
    - apps/mesh/src/web/layouts/plugin-layout.tsx
    - apps/mesh/src/web/layouts/dynamic-plugin-layout.tsx
    - packages/bindings/src/core/plugins.ts

key-decisions:
  - "useConnectionId hook added to ClientPlugin interface for non-invasive multi-site support"
  - "PluginLayoutWithOverride wrapper component ensures hooks are called at component top level"
  - "registerFlush/flushPendingSave pattern for save-and-switch flow via ref indirection"
  - "key={connectionId} on PluginContextProvider forces clean remount on site switch"

patterns-established:
  - "useConnectionId hook: plugins provide a hook that returns connection ID override"
  - "PluginLayoutWithOverride: wrapper component for calling plugin hooks before PluginLayout"
  - "registerFlush pattern: page-composer registers async save callback, dirty-state calls it on flush"

requirements-completed: [MULTI-SITE-SWITCHER, MULTI-SITE-LAYOUT, MULTI-SITE-LIFECYCLE]

duration: 6min
completed: 2026-02-17
---

# Phase 09.1 Plan 02: Site Switcher UI & Layout Integration Summary

**Command palette site switcher with status indicators, unsaved changes flow, and PluginLayout connectionId override with clean remount semantics**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-17T00:12:23Z
- **Completed:** 2026-02-17T00:18:04Z
- **Tasks:** 2
- **Files modified:** 9

## Accomplishments
- Site switcher top bar shows active site with colored status dot (green/red/gray) and plus button
- Command palette (cmdk-based) provides searchable site list with status, project path, and add-site action
- PluginLayout accepts connectionIdOverride for multi-site, with key-based remount for clean state on switch
- Unsaved changes flow: hasPendingSave check, save-and-switch via registerFlush, discard-and-switch via cancelPendingSave
- Add-site dialog renders PluginEmptyState inline for connecting new project folders

## Task Commits

Each task was committed atomically:

1. **Task 1: Create site switcher and command palette components** - `6f6911242` (feat)
2. **Task 2: Integrate multi-site into plugin header and layout** - `a96b13a14` (feat)

## Files Created/Modified
- `packages/mesh-plugin-site-editor/client/components/site-switcher.tsx` - Top bar component with status dot, display name, plus button
- `packages/mesh-plugin-site-editor/client/components/site-palette.tsx` - Command palette with searchable site list and add-site action
- `packages/mesh-plugin-site-editor/client/components/plugin-header.tsx` - Replaced ConnectionSelector with SiteSwitcher, added site store sync and unsaved changes flow
- `packages/mesh-plugin-site-editor/client/index.tsx` - Added useConnectionId hook returning activeSiteId from site store
- `packages/mesh-plugin-site-editor/client/lib/dirty-state.ts` - Added registerFlush, flushPendingSave, cancelPendingSave APIs
- `packages/mesh-plugin-site-editor/client/components/page-composer.tsx` - Registers flush callback via handleSaveRef pattern
- `apps/mesh/src/web/layouts/plugin-layout.tsx` - Added connectionIdOverride prop and key={connectionId} on PluginContextProvider
- `apps/mesh/src/web/layouts/dynamic-plugin-layout.tsx` - Added PluginLayoutWithOverride wrapper for hook-based override
- `packages/bindings/src/core/plugins.ts` - Added useConnectionId optional hook to ClientPlugin interface

## Decisions Made
- Added `useConnectionId` hook to `ClientPlugin` interface rather than reading from site store directly in PluginLayout (keeps PluginLayout generic, only site editor uses multi-site)
- Created `PluginLayoutWithOverride` wrapper component because hooks must be called at component top level (cannot call conditionally in DynamicPluginLayout)
- Used `registerFlush` + ref indirection pattern for save-and-switch: page-composer registers its save function via a ref, dirty-state calls it when flush is requested
- `key={connectionId}` on PluginContextProvider forces full unmount/remount of all children on site switch, giving a clean slate per locked decision

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Phase 09.1 (Multi-Site Support) is complete
- Site store, dirty state, switcher UI, and layout integration all wired together
- Ready for Phase 10 validation against anjo.chat

---
*Phase: 09.1-multi-site-support*
*Completed: 2026-02-17*
