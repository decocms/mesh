---
phase: 10-documentation-validation
plan: 02
type: execute
wave: 2
depends_on:
  - "10-01"
files_modified:
  - packages/mesh-plugin-site-editor/client/lib/use-iframe-bridge.ts
  - packages/mesh-plugin-site-editor/client/lib/inject-bridge.ts
  - packages/mesh-plugin-site-editor/server/scanner/discover.ts
  - packages/vite-plugin-deco/index.ts
  - packages/mesh-plugin-site-editor/client/pages/page-composer.tsx
autonomous: false
requirements:
  - VAL-01

must_haves:
  truths:
    - "anjo.chat can be connected to Mesh site-editor from the plugin empty state"
    - "Sections list page shows anjo.chat's scanned blocks (Hero, Features, Footer, etc.)"
    - "Loaders list page displays empty state when no loaders exist in the connected site"
    - "Live preview renders anjo.chat's home page inside the iframe"
    - "Clicking a section in the preview selects it and opens the property editor"
    - "Editing a prop value in the property editor updates the live preview within 1 second"
  artifacts:
    - path: ".planning/phases/10-documentation-validation/10-02-VALIDATION.md"
      provides: "Pass/fail results for all validation items"
      contains: "PASS\\|FAIL"
  key_links:
    - from: "packages/vite-plugin-deco/index.ts"
      to: "/Users/guilherme/Projects/anjo.chat/vite.config.ts"
      via: "decoEditorBridgePlugin injected in anjo.chat's Vite config"
      pattern: "decoEditorBridgePlugin"
    - from: "packages/mesh-plugin-site-editor/client/lib/use-iframe-bridge.ts"
      to: "packages/mesh-plugin-site-editor/client/pages/page-composer.tsx"
      via: "useIframeBridge provides postMessage channel for click-to-select and prop editing"
      pattern: "useIframeBridge|deco:block-clicked|deco:update-block"
---

<objective>
Validate the deco CMS site editor end-to-end using anjo.chat as the reference implementation. Follow a scripted verification checklist, recording pass/fail for each item. Fix any bugs discovered in the CMS/plugin code (NOT in anjo.chat's application code).

Purpose: VAL-01 requires anjo.chat to demonstrate full end-to-end functionality: connection setup, sections listing, loader listing, live preview, click-to-select, and prop editing. This is the final validation gate for v1.1.
Output: Validation results file + all bug fixes applied.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-documentation-validation/10-RESEARCH.md

# Key source files for debugging:
@packages/mesh-plugin-site-editor/client/lib/editor-protocol.ts
@packages/mesh-plugin-site-editor/client/lib/use-iframe-bridge.ts
@packages/mesh-plugin-site-editor/client/lib/inject-bridge.ts
@packages/mesh-plugin-site-editor/client/pages/page-composer.tsx
@packages/vite-plugin-deco/index.ts
@/Users/guilherme/Projects/anjo.chat/vite.config.ts
@/Users/guilherme/Projects/anjo.chat/app/routes/home.tsx
@/Users/guilherme/Projects/anjo.chat/.deco/blocks/sections--Hero.json
@/Users/guilherme/Projects/anjo.chat/.deco/pages/page_home.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run validation checklist and fix bugs</name>
  <files>
packages/mesh-plugin-site-editor/client/lib/use-iframe-bridge.ts
packages/mesh-plugin-site-editor/client/lib/inject-bridge.ts
packages/mesh-plugin-site-editor/server/scanner/discover.ts
packages/vite-plugin-deco/index.ts
packages/mesh-plugin-site-editor/client/pages/page-composer.tsx
  </files>
  <action>
**Prerequisites (verify before starting):**
1. Start the mesh dev environment: `cd /Users/guilherme/Projects/mesh && bun run dev` (in background)
2. Start anjo.chat dev server: `cd /Users/guilherme/Projects/anjo.chat && bun run dev` (in background)
3. Wait for both servers to be ready (mesh on port 4000, anjo.chat on its configured port)

**Validation Checklist — execute each item in order:**

**V-01: Connection Setup**
- Action: Open Mesh admin (http://localhost:4000), navigate to site-editor plugin. If no connection exists, use the inline wizard to connect to anjo.chat's project path (`/Users/guilherme/Projects/anjo.chat`).
- Expected: Connection wizard validates the path (finds tsconfig.json, package.json), creates a STDIO MCP connection.
- Pass: Plugin transitions from empty state to connected state showing the site editor UI.

**V-02: Tunnel / Preview URL Detection**
- Action: With anjo.chat dev server running, observe the tunnel detection polling in the plugin.
- Expected: Plugin detects the tunnel URL (or local dev server URL) and stores it in connection metadata.
- Pass: Preview panel shows a URL in the toolbar (not blank).

**V-03: Block Scanning**
- Action: Navigate to Sections page. If no blocks are listed, trigger a re-scan using the scan button.
- Expected: Scanner discovers anjo.chat's components and writes `.deco/blocks/` JSON files.
- Pass: Sections list shows block entries (Hero, Features, Footer, etc.) with category grouping.

**V-04: Sections List View**
- Action: On the Sections page, verify the block listing display.
- Expected: Each block shows name, category, and component path. Collapsible category groups work.
- Pass: At least 3 blocks visible, categories can be expanded/collapsed.

**V-05: Section Detail View**
- Action: Click on a block (e.g., Hero) to navigate to its detail view.
- Expected: Two-column layout with SchemaTree on the left and PropEditor on the right.
- Pass: Schema tree shows the block's JSON Schema properties. PropEditor renders form fields matching the schema.

**V-06: Loaders List (Empty State)**
- Action: Navigate to Loaders page.
- Expected: Since anjo.chat has no loaders, the page shows an appropriate empty state.
- Pass: Loaders page renders without errors, shows empty state message (not a crash).

**V-07: Live Preview Rendering**
- Action: Navigate to a page (e.g., home page) in the page editor/composer view.
- Expected: The iframe preview panel loads anjo.chat's home page via the tunnel/preview URL.
- Pass: anjo.chat's home page renders visually inside the iframe preview panel.

**V-08: Click-to-Select**
- Action: In edit mode, click on a section (e.g., Hero) in the iframe preview.
- Expected: The editor receives `deco:block-clicked` message, selects the block, opens the property editor in the right sidebar.
- Pass: Clicking a section highlights it and shows its props in the editor panel.

**V-09: Prop Editing with Live Update**
- Action: With a section selected, change a text prop value in the property editor (e.g., change Hero's badge text).
- Expected: The editor sends `deco:update-block` to the iframe. The preview updates within 1 second showing the new value.
- Pass: Edited text appears in the live preview without page reload.

**V-10: Save to Git**
- Action: After editing a prop, save the page (via the save button or auto-save).
- Expected: The page JSON in `.deco/pages/` is updated via MCP PUT_FILE with the new prop values.
- Pass: Reading `.deco/pages/page_home.json` from disk shows the updated prop value.

**Bug Fix Protocol:**
- If any item FAILS: diagnose the root cause, determine if it's a CMS/plugin bug (fix it) or an anjo.chat-specific issue (document as known issue, work around it).
- Bug fixes go in `packages/mesh-plugin-site-editor/`, `packages/vite-plugin-deco/`, or `apps/mesh/src/` — NOT in anjo.chat's code per user decision.
- After fixing a bug, re-test the failed item and all subsequent items.
- The `files_modified` list above covers the most likely fix locations; additional plugin files may be modified if bugs are found elsewhere in the plugin.

Record results in `.planning/phases/10-documentation-validation/10-02-VALIDATION.md` with this format:
```
# Phase 10 Validation Results

Date: YYYY-MM-DD

| ID | Description | Result | Notes |
|----|-------------|--------|-------|
| V-01 | Connection Setup | PASS/FAIL | ... |
| V-02 | Tunnel Detection | PASS/FAIL | ... |
...

## Bugs Fixed

### BUG-01: [description]
- File: [path]
- Symptom: [what failed]
- Root cause: [why]
- Fix: [what was changed]

## Known Issues

(Issues not fixable in the CMS plugin scope)
```
  </action>
  <verify>
- All 10 validation items have PASS/FAIL recorded in VALIDATION.md
- No FAIL items remain (all bugs fixed and re-tested)
- Bug fixes are in plugin/mesh code, not anjo.chat code
- `bun run check` passes (TypeScript)
- `bun run fmt` has been run
  </verify>
  <done>
All 10 validation items pass. anjo.chat demonstrates working connection setup, block scanning, sections listing, empty loaders state, live preview, click-to-select, prop editing, and save-to-git through the deco CMS site editor.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end demo</name>
  <what-built>
Full end-to-end validation of the deco CMS site editor using anjo.chat as the reference implementation. All 10 validation items have been tested and any bugs discovered have been fixed.
  </what-built>
  <how-to-verify>
1. Open Mesh admin at http://localhost:4000 (start with `bun run dev` in mesh repo if not running)
2. Start anjo.chat dev server (`bun run dev` in anjo.chat repo)
3. Navigate to the site-editor plugin — verify anjo.chat is connected
4. Go to Sections page — verify blocks are listed (Hero, Features, etc.)
5. Go to Loaders page — verify empty state renders cleanly
6. Open a page in the composer — verify iframe preview shows anjo.chat
7. Click a section in the preview — verify it gets selected and props appear in sidebar
8. Edit a text prop — verify the preview updates live
9. Save — verify the change persists in `.deco/pages/page_home.json`
  </how-to-verify>
  <resume-signal>Type "approved" to confirm the demo works, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. `.planning/phases/10-documentation-validation/10-02-VALIDATION.md` exists with all 10 items
2. All validation items show PASS
3. Any bug fixes pass `bun run check` and `bun run fmt`
4. Human has verified the end-to-end demo works
</verification>

<success_criteria>
anjo.chat works end-to-end as a reference implementation: connection setup, sections listing showing actual scanned blocks, loaders page showing empty state, live preview rendering, click-to-select selecting sections, and prop editing updating the preview — all verified by both automated checklist and human confirmation.
</success_criteria>

<output>
After completion, create `.planning/phases/10-documentation-validation/10-02-SUMMARY.md`
</output>
