---
phase: 14-history-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mesh-plugin-site-editor/client/lib/history-api.ts
  - packages/mesh-plugin-site-editor/client/components/page-history.tsx
  - packages/mesh-plugin-site-editor/client/components/page-composer.tsx
autonomous: true
requirements:
  - HIST-01
  - HIST-02
must_haves:
  truths:
    - GIT_LOG is called with path=`.deco/pages/${pageId}.json` and limit=50 to fetch history
    - Each commit entry shows: short hash (7 chars of entry.hash), relative date, commit message
    - Clicking a commit entry calls GIT_SHOW with { path, commitHash } then parses the JSON response and sends `deco:page-config` to the iframe
    - A "Viewing: [shortHash]" indicator is shown when a historical version is being previewed
    - A "Back to current" button clears the historical preview and restores live editing (re-sends current localPage to iframe)
    - The History button (Clock icon) in page-composer.tsx toggles showHistory state — this already exists and must not be removed
    - PageHistory receives `send` and `localPage` props from PageComposer so it can push page-config messages to the iframe
    - Loading state shown while GIT_LOG is fetching
    - Empty state shown when no commits found ("No history yet")
    - Error state shown if GIT_LOG fails
  artifacts:
    - path: "packages/mesh-plugin-site-editor/client/lib/history-api.ts"
      provides: "getGitLog(toolCaller, path, limit?) → commits[] and getGitShow(toolCaller, path, commitHash) → string"
    - path: "packages/mesh-plugin-site-editor/client/components/page-history.tsx"
      provides: "PageHistory component — shows commit list, handles click-to-preview via iframe bridge send"
    - path: "packages/mesh-plugin-site-editor/client/components/page-composer.tsx"
      provides: "Passes send and localPage to PageHistory when showHistory is true"
---

# Plan 14-01: History Panel UI — GIT_LOG + Commit List + Iframe Preview

## Context

The `page-history.tsx` component already exists but uses the old `GET_FILE_HISTORY`/`READ_FILE_AT` pattern and shows a "View diff" inline diff — it does NOT preview historical versions in the iframe. This plan replaces that implementation with the new `GIT_LOG`/`GIT_SHOW` pattern and adds commit-click iframe preview.

The `page-composer.tsx` already has a working History toggle button (Clock icon, `showHistory` state) that renders `<PageHistory pageId={pageId} />`. The only missing piece is passing `send` and `localPage` down so PageHistory can communicate with the iframe.

## Task 1: Add GIT_LOG and GIT_SHOW helpers to history-api.ts

**File:** `packages/mesh-plugin-site-editor/client/lib/history-api.ts`

The current file exposes `getFileHistory` (uses `GET_FILE_HISTORY`) and `readFileAt` (uses `READ_FILE_AT`). Add two new exported functions alongside the existing ones — do not remove the existing functions as they may be used elsewhere.

### Add `getGitLog`

```typescript
/**
 * Get commit history for a file using GIT_LOG.
 * Returns null if the tool is not supported by the MCP.
 */
export async function getGitLog(
  toolCaller: ToolCaller,
  path: string,
  limit = 50,
): Promise<GitLogEntry[] | null> {
  try {
    const result = await toolCaller("GIT_LOG", { path, limit });
    return result.commits;
  } catch {
    return null;
  }
}
```

Where `GitLogEntry` is:

```typescript
export interface GitLogEntry {
  hash: string;     // full commit hash from GIT_LOG output schema
  author: string;
  date: string;     // ISO date string
  message: string;
}
```

### Add `getGitShow`

```typescript
/**
 * Read file content at a specific commit using GIT_SHOW.
 * Returns null if the tool is not supported.
 */
export async function getGitShow(
  toolCaller: ToolCaller,
  path: string,
  commitHash: string,
): Promise<string | null> {
  try {
    const result = await toolCaller("GIT_SHOW", { path, commitHash });
    return result.content;
  } catch {
    return null;
  }
}
```

Both functions follow the same graceful-degrade pattern as all other helpers in this file (try/catch returning null on error).

## Task 2: Rewrite page-history.tsx to use GIT_LOG + iframe preview

**File:** `packages/mesh-plugin-site-editor/client/components/page-history.tsx`

Replace the current implementation entirely. The new component:

### Props interface

```typescript
interface PageHistoryProps {
  pageId: string;
  send: (msg: EditorMessage) => void;   // iframe bridge send function
  localPage: Page | null;               // current live page (for "Back to current")
}
```

Import `EditorMessage` from `../lib/editor-protocol` and `Page` from `../lib/page-api`.

### State

```typescript
const [previewingHash, setPreviewingHash] = useState<string | null>(null);
const [loadingHash, setLoadingHash] = useState<string | null>(null);
```

- `previewingHash`: the commit hash currently being previewed (null = live mode)
- `loadingHash`: which commit is currently being fetched (for per-row loading indicator)

### Data fetching

Use `useQuery` with `queryKeys.history.page(connectionId, pageId)` as the key, calling `getGitLog(toolCaller, `.deco/pages/${pageId}.json`, 50)`.

### Commit list rendering

Render a vertical timeline (same styling as the existing component — `border-l-2`, dot per entry). For each commit entry:

**Entry data displayed:**
- Short hash: `entry.hash.slice(0, 7)` — shown in monospace
- Relative date: compute from `new Date(entry.date).getTime()` using a `formatRelativeTime` helper (copy the existing one from the current file)
- Commit message: truncated to 72 chars with ellipsis if longer

**Entry appearance:**
- If `previewingHash === entry.hash`: highlight the row with `bg-primary/5 border-l-primary` or similar subtle active indicator
- Otherwise: normal styling

**Buttons per entry:**
- "Preview" button: on click, calls `handlePreviewCommit(entry)` — fetches GIT_SHOW and sends to iframe
  - Shows a small spinner (inline `Loading01` size 12) when `loadingHash === entry.hash`
  - Disabled when `loadingHash !== null` (prevents concurrent fetches)

### `handlePreviewCommit` function

```typescript
const handlePreviewCommit = async (entry: GitLogEntry) => {
  if (loadingHash !== null) return;
  setLoadingHash(entry.hash);
  try {
    const path = `.deco/pages/${pageId}.json`;
    const content = await getGitShow(toolCaller, path, entry.hash);
    if (!content) {
      toast.error("Could not load historical version");
      return;
    }
    const historicalPage = JSON.parse(content) as Page;
    send({ type: "deco:page-config", page: historicalPage });
    setPreviewingHash(entry.hash);
  } catch {
    toast.error("Could not load historical version");
  } finally {
    setLoadingHash(null);
  }
};
```

Import `toast` from `sonner`.

### "Viewing historical version" banner

When `previewingHash !== null`, show a sticky banner at the top of the panel:

```
[Viewing: abc1234]   [Back to current]
```

- "Back to current" button calls `handleBackToCurrent()`:
  ```typescript
  const handleBackToCurrent = () => {
    if (localPage) {
      send({ type: "deco:page-config", page: localPage });
    }
    setPreviewingHash(null);
  };
  ```
- Banner styling: amber/warning colors (`bg-amber-50 border border-amber-200 rounded`) to signal read-only preview mode

### Loading/error/empty states

Same pattern as other components:
- Loading: `Loading01` spinner with "Loading history..."
- Error: AlertCircle with "Failed to load history"
- Empty (null or `[]`): "No history yet for this page"

### Imports to add

```typescript
import { getGitLog, getGitShow, type GitLogEntry } from "../lib/history-api";
import type { EditorMessage } from "../lib/editor-protocol";
import type { Page } from "../lib/page-api";
```

Remove imports for `readFileAt`, `revertPage`, `HistoryEntry`, `PageDiff` — those are no longer needed in this component.

Do NOT import `PageDiff` — the new History panel has no "View diff" feature (per context: diff view is out of scope for Phase 14).

## Task 3: Update page-composer.tsx to pass send and localPage to PageHistory

**File:** `packages/mesh-plugin-site-editor/client/components/page-composer.tsx`

Find the section in the right panel that renders `<PageHistory pageId={pageId} />` (currently line 621). Update it to pass the required props:

```tsx
{showHistory ? (
  <PageHistory
    pageId={pageId}
    send={send}
    localPage={localPage}
  />
) : selectedBlock && blockDef?.schema ? (
  // ... existing block editor
```

No other changes to `page-composer.tsx` are needed. The `send` function is already destructured from `useIframeBridge` and `localPage` is already built from `page` and `blocks`.

## What is NOT in this plan

- Revert action — that is Plan 14-02
- Diff view between commits — out of scope per context
- The existing `getFileHistory`/`readFileAt`/`revertPage` functions in `history-api.ts` — leave them unchanged (they are still exported and may be used)
- The existing `PageDiff` component — leave it unchanged
- The `queryKeys.history.diff` key — it is already defined and can remain unused for now
