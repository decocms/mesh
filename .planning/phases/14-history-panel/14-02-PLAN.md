---
phase: 14-history-panel
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - packages/mesh-plugin-site-editor/client/lib/history-api.ts
  - packages/mesh-plugin-site-editor/client/components/page-history.tsx
  - packages/mesh-plugin-site-editor/client/components/page-composer.tsx
autonomous: true
requirements:
  - HIST-03
must_haves:
  truths:
    - "Revert here" button appears on each commit row in the history list
    - Clicking "Revert here" shows an inline confirmation ("Are you sure? Revert / Cancel") before proceeding
    - Confirmed revert: calls PUT_FILE with the historical JSON content (from GIT_SHOW) and then calls GIT_COMMIT with message `revert: restore page to ${shortHash}`
    - After a successful revert: toast.success("Page reverted to [shortHash]"), history panel is closed (setShowHistory(false)), page query is invalidated so the section list refreshes with the new committed state
    - After revert the diff badges on the section list sidebar clear (handled automatically by page query invalidation)
    - If GIT_COMMIT is not available (returns error), the revert still succeeds via PUT_FILE alone and shows a warning toast
    - "Revert here" button is disabled while any revert is in progress (only one revert at a time)
  artifacts:
    - path: "packages/mesh-plugin-site-editor/client/lib/history-api.ts"
      provides: "revertToCommit(toolCaller, pageId, commitHash, shortHash) → boolean"
    - path: "packages/mesh-plugin-site-editor/client/components/page-history.tsx"
      provides: "Revert button with confirmation flow on each commit row"
    - path: "packages/mesh-plugin-site-editor/client/components/page-composer.tsx"
      provides: "onRevert callback passed to PageHistory that closes history panel and invalidates queries"
---

# Plan 14-02: Revert Here — PUT_FILE + GIT_COMMIT + Section List Refresh

## Context

This plan extends the `PageHistory` component (built in Plan 14-01) with a "Revert here" action per commit. The revert flow is:

1. User clicks "Revert here" on a commit → inline confirmation appears
2. User confirms → `revertToCommit` is called
3. `revertToCommit` reads the historical JSON (already cached from GIT_SHOW if the user clicked Preview, otherwise fetches it) → writes it to disk via PUT_FILE → calls GIT_COMMIT with a revert message
4. On success: history panel closes, page query invalidates, section list shows the reverted state as current

The existing `revertPage` function in `history-api.ts` does PUT_FILE only. This plan adds a new `revertToCommit` function that also calls GIT_COMMIT.

## Task 1: Add revertToCommit to history-api.ts

**File:** `packages/mesh-plugin-site-editor/client/lib/history-api.ts`

Add a new exported function. Do NOT remove or change the existing `revertPage` function.

```typescript
/**
 * Revert a page to a previous commit.
 *
 * Steps:
 * 1. Read content at commitHash via GIT_SHOW
 * 2. Write it to the page file via PUT_FILE
 * 3. Commit the change via GIT_COMMIT with a revert message
 *
 * Returns true on success, false on failure.
 * If GIT_COMMIT is not supported, still returns true after PUT_FILE succeeds.
 */
export async function revertToCommit(
  toolCaller: ToolCaller,
  pageId: string,
  commitHash: string,
): Promise<{ success: boolean; committedWithGit: boolean }> {
  const path = `${PAGES_PREFIX}${pageId}.json`;
  const shortHash = commitHash.slice(0, 7);

  // 1. Read historical content
  let content: string | null = null;
  try {
    const result = await toolCaller("GIT_SHOW", { path, commitHash });
    content = result.content;
  } catch {
    return { success: false, committedWithGit: false };
  }

  if (!content) {
    return { success: false, committedWithGit: false };
  }

  // 2. Write to disk via PUT_FILE
  try {
    await toolCaller("PUT_FILE", { path, content });
  } catch {
    return { success: false, committedWithGit: false };
  }

  // 3. GIT_COMMIT (optional — graceful degrade if not supported)
  let committedWithGit = false;
  try {
    await toolCaller("GIT_COMMIT", {
      message: `revert: restore page to ${shortHash}`,
    });
    committedWithGit = true;
  } catch {
    // GIT_COMMIT not supported — PUT_FILE write still succeeded
  }

  return { success: true, committedWithGit };
}
```

The `PAGES_PREFIX` constant is already defined in `history-api.ts` as `".deco/pages/"`.

## Task 2: Add Revert button + confirmation flow to page-history.tsx

**File:** `packages/mesh-plugin-site-editor/client/components/page-history.tsx`

### New props

Add `onRevert: () => void` to the `PageHistoryProps` interface. This callback is called after a successful revert and is used by the composer to close the panel and invalidate queries.

```typescript
interface PageHistoryProps {
  pageId: string;
  send: (msg: EditorMessage) => void;
  localPage: Page | null;
  onRevert: () => void;  // NEW
}
```

### New state

```typescript
const [confirmingRevertHash, setConfirmingRevertHash] = useState<string | null>(null);
const [revertingHash, setRevertingHash] = useState<string | null>(null);
```

- `confirmingRevertHash`: which commit has the confirmation UI open
- `revertingHash`: which commit is actively being reverted (shows spinner, disables all revert buttons)

### Import

Add `revertToCommit` to the import from `../lib/history-api`.

### `handleRevert` function

```typescript
const handleRevert = async (entry: GitLogEntry) => {
  if (revertingHash !== null) return;
  const shortHash = entry.hash.slice(0, 7);
  setRevertingHash(entry.hash);
  setConfirmingRevertHash(null);
  try {
    const { success, committedWithGit } = await revertToCommit(
      toolCaller,
      pageId,
      entry.hash,
    );
    if (success) {
      if (committedWithGit) {
        toast.success(`Page reverted to ${shortHash}`);
      } else {
        toast.success(`Page reverted to ${shortHash} (file saved, no git commit)`);
      }
      onRevert();
    } else {
      toast.error("Failed to revert page");
    }
  } catch {
    toast.error("Failed to revert page");
  } finally {
    setRevertingHash(null);
  }
};
```

### Per-commit row: Revert button UI

Inside the commit row render (after the "Preview" button), add the revert button. Two states:

**State A — normal (not confirming this hash):**
```tsx
<button
  type="button"
  onClick={() => setConfirmingRevertHash(entry.hash)}
  disabled={revertingHash !== null}
  className="flex items-center gap-0.5 text-xs text-orange-600 hover:text-orange-800 transition-colors disabled:opacity-40 disabled:cursor-not-allowed"
>
  <RefreshCcw01 size={10} />
  Revert here
</button>
```

**State B — confirming this hash:**
```tsx
<span className="flex items-center gap-1 text-xs">
  <span className="text-muted-foreground">Are you sure?</span>
  <button
    type="button"
    onClick={() => handleRevert(entry)}
    disabled={revertingHash !== null}
    className="text-orange-600 hover:text-orange-800 font-medium transition-colors disabled:opacity-40"
  >
    {revertingHash === entry.hash ? (
      <Loading01 size={12} className="animate-spin inline" />
    ) : (
      "Revert"
    )}
  </button>
  <button
    type="button"
    onClick={() => setConfirmingRevertHash(null)}
    className="text-muted-foreground hover:text-foreground transition-colors"
  >
    Cancel
  </button>
</span>
```

Import `RefreshCcw01` from `@untitledui/icons` if not already imported.

When `revertingHash === entry.hash` (i.e., this specific commit is being reverted), show a spinner instead of the "Revert" label in the confirmation button. The "Cancel" button is omitted when actively reverting (hide when `revertingHash !== null && revertingHash === entry.hash`).

### Confirmation cleanup

If the user clicks "Preview" on a different commit while confirmation is open, close the confirmation:
In `handlePreviewCommit`, add `setConfirmingRevertHash(null)` at the start.

## Task 3: Update page-composer.tsx to pass onRevert to PageHistory

**File:** `packages/mesh-plugin-site-editor/client/components/page-composer.tsx`

### Define the onRevert callback

Add an `onRevert` handler inside `PageComposer`. This must:
1. Call `setShowHistory(false)` to close the history panel
2. Invalidate `queryKeys.pages.detail(connectionId, pageId, activeLocale)` so the section list fetches the reverted content
3. Invalidate `queryKeys.history.page(connectionId, pageId)` so the history list refreshes with the new revert commit at the top

```typescript
const handleRevert = () => {
  setShowHistory(false);
  queryClient.invalidateQueries({
    queryKey: queryKeys.pages.detail(connectionId, pageId, activeLocale),
  });
  queryClient.invalidateQueries({
    queryKey: queryKeys.history.page(connectionId, pageId),
  });
};
```

### Wire it into the JSX

Update the `<PageHistory>` call to include `onRevert`:

```tsx
{showHistory ? (
  <PageHistory
    pageId={pageId}
    send={send}
    localPage={localPage}
    onRevert={handleRevert}
  />
) : selectedBlock && blockDef?.schema ? (
  // ... existing block editor
```

## Behavioral notes

- Section list refresh: closing the history panel causes the right panel to revert to "Select a section to edit" state. The `queryKeys.pages.detail` invalidation triggers a fresh fetch of the page data, which updates the `blocks` in undo/redo state via the `syncKey` mechanism already in `page-composer.tsx` (lines 138-144). This means the section list sidebar automatically shows the reverted page's sections.
- Diff badges: the `page-composer.tsx` undo/redo reset via `resetBlocks(page.blocks)` when the page query returns new data ensures the working state matches the committed state, so no phantom diff badges.
- If the user had a commit previewed in the iframe when they click "Revert here", the revert flow writes the same content that was being previewed. After `onRevert()` closes the panel and the page query re-fetches, `useIframeBridge` detects the page change via `pageJson !== prevPageJsonRef.current` and sends `deco:page-config` with the new (reverted) page automatically.

## What is NOT in this plan

- Any change to the `revertPage` function (old pattern) — leave it as-is
- Any server-side tools — revert is pure client-side using existing SITE_BINDING tools
- Undoing a revert — this is a git commit; standard git undo flows apply
