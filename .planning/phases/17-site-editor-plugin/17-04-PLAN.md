---
phase: 17-site-editor-plugin
plan: 04
type: execute
wave: 3
depends_on:
  - 17-02
  - 17-03
files_modified:
  - packages/mesh-plugin-site-editor/client/lib/router.ts
  - packages/mesh-plugin-site-editor/client/components/pages-list.tsx
  - packages/mesh-plugin-site-editor/client/components/page-modal.tsx
  - packages/mesh-plugin-site-editor/client/index.tsx
autonomous: true
requirements:
  - EDT-01
  - EDT-02
  - EDT-05

must_haves:
  truths:
    - "User can see a list of all pages from .deco/pages/*.json (non-deleted)"
    - "User can create a new page via a modal dialog with title and path fields"
    - "User can rename a page via a modal dialog"
    - "User can delete a page with a confirmation dialog"
    - "Clicking a page opens /pages/{pageId} route (placeholder for composer in plan 17-05)"
    - "The plugin router is registered in client/index.tsx setup()"
  artifacts:
    - path: "packages/mesh-plugin-site-editor/client/lib/router.ts"
      provides: "createPluginRouter with pages list route and page composer route"
      exports: ["siteEditorRouter"]
    - path: "packages/mesh-plugin-site-editor/client/components/pages-list.tsx"
      provides: "Page list UI with create/rename/delete actions"
    - path: "packages/mesh-plugin-site-editor/client/components/page-modal.tsx"
      provides: "Reusable modal for create/rename operations"
  key_links:
    - from: "packages/mesh-plugin-site-editor/client/components/pages-list.tsx"
      to: "packages/mesh-plugin-site-editor/client/lib/page-api.ts"
      via: "useQuery({ queryFn: () => listPages(genericCaller) })"
      pattern: "listPages"
    - from: "packages/mesh-plugin-site-editor/client/index.tsx"
      to: "packages/mesh-plugin-site-editor/client/lib/router.ts"
      via: "siteEditorRouter.createRoutes(context)"
      pattern: "siteEditorRouter"
---

<objective>
Build the pages list UI and routing layer — the entry point to the site editor. Users can browse, create, rename, and delete pages. Clicking a page navigates to the composer route (built in plan 17-05).

Purpose: EDT-01 (view/navigate pages) and EDT-02 (create/rename/delete) with modal dialogs per user decision. EDT-05 (open composer) is satisfied by the routing — the composer view is a placeholder here.
Output: router.ts, pages-list.tsx, page-modal.tsx, updated client/index.tsx
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/17-site-editor-plugin/17-CONTEXT.md
@.planning/phases/17-site-editor-plugin/17-RESEARCH.md
@.planning/phases/17-site-editor-plugin/17-02-SUMMARY.md
@.planning/phases/17-site-editor-plugin/17-03-SUMMARY.md

Reference router pattern: @packages/mesh-plugin-object-storage/lib/router.ts
Plugin bindings: @packages/bindings/src/core/plugins.ts
Plugin context hook: @packages/mesh-sdk/src/plugins/plugin-context-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plugin router and register it in client/index.tsx</name>
  <files>
    packages/mesh-plugin-site-editor/client/lib/router.ts
    packages/mesh-plugin-site-editor/client/index.tsx
  </files>
  <action>
**client/lib/router.ts** — two routes: pages list (/) and page composer (/$pageId):

```typescript
import { createPluginRouter } from "@decocms/bindings/plugins";
import * as z from "zod";

const composerSearchSchema = z.object({
  // No persistent search state needed for composer yet
});

export const siteEditorRouter = createPluginRouter((ctx) => {
  const { createRoute, lazyRouteComponent } = ctx.routing;

  // Pages list route — plugin root
  const pagesListRoute = createRoute({
    getParentRoute: () => ctx.parentRoute,
    path: "/",
    component: lazyRouteComponent(
      () => import("../components/pages-list"),
    ),
  });

  // Page composer route
  const pageComposerRoute = createRoute({
    getParentRoute: () => ctx.parentRoute,
    path: "/pages/$pageId",
    component: lazyRouteComponent(
      () => import("../components/page-composer"),
    ),
  });

  return [pagesListRoute, pageComposerRoute];
});
```

Note: `../components/page-composer` will be created in plan 17-05. Since it's lazy-loaded, the route definition compiles even before page-composer.tsx exists — but TypeScript may complain about the missing file. To fix: create a minimal stub page-composer.tsx now:

**packages/mesh-plugin-site-editor/client/components/page-composer.tsx** (stub):
```typescript
export default function PageComposer() {
  return <div className="p-4">Composer (coming in plan 17-05)</div>;
}
```

**Update client/index.tsx** — add router import and update setup():
Replace the `context.registerPluginRoutes([])` call with:
```typescript
import { siteEditorRouter } from "./lib/router";
// ...
setup: (context: PluginSetupContext) => {
  context.registerRootSidebarItem({
    icon: <LayoutAlt03 size={16} />,
    label: "Site Editor",
  });
  const routes = siteEditorRouter.createRoutes(context);
  context.registerPluginRoutes(routes);
},
```
  </action>
  <verify>
    bun run --cwd=packages/mesh-plugin-site-editor check 2>&1 | grep error | head -5
    Expect: 0 TypeScript errors
  </verify>
  <done>router.ts exports siteEditorRouter with / and /pages/$pageId routes; client/index.tsx setup() registers routes; stub page-composer.tsx exists</done>
</task>

<task type="auto">
  <name>Task 2: Create pages-list.tsx and page-modal.tsx</name>
  <files>
    packages/mesh-plugin-site-editor/client/components/pages-list.tsx
    packages/mesh-plugin-site-editor/client/components/page-modal.tsx
  </files>
  <action>
**page-modal.tsx** — reusable modal for create/rename:

```typescript
import { useState } from "react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@deco/ui/components/dialog";
import { Button } from "@deco/ui/components/button";
import { Input } from "@deco/ui/components/input";
import { Label } from "@deco/ui/components/label";

interface PageModalProps {
  open: boolean;
  onClose: () => void;
  onSubmit: (title: string, path: string) => Promise<void>;
  mode: "create" | "rename";
  initialTitle?: string;
  initialPath?: string;
}

export function PageModal({ open, onClose, onSubmit, mode, initialTitle = "", initialPath = "" }: PageModalProps) {
  const [title, setTitle] = useState(initialTitle);
  const [path, setPath] = useState(initialPath);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!title.trim()) return;
    setLoading(true);
    try {
      await onSubmit(title, path || `/${title.toLowerCase().replace(/\s+/g, "-")}`);
      onClose();
    } finally {
      setLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={(v) => !v && onClose()}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{mode === "create" ? "Create page" : "Rename page"}</DialogTitle>
        </DialogHeader>
        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
          <div className="flex flex-col gap-1.5">
            <Label htmlFor="page-title">Title</Label>
            <Input
              id="page-title"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="My Page"
              autoFocus
            />
          </div>
          {mode === "create" && (
            <div className="flex flex-col gap-1.5">
              <Label htmlFor="page-path">Path</Label>
              <Input
                id="page-path"
                value={path}
                onChange={(e) => setPath(e.target.value)}
                placeholder="/my-page"
              />
            </div>
          )}
          <DialogFooter>
            <Button type="button" variant="outline" onClick={onClose} disabled={loading}>
              Cancel
            </Button>
            <Button type="submit" disabled={loading || !title.trim()}>
              {loading ? "Saving..." : mode === "create" ? "Create" : "Rename"}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
```

**pages-list.tsx** — main page list component:

```typescript
import { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { usePluginContext } from "@decocms/mesh-sdk/plugins";
import type { DecoBlocksBinding } from "@decocms/bindings";
import { useNavigate, useParams } from "@tanstack/react-router";
import { Button } from "@deco/ui/components/button";
import { Plus, MoreHorizontal, Pencil, Trash2 } from "lucide-react";
import { toast } from "sonner";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@deco/ui/components/dropdown-menu";
import { listPages, createPage, updatePage, deletePage, type Page, type GenericToolCaller } from "../lib/page-api";
import { PageModal } from "./page-modal";
import { QUERY_KEYS } from "../lib/query-keys";

export default function PagesList() {
  const { toolCaller, connection } = usePluginContext<DecoBlocksBinding>();
  const genericCaller = toolCaller as unknown as GenericToolCaller;
  const { org, project } = useParams({ strict: false }) as { org: string; project: string };
  const navigate = useNavigate();
  const queryClient = useQueryClient();

  const [createOpen, setCreateOpen] = useState(false);
  const [renameTarget, setRenameTarget] = useState<Page | null>(null);

  const projectId = connection?.id ?? "";

  const { data: pages = [], isLoading } = useQuery({
    queryKey: QUERY_KEYS.pages(projectId),
    queryFn: () => listPages(genericCaller),
    enabled: !!toolCaller,
  });

  const createMutation = useMutation({
    mutationFn: ({ title, path }: { title: string; path: string }) =>
      createPage(genericCaller, title, path),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: QUERY_KEYS.pages(projectId) });
      toast.success("Page created");
    },
    onError: () => toast.error("Failed to create page"),
  });

  const renameMutation = useMutation({
    mutationFn: ({ page, title }: { page: Page; title: string }) =>
      updatePage(genericCaller, { ...page, title }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: QUERY_KEYS.pages(projectId) });
      toast.success("Page renamed");
    },
    onError: () => toast.error("Failed to rename page"),
  });

  const deleteMutation = useMutation({
    mutationFn: ({ page }: { page: Page }) => deletePage(genericCaller, page.id, page.title),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: QUERY_KEYS.pages(projectId) });
      toast.success("Page deleted");
    },
    onError: () => toast.error("Failed to delete page"),
  });

  const handlePageClick = (page: Page) => {
    navigate({
      to: "/$org/$project/$pluginId/pages/$pageId",
      params: { org, project, pluginId: "site-editor", pageId: page.id },
    });
  };

  const handleDelete = (page: Page) => {
    if (!confirm(`Delete "${page.title}"? This cannot be undone.`)) return;
    deleteMutation.mutate({ page });
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-full">
        <span className="text-sm text-muted-foreground">Loading pages...</span>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-full">
      <div className="flex items-center justify-between px-4 py-3 border-b">
        <h2 className="text-sm font-medium">Pages</h2>
        <Button size="sm" onClick={() => setCreateOpen(true)}>
          <Plus size={14} className="mr-1" />
          New page
        </Button>
      </div>

      <div className="flex-1 overflow-y-auto">
        {pages.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-full gap-2 text-sm text-muted-foreground">
            <p>No pages yet.</p>
            <Button variant="outline" size="sm" onClick={() => setCreateOpen(true)}>
              Create your first page
            </Button>
          </div>
        ) : (
          <ul className="divide-y">
            {pages.map((page) => (
              <li key={page.id} className="flex items-center px-4 py-2.5 hover:bg-accent/40 group">
                <button
                  className="flex-1 text-left text-sm"
                  onClick={() => handlePageClick(page)}
                >
                  <div className="font-medium">{page.title}</div>
                  <div className="text-xs text-muted-foreground">{page.path}</div>
                </button>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="opacity-0 group-hover:opacity-100 h-7 w-7"
                    >
                      <MoreHorizontal size={14} />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem onClick={() => setRenameTarget(page)}>
                      <Pencil size={14} className="mr-2" />
                      Rename
                    </DropdownMenuItem>
                    <DropdownMenuItem
                      className="text-destructive"
                      onClick={() => handleDelete(page)}
                    >
                      <Trash2 size={14} className="mr-2" />
                      Delete
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              </li>
            ))}
          </ul>
        )}
      </div>

      <PageModal
        open={createOpen}
        onClose={() => setCreateOpen(false)}
        onSubmit={async (title, path) => {
          await createMutation.mutateAsync({ title, path });
        }}
        mode="create"
      />

      {renameTarget && (
        <PageModal
          open={true}
          onClose={() => setRenameTarget(null)}
          onSubmit={async (title) => {
            await renameMutation.mutateAsync({ page: renameTarget, title });
          }}
          mode="rename"
          initialTitle={renameTarget.title}
        />
      )}
    </div>
  );
}
```

Key implementation notes:
- Use `usePluginContext<DecoBlocksBinding>()` to get typed toolCaller and connection
- Cast toolCaller to GenericToolCaller for filesystem tool calls (pitfall 3 from research)
- Use TanStack Query for data fetching (useQuery + useMutation)
- QUERY_KEYS constants (not inline strings) per project lint rule
- No useEffect, no useMemo, no useCallback (banned by project rules)
- Check that all @deco/ui component import paths exist — if Dialog/DropdownMenu don't exist in @deco/ui, use a simple alert() for delete confirmation and a simpler modal pattern
- Import lucide-react icons (MoreHorizontal, Pencil, Trash2) since @untitledui/icons may not have these
- Run `bun run --cwd=packages/mesh-plugin-site-editor check` and fix any import path errors
  </action>
  <verify>
    bun run --cwd=packages/mesh-plugin-site-editor check 2>&1 | grep error | head -10
    Expect: 0 TypeScript errors
  </verify>
  <done>pages-list.tsx and page-modal.tsx compile cleanly; pages list queries .deco/pages/ via listPages; create/rename use modal dialogs; delete uses window.confirm; router registers both routes; client/index.tsx setup() registers routes</done>
</task>

</tasks>

<verification>
1. Run `bun run --cwd=packages/mesh-plugin-site-editor check` — expect 0 errors
2. Confirm router.ts: two routes (/ and /pages/$pageId)
3. Confirm client/index.tsx: setup() calls siteEditorRouter.createRoutes(context) and registerPluginRoutes()
4. Confirm pages-list.tsx: uses QUERY_KEYS constants (not string literals)
5. Confirm pages-list.tsx: no useEffect, no useMemo, no useCallback imports
6. Run `bun run fmt` — formatting passes
</verification>

<success_criteria>
- Plugin router is registered and routes compile
- Pages list fetches and renders .deco/pages/*.json entries
- Create modal has title + path fields; rename modal has title field
- Delete uses window.confirm (acceptable for phase 17)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/17-site-editor-plugin/17-04-SUMMARY.md`
</output>
