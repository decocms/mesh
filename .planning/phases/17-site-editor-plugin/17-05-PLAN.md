---
phase: 17-site-editor-plugin
plan: 05
type: execute
wave: 4
depends_on:
  - 17-04
files_modified:
  - packages/mesh-plugin-site-editor/client/components/page-composer.tsx
  - packages/mesh-plugin-site-editor/client/components/section-list-sidebar.tsx
  - packages/mesh-plugin-site-editor/client/components/prop-editor.tsx
  - packages/mesh-plugin-site-editor/client/components/preview-panel.tsx
  - packages/mesh-plugin-site-editor/client/components/block-picker.tsx
  - packages/mesh-plugin-site-editor/client/components/loader-drawer.tsx
  - packages/mesh-plugin-site-editor/client/components/rjsf/widgets.tsx
  - packages/mesh-plugin-site-editor/client/components/rjsf/templates.tsx
autonomous: true
requirements:
  - EDT-03
  - EDT-04
  - EDT-05
  - EDT-06
  - EDT-07
  - EDT-08
  - EDT-09
  - EDT-10

must_haves:
  truths:
    - "User opens page composer by clicking a page in the pages list"
    - "Left panel shows the list of sections on the page; clicking a section slides to the prop editor"
    - "Prop editor shows RJSF form generated from the section's propsSchema"
    - "Sections can be reordered via drag-and-drop (dnd-kit) ‚Äî drag handle visible"
    - "A section can be removed from the list with a delete button"
    - "Block picker modal opens when 'Add section' is clicked; selecting a block adds it to the page"
    - "Loader binding drawer opens from a 'Bind loader' button in the prop editor"
    - "Right panel is an iframe pointed at connection.metadata.previewUrl; graceful empty state if previewUrl absent"
    - "Edit/interact mode toggle controls pointer events on the iframe"
    - "Undo (Cmd+Z) and redo (Cmd+Shift+Z) work via keyboard shortcuts using useSyncExternalStore"
    - "All prop changes and section additions/removals/reorderings are pushed to the undo history"
  artifacts:
    - path: "packages/mesh-plugin-site-editor/client/components/page-composer.tsx"
      provides: "Two-panel composer: left (section list OR prop editor) + right (preview iframe)"
      min_lines: 80
    - path: "packages/mesh-plugin-site-editor/client/components/section-list-sidebar.tsx"
      provides: "DnD sortable sections list with add/remove/select"
    - path: "packages/mesh-plugin-site-editor/client/components/prop-editor.tsx"
      provides: "RJSF form for editing section props, back button, loader binding trigger"
    - path: "packages/mesh-plugin-site-editor/client/components/preview-panel.tsx"
      provides: "iframe with edit/interact toggle, graceful empty state for missing previewUrl"
    - path: "packages/mesh-plugin-site-editor/client/components/block-picker.tsx"
      provides: "Modal showing available blocks from BLOCKS_LIST for adding to page"
    - path: "packages/mesh-plugin-site-editor/client/components/loader-drawer.tsx"
      provides: "Drawer/panel for selecting a loader and binding it to a prop"
    - path: "packages/mesh-plugin-site-editor/client/components/rjsf/widgets.tsx"
      provides: "Custom RJSF widgets: text, number, checkbox, url, select"
    - path: "packages/mesh-plugin-site-editor/client/components/rjsf/templates.tsx"
      provides: "Custom RJSF field label and description templates"
  key_links:
    - from: "packages/mesh-plugin-site-editor/client/components/page-composer.tsx"
      to: "packages/mesh-plugin-site-editor/client/lib/use-undo-redo.ts"
      via: "useUndoRedo<BlockInstance[]>(page.blocks)"
      pattern: "useUndoRedo"
    - from: "packages/mesh-plugin-site-editor/client/components/page-composer.tsx"
      to: "packages/mesh-plugin-site-editor/client/lib/use-iframe-bridge.ts"
      via: "useIframeBridge({ page, selectedBlockId, mode })"
      pattern: "useIframeBridge"
    - from: "packages/mesh-plugin-site-editor/client/components/section-list-sidebar.tsx"
      to: "@dnd-kit/sortable"
      via: "DndContext + SortableContext + useSortable"
      pattern: "SortableContext"
    - from: "packages/mesh-plugin-site-editor/client/components/prop-editor.tsx"
      to: "@rjsf/core"
      via: "Form schema={block.propsSchema} validator={validator}"
      pattern: "@rjsf/core"
---

<objective>
Build the visual composer: two-panel layout with a sliding left panel (section list ‚Üî prop editor) and an iframe preview panel on the right. Includes DnD reordering, RJSF forms, block picker modal, loader binding drawer, and undo/redo with keyboard shortcuts.

Purpose: EDT-03 through EDT-10 ‚Äî the core composing experience. This is the primary value of Phase 17.
Output: page-composer.tsx, section-list-sidebar.tsx, prop-editor.tsx, preview-panel.tsx, block-picker.tsx, loader-drawer.tsx, rjsf/widgets.tsx, rjsf/templates.tsx
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/17-site-editor-plugin/17-CONTEXT.md
@.planning/phases/17-site-editor-plugin/17-RESEARCH.md
@.planning/phases/17-site-editor-plugin/17-04-SUMMARY.md

Research patterns to use:
- Pattern 3: Snapshot-based undo/redo (useUndoRedo hook)
- Pattern 4: postMessage iframe bridge (useIframeBridge hook)
- Pattern 7: DnD sortable section list (DndContext + SortableContext + useSortable)
- Pattern 8: Slide navigation for left panel (CSS translateX, no library)
- Research pitfall 1: NO useEffect ‚Äî use useSyncExternalStore for keyboard shortcuts
- Research pitfall 3: Cast toolCaller to GenericToolCaller for filesystem tools
</context>

<tasks>

<task type="auto">
  <name>Task 1: RJSF widgets, templates, prop-editor, block-picker, loader-drawer</name>
  <files>
    packages/mesh-plugin-site-editor/client/components/rjsf/widgets.tsx
    packages/mesh-plugin-site-editor/client/components/rjsf/templates.tsx
    packages/mesh-plugin-site-editor/client/components/prop-editor.tsx
    packages/mesh-plugin-site-editor/client/components/block-picker.tsx
    packages/mesh-plugin-site-editor/client/components/loader-drawer.tsx
  </files>
  <action>
**rjsf/widgets.tsx** ‚Äî Custom RJSF v6 widgets using @deco/ui primitives:

```typescript
import type { WidgetProps, RegistryWidgetsType } from "@rjsf/utils";
import { Input } from "@deco/ui/components/input";
import { Checkbox } from "@deco/ui/components/checkbox";
import { Label } from "@deco/ui/components/label";

function TextWidget({ id, value, onChange, placeholder, disabled, readonly }: WidgetProps) {
  return (
    <Input
      id={id}
      value={value ?? ""}
      onChange={(e) => onChange(e.target.value === "" ? undefined : e.target.value)}
      placeholder={placeholder}
      disabled={disabled || readonly}
      className="h-7 text-sm"
    />
  );
}

function NumberWidget({ id, value, onChange, disabled, readonly }: WidgetProps) {
  return (
    <Input
      id={id}
      type="number"
      value={value ?? ""}
      onChange={(e) => {
        const n = parseFloat(e.target.value);
        onChange(isNaN(n) ? undefined : n);
      }}
      disabled={disabled || readonly}
      className="h-7 text-sm"
    />
  );
}

function CheckboxWidget({ id, value, onChange, label, disabled, readonly }: WidgetProps) {
  return (
    <div className="flex items-center gap-2">
      <Checkbox
        id={id}
        checked={!!value}
        onCheckedChange={(checked) => onChange(!!checked)}
        disabled={disabled || readonly}
      />
      {label && <Label htmlFor={id} className="text-sm font-normal">{label}</Label>}
    </div>
  );
}

function URLWidget({ id, value, onChange, placeholder, disabled, readonly }: WidgetProps) {
  return (
    <Input
      id={id}
      type="url"
      value={value ?? ""}
      onChange={(e) => onChange(e.target.value === "" ? undefined : e.target.value)}
      placeholder={placeholder ?? "https://"}
      disabled={disabled || readonly}
      className="h-7 text-sm"
    />
  );
}

export const customWidgets: RegistryWidgetsType = {
  TextWidget,
  text: TextWidget,
  NumberWidget,
  number: NumberWidget,
  CheckboxWidget,
  checkbox: CheckboxWidget,
  URLWidget,
  uri: URLWidget,
};
```

**rjsf/templates.tsx** ‚Äî Minimal custom templates to clean up RJSF default UI:

```typescript
import type { FieldTemplateProps, DescriptionFieldProps } from "@rjsf/utils";

export function FieldTemplate({ id, label, required, children, errors }: FieldTemplateProps) {
  return (
    <div className="flex flex-col gap-1 mb-3">
      {label && (
        <label htmlFor={id} className="text-xs font-medium text-foreground">
          {label}
          {required && <span className="text-destructive ml-0.5">*</span>}
        </label>
      )}
      {children}
      {errors && <div className="text-xs text-destructive">{errors}</div>}
    </div>
  );
}

export function DescriptionField({ description }: DescriptionFieldProps) {
  if (!description) return null;
  return <p className="text-xs text-muted-foreground -mt-1">{description}</p>;
}

export const customTemplates = {
  FieldTemplate,
  DescriptionField,
};
```

**prop-editor.tsx** ‚Äî RJSF form for editing a block's props:

```typescript
import Form from "@rjsf/core";
import type { RJSFSchema } from "@rjsf/utils";
import validator from "@rjsf/validator-ajv8";
import { ChevronLeft, Link2 } from "lucide-react";
import { Button } from "@deco/ui/components/button";
import { customWidgets } from "./rjsf/widgets";
import { customTemplates } from "./rjsf/templates";
import type { BlockInstance } from "../lib/page-api";
import type { BlockDefinition } from "@decocms/mesh-plugin-deco-blocks";

interface PropEditorProps {
  block: BlockInstance;
  blockDef: BlockDefinition | undefined;
  onPropsChange: (props: Record<string, unknown>) => void;
  onBack: () => void;
  onBindLoader: (propName: string) => void;
}

export function PropEditor({ block, blockDef, onPropsChange, onBack, onBindLoader }: PropEditorProps) {
  const schema = (blockDef?.propsSchema ?? {}) as RJSFSchema;

  return (
    <div className="flex flex-col h-full">
      <div className="flex items-center gap-2 px-3 py-2 border-b">
        <Button variant="ghost" size="icon" className="h-7 w-7" onClick={onBack}>
          <ChevronLeft size={14} />
        </Button>
        <span className="text-sm font-medium truncate">{block.blockType}</span>
      </div>

      <div className="flex-1 overflow-y-auto p-3">
        {!blockDef ? (
          <p className="text-xs text-muted-foreground">Block definition not found for "{block.blockType}"</p>
        ) : (
          <Form
            schema={schema}
            validator={validator}
            formData={block.props}
            onChange={({ formData }) => {
              if (formData) onPropsChange(formData as Record<string, unknown>);
            }}
            widgets={customWidgets}
            templates={customTemplates}
            uiSchema={{ "ui:submitButtonOptions": { norender: true } }}
          />
        )}
      </div>

      {/* Bind loader section */}
      {blockDef && (
        <div className="border-t px-3 py-2">
          <p className="text-xs text-muted-foreground mb-2">Loader binding</p>
          {block.loaderBinding ? (
            <div className="flex items-center justify-between text-xs">
              <span className="text-foreground">{block.loaderBinding.loaderName} ‚Üí {block.loaderBinding.prop}</span>
              <Button variant="ghost" size="sm" className="h-6 text-xs" onClick={() => onBindLoader("")}>
                Change
              </Button>
            </div>
          ) : (
            <Button variant="outline" size="sm" className="w-full h-7 text-xs" onClick={() => onBindLoader("")}>
              <Link2 size={12} className="mr-1.5" />
              Bind loader
            </Button>
          )}
        </div>
      )}
    </div>
  );
}
```

**block-picker.tsx** ‚Äî modal to add a block to the page:

```typescript
import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@deco/ui/components/dialog";
import { Input } from "@deco/ui/components/input";
import { Button } from "@deco/ui/components/button";
import type { TypedToolCaller } from "@decocms/bindings";
import type { DecoBlocksBinding } from "@decocms/bindings";
import { listBlocks } from "../lib/block-api";
import type { BlockDefinition } from "@decocms/mesh-plugin-deco-blocks";
import { QUERY_KEYS } from "../lib/query-keys";

interface BlockPickerProps {
  open: boolean;
  onClose: () => void;
  onSelect: (block: BlockDefinition) => void;
  toolCaller: TypedToolCaller<DecoBlocksBinding>;
  projectId: string;
}

export function BlockPicker({ open, onClose, onSelect, toolCaller, projectId }: BlockPickerProps) {
  const [search, setSearch] = useState("");

  const { data: blocks = [] } = useQuery({
    queryKey: QUERY_KEYS.blocks(projectId),
    queryFn: () => listBlocks(toolCaller),
    enabled: open,
  });

  const filtered = search
    ? blocks.filter((b) => b.name.toLowerCase().includes(search.toLowerCase()))
    : blocks;

  return (
    <Dialog open={open} onOpenChange={(v) => !v && onClose()}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle>Add section</DialogTitle>
        </DialogHeader>
        <Input
          placeholder="Search blocks..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          autoFocus
        />
        <div className="max-h-80 overflow-y-auto flex flex-col gap-1 mt-2">
          {filtered.length === 0 ? (
            <p className="text-sm text-muted-foreground text-center py-4">No blocks found</p>
          ) : (
            filtered.map((block) => (
              <Button
                key={block.name}
                variant="ghost"
                className="justify-start h-auto py-2 px-3"
                onClick={() => { onSelect(block); onClose(); }}
              >
                <div className="text-left">
                  <div className="text-sm font-medium">{block.name}</div>
                  <div className="text-xs text-muted-foreground">{block.kind}</div>
                </div>
              </Button>
            ))
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

**loader-drawer.tsx** ‚Äî drawer for binding a loader to a prop:

```typescript
import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { X } from "lucide-react";
import { Button } from "@deco/ui/components/button";
import type { TypedToolCaller } from "@decocms/bindings";
import type { DecoBlocksBinding } from "@decocms/bindings";
import { listLoaders } from "../lib/block-api";
import type { LoaderDefinition } from "@decocms/mesh-plugin-deco-blocks";
import { QUERY_KEYS } from "../lib/query-keys";

interface LoaderDrawerProps {
  open: boolean;
  onClose: () => void;
  onSelect: (loader: LoaderDefinition, prop: string) => void;
  toolCaller: TypedToolCaller<DecoBlocksBinding>;
  projectId: string;
  targetProp?: string;
}

export function LoaderDrawer({ open, onClose, onSelect, toolCaller, projectId, targetProp }: LoaderDrawerProps) {
  const { data: loaders = [] } = useQuery({
    queryKey: QUERY_KEYS.loaders(projectId),
    queryFn: () => listLoaders(toolCaller),
    enabled: open,
  });

  if (!open) return null;

  return (
    <div className="absolute inset-y-0 right-0 w-72 bg-background border-l shadow-lg flex flex-col z-10">
      <div className="flex items-center justify-between px-3 py-2 border-b">
        <span className="text-sm font-medium">Bind loader{targetProp ? ` ‚Üí ${targetProp}` : ""}</span>
        <Button variant="ghost" size="icon" className="h-6 w-6" onClick={onClose}>
          <X size={12} />
        </Button>
      </div>
      <div className="flex-1 overflow-y-auto p-2 flex flex-col gap-1">
        {loaders.length === 0 ? (
          <p className="text-xs text-muted-foreground text-center py-4">No loaders found</p>
        ) : (
          loaders.map((loader) => (
            <Button
              key={loader.name}
              variant="ghost"
              className="justify-start h-auto py-2 px-3"
              onClick={() => { onSelect(loader, targetProp ?? ""); onClose(); }}
            >
              <div className="text-left">
                <div className="text-sm font-medium">{loader.name}</div>
                <div className="text-xs text-muted-foreground">loader</div>
              </div>
            </Button>
          ))
        )}
      </div>
    </div>
  );
}
```
  </action>
  <verify>
    bun run --cwd=packages/mesh-plugin-site-editor check 2>&1 | grep error | head -10
    Expect: 0 TypeScript errors in these files
  </verify>
  <done>rjsf widgets/templates compile; PropEditor renders RJSF form with custom widgets; BlockPicker and LoaderDrawer compile cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Section list with DnD, preview panel, and main page-composer</name>
  <files>
    packages/mesh-plugin-site-editor/client/components/section-list-sidebar.tsx
    packages/mesh-plugin-site-editor/client/components/preview-panel.tsx
    packages/mesh-plugin-site-editor/client/components/page-composer.tsx
  </files>
  <action>
**section-list-sidebar.tsx** ‚Äî DnD sortable sections list:

```typescript
import { DndContext, PointerSensor, useSensor, useSensors, type DragEndEvent } from "@dnd-kit/core";
import { SortableContext, useSortable, verticalListSortingStrategy, arrayMove } from "@dnd-kit/sortable";
import { restrictToVerticalAxis } from "@dnd-kit/modifiers";
import { CSS } from "@dnd-kit/utilities";
import { GripVertical, Trash2, Plus } from "lucide-react";
import { Button } from "@deco/ui/components/button";
import type { BlockInstance } from "../lib/page-api";

interface SectionListSidebarProps {
  blocks: BlockInstance[];
  selectedBlockId: string | null;
  onSelectBlock: (id: string) => void;
  onReorder: (blocks: BlockInstance[]) => void;
  onRemove: (id: string) => void;
  onAddSection: () => void;
}

function SortableSection({
  block,
  isSelected,
  onSelect,
  onRemove,
}: {
  block: BlockInstance;
  isSelected: boolean;
  onSelect: () => void;
  onRemove: () => void;
}) {
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } =
    useSortable({ id: block.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={`flex items-center gap-1 px-2 py-1.5 group cursor-pointer rounded-sm mx-1 ${
        isSelected ? "bg-accent" : "hover:bg-accent/50"
      }`}
      onClick={onSelect}
    >
      <button
        className="opacity-0 group-hover:opacity-100 cursor-grab touch-none p-0.5"
        {...attributes}
        {...listeners}
        onClick={(e) => e.stopPropagation()}
      >
        <GripVertical size={12} className="text-muted-foreground" />
      </button>
      <span className="flex-1 text-sm truncate">{block.blockType}</span>
      <Button
        variant="ghost"
        size="icon"
        className="opacity-0 group-hover:opacity-100 h-5 w-5"
        onClick={(e) => { e.stopPropagation(); onRemove(); }}
      >
        <Trash2 size={10} />
      </Button>
    </div>
  );
}

export function SectionListSidebar({
  blocks,
  selectedBlockId,
  onSelectBlock,
  onReorder,
  onRemove,
  onAddSection,
}: SectionListSidebarProps) {
  const sensors = useSensors(useSensor(PointerSensor));

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;
    if (!over || active.id === over.id) return;
    const oldIndex = blocks.findIndex((b) => b.id === active.id);
    const newIndex = blocks.findIndex((b) => b.id === over.id);
    onReorder(arrayMove(blocks, oldIndex, newIndex));
  };

  return (
    <div className="flex flex-col h-full">
      <div className="flex items-center justify-between px-3 py-2 border-b">
        <span className="text-xs font-medium text-muted-foreground uppercase tracking-wider">Sections</span>
        <Button variant="ghost" size="icon" className="h-6 w-6" onClick={onAddSection}>
          <Plus size={12} />
        </Button>
      </div>

      <div className="flex-1 overflow-y-auto py-1">
        {blocks.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-full gap-2 px-4 text-center">
            <p className="text-xs text-muted-foreground">No sections yet</p>
            <Button variant="outline" size="sm" className="text-xs h-7" onClick={onAddSection}>
              <Plus size={10} className="mr-1" />
              Add section
            </Button>
          </div>
        ) : (
          <DndContext
            sensors={sensors}
            modifiers={[restrictToVerticalAxis]}
            onDragEnd={handleDragEnd}
          >
            <SortableContext items={blocks.map((b) => b.id)} strategy={verticalListSortingStrategy}>
              {blocks.map((block) => (
                <SortableSection
                  key={block.id}
                  block={block}
                  isSelected={selectedBlockId === block.id}
                  onSelect={() => onSelectBlock(block.id)}
                  onRemove={() => onRemove(block.id)}
                />
              ))}
            </SortableContext>
          </DndContext>
        )}
      </div>
    </div>
  );
}
```

**preview-panel.tsx** ‚Äî iframe with edit/interact toggle:

```typescript
import { useRef } from "react";
import { MousePointer2, Edit3 } from "lucide-react";
import { Button } from "@deco/ui/components/button";
import type { UseIframeBridgeResult, IframeMode } from "../lib/use-iframe-bridge";

interface PreviewPanelProps {
  previewUrl: string | null | undefined;
  mode: IframeMode;
  onModeChange: (mode: IframeMode) => void;
  bridge: UseIframeBridgeResult;
}

export function PreviewPanel({ previewUrl, mode, onModeChange, bridge }: PreviewPanelProps) {
  if (!previewUrl) {
    return (
      <div className="flex flex-col items-center justify-center h-full gap-3 text-center p-8">
        <div className="text-4xl">üñ•Ô∏è</div>
        <h3 className="text-sm font-medium">No preview available</h3>
        <p className="text-xs text-muted-foreground max-w-xs">
          Run <code className="bg-muted px-1 rounded text-xs">deco link ./folder</code> to start the dev server and connect preview.
        </p>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-full">
      <div className="flex items-center justify-between px-3 py-1.5 border-b bg-muted/30">
        <span className="text-xs text-muted-foreground truncate">{previewUrl}</span>
        <div className="flex items-center gap-1">
          <Button
            variant={mode === "edit" ? "secondary" : "ghost"}
            size="sm"
            className="h-6 text-xs px-2"
            onClick={() => onModeChange("edit")}
          >
            <Edit3 size={10} className="mr-1" />
            Edit
          </Button>
          <Button
            variant={mode === "interact" ? "secondary" : "ghost"}
            size="sm"
            className="h-6 text-xs px-2"
            onClick={() => onModeChange("interact")}
          >
            <MousePointer2 size={10} className="mr-1" />
            Interact
          </Button>
        </div>
      </div>
      <div className="flex-1 relative">
        <iframe
          ref={bridge.setIframeRef}
          src={previewUrl}
          title="Site preview"
          className="w-full h-full border-0"
          style={{ pointerEvents: mode === "interact" ? "auto" : "none" }}
        />
        {/* Overlay to block clicks in edit mode while preserving iframe visibility */}
        {mode === "edit" && (
          <div className="absolute inset-0 cursor-default" />
        )}
      </div>
    </div>
  );
}
```

**page-composer.tsx** ‚Äî main composer with all pieces assembled:

```typescript
import { useState, useSyncExternalStore } from "react";
import { useParams } from "@tanstack/react-router";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { usePluginContext } from "@decocms/mesh-sdk/plugins";
import { ChevronLeft } from "lucide-react";
import { Button } from "@deco/ui/components/button";
import { toast } from "sonner";
import { nanoid } from "nanoid";
import type { DecoBlocksBinding } from "@decocms/bindings";
import { getPage, updatePage, type Page, type BlockInstance, type GenericToolCaller } from "../lib/page-api";
import { listBlocks } from "../lib/block-api";
import { useUndoRedo } from "../lib/use-undo-redo";
import { useIframeBridge } from "../lib/use-iframe-bridge";
import type { IframeMode } from "../lib/use-iframe-bridge";
import { QUERY_KEYS } from "../lib/query-keys";
import { SectionListSidebar } from "./section-list-sidebar";
import { PropEditor } from "./prop-editor";
import { PreviewPanel } from "./preview-panel";
import { BlockPicker } from "./block-picker";
import { LoaderDrawer } from "./loader-drawer";
import type { BlockDefinition, LoaderDefinition } from "@decocms/mesh-plugin-deco-blocks";
import { useNavigate } from "@tanstack/react-router";

export default function PageComposer() {
  const { pageId, org, project } = useParams({ strict: false }) as {
    pageId: string; org: string; project: string;
  };
  const { toolCaller, connection } = usePluginContext<DecoBlocksBinding>();
  const genericCaller = toolCaller as unknown as GenericToolCaller;
  const queryClient = useQueryClient();
  const navigate = useNavigate();

  const projectId = connection?.id ?? "";
  const previewUrl = (connection?.metadata?.previewUrl as string | null | undefined) ?? null;

  // --- Page data ---
  const { data: page, isLoading } = useQuery({
    queryKey: QUERY_KEYS.page(projectId, pageId),
    queryFn: () => getPage(genericCaller, pageId),
    enabled: !!toolCaller && !!pageId,
  });

  // --- Blocks definitions ---
  const { data: allBlocks = [] } = useQuery({
    queryKey: QUERY_KEYS.blocks(projectId),
    queryFn: () => listBlocks(toolCaller!),
    enabled: !!toolCaller,
  });

  // --- Undo/redo for block list ---
  const { value: blocks, push: pushBlocks, undo, redo, canUndo, canRedo, reset } =
    useUndoRedo<BlockInstance[]>(page?.blocks ?? []);

  // Reset undo history when page data first loads
  // Track previous pageId to detect navigation
  const prevPageIdRef = { current: "" };
  if (page && prevPageIdRef.current !== pageId) {
    prevPageIdRef.current = pageId;
    reset(page.blocks);
  }

  // --- Local UI state ---
  const [selectedBlockId, setSelectedBlockId] = useState<string | null>(null);
  const [mode, setMode] = useState<IframeMode>("edit");
  const [blockPickerOpen, setBlockPickerOpen] = useState(false);
  const [loaderDrawerOpen, setLoaderDrawerOpen] = useState(false);
  const [loaderTargetProp, setLoaderTargetProp] = useState<string>("");

  // --- iframe bridge ---
  const bridge = useIframeBridge({
    page: page ? { ...page, blocks } : null,
    selectedBlockId,
    mode,
    onBlockClicked: (id) => setSelectedBlockId((prev) => prev === id ? null : id),
    onClickAway: () => setSelectedBlockId(null),
  });

  // --- Keyboard shortcuts via useSyncExternalStore (no useEffect) ---
  // Use module-level event store to avoid recreating on every render
  useSyncExternalStore(
    (notify) => {
      const handler = (e: KeyboardEvent) => {
        const mod = e.metaKey || e.ctrlKey;
        if (!mod) return;
        if (e.key === "z" && !e.shiftKey) { e.preventDefault(); undo(); notify(); }
        if ((e.key === "z" && e.shiftKey) || e.key === "y") { e.preventDefault(); redo(); notify(); }
      };
      window.addEventListener("keydown", handler);
      return () => window.removeEventListener("keydown", handler);
    },
    () => null,
    () => null,
  );

  // --- Auto-save: debounce write to file ---
  // Use a ref-based debounce (not useEffect)
  // In this simplified version, save is triggered explicitly via mutation
  const saveMutation = useMutation({
    mutationFn: async (updatedPage: Page) => {
      await updatePage(genericCaller, updatedPage);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: QUERY_KEYS.page(projectId, pageId) });
    },
    onError: () => toast.error("Failed to save"),
  });

  const saveBlocks = (newBlocks: BlockInstance[]) => {
    if (!page) return;
    pushBlocks(newBlocks);
    saveMutation.mutate({ ...page, blocks: newBlocks });
  };

  // --- Section operations ---
  const handleAddBlock = (blockDef: BlockDefinition) => {
    const newBlock: BlockInstance = {
      id: nanoid(8),
      blockType: blockDef.name,
      props: {},
    };
    saveBlocks([...blocks, newBlock]);
  };

  const handleReorder = (reordered: BlockInstance[]) => {
    saveBlocks(reordered);
  };

  const handleRemove = (id: string) => {
    saveBlocks(blocks.filter((b) => b.id !== id));
    if (selectedBlockId === id) setSelectedBlockId(null);
  };

  const handlePropsChange = (props: Record<string, unknown>) => {
    if (!selectedBlockId) return;
    saveBlocks(blocks.map((b) => b.id === selectedBlockId ? { ...b, props } : b));
  };

  const handleLoaderBind = (loader: LoaderDefinition, prop: string) => {
    if (!selectedBlockId) return;
    saveBlocks(blocks.map((b) =>
      b.id === selectedBlockId
        ? { ...b, loaderBinding: { prop, loaderName: loader.name, loaderProps: {} } }
        : b
    ));
  };

  // Selected block and its definition
  const selectedBlock = selectedBlockId ? blocks.find((b) => b.id === selectedBlockId) : null;
  const selectedBlockDef = selectedBlock
    ? allBlocks.find((b) => b.name === selectedBlock.blockType)
    : undefined;

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-full">
        <span className="text-sm text-muted-foreground">Loading page...</span>
      </div>
    );
  }

  if (!page) {
    return (
      <div className="flex items-center justify-center h-full">
        <span className="text-sm text-muted-foreground">Page not found</span>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-full">
      {/* Composer header */}
      <div className="flex items-center gap-2 px-3 py-2 border-b">
        <Button
          variant="ghost"
          size="icon"
          className="h-7 w-7"
          onClick={() => navigate({
            to: "/$org/$project/$pluginId",
            params: { org, project, pluginId: "site-editor" },
          })}
        >
          <ChevronLeft size={14} />
        </Button>
        <span className="text-sm font-medium">{page.title}</span>
        <span className="text-xs text-muted-foreground">{page.path}</span>
        <div className="flex-1" />
        {/* Undo/redo buttons */}
        <Button variant="ghost" size="sm" className="h-6 text-xs" disabled={!canUndo} onClick={undo}>
          Undo
        </Button>
        <Button variant="ghost" size="sm" className="h-6 text-xs" disabled={!canRedo} onClick={redo}>
          Redo
        </Button>
      </div>

      {/* Main composer area */}
      <div className="flex-1 flex overflow-hidden">
        {/* Left panel ‚Äî sections list OR prop editor (slide navigation) */}
        <div className="w-64 border-r relative overflow-hidden flex-shrink-0">
          {/* Section list panel */}
          <div
            className={`absolute inset-0 transition-transform duration-200 ${
              selectedBlock ? "-translate-x-full" : "translate-x-0"
            }`}
          >
            <SectionListSidebar
              blocks={blocks}
              selectedBlockId={selectedBlockId}
              onSelectBlock={(id) => setSelectedBlockId(id)}
              onReorder={handleReorder}
              onRemove={handleRemove}
              onAddSection={() => setBlockPickerOpen(true)}
            />
          </div>

          {/* Prop editor panel */}
          <div
            className={`absolute inset-0 transition-transform duration-200 ${
              selectedBlock ? "translate-x-0" : "translate-x-full"
            }`}
          >
            {selectedBlock && (
              <PropEditor
                block={selectedBlock}
                blockDef={selectedBlockDef}
                onPropsChange={handlePropsChange}
                onBack={() => setSelectedBlockId(null)}
                onBindLoader={(prop) => {
                  setLoaderTargetProp(prop);
                  setLoaderDrawerOpen(true);
                }}
              />
            )}
          </div>

          {/* Loader drawer (absolute overlay on left panel) */}
          <LoaderDrawer
            open={loaderDrawerOpen}
            onClose={() => setLoaderDrawerOpen(false)}
            onSelect={handleLoaderBind}
            toolCaller={toolCaller!}
            projectId={projectId}
            targetProp={loaderTargetProp}
          />
        </div>

        {/* Right panel ‚Äî preview iframe */}
        <div className="flex-1 relative overflow-hidden">
          <PreviewPanel
            previewUrl={previewUrl}
            mode={mode}
            onModeChange={setMode}
            bridge={bridge}
          />
        </div>
      </div>

      {/* Block picker modal */}
      <BlockPicker
        open={blockPickerOpen}
        onClose={() => setBlockPickerOpen(false)}
        onSelect={handleAddBlock}
        toolCaller={toolCaller!}
        projectId={projectId}
      />
    </div>
  );
}
```

After writing all files, run TypeScript check:
```bash
bun run --cwd=packages/mesh-plugin-site-editor check 2>&1 | grep -E "error" | head -20
```

Fix any errors. Common issues:
- @deco/ui import paths: check what's actually exported; if Dialog/DropdownMenu missing, use simpler alternatives
- @dnd-kit imports: check exact subpath (/core, /sortable, /modifiers, /utilities)
- prevPageIdRef pattern: TypeScript may flag the inline `{ current: "" }` ‚Äî use a module-level ref pattern or initializer if needed
- useSyncExternalStore for keyboard shortcuts: make sure the subscribe/getSnapshot signatures are correct
  </action>
  <verify>
    bun run --cwd=packages/mesh-plugin-site-editor check 2>&1 | tail -5
    Expect: 0 errors

    bun run fmt 2>&1 | tail -3
    Expect: formatting passes
  </verify>
  <done>All 8 component files compile cleanly; page-composer.tsx has slide navigation, DnD reorder, RJSF props, undo/redo with keyboard shortcuts, preview iframe with mode toggle; no useEffect in any file</done>
</task>

</tasks>

<verification>
1. Run `bun run --cwd=packages/mesh-plugin-site-editor check` ‚Äî 0 TypeScript errors
2. Confirm page-composer.tsx: uses useUndoRedo and useIframeBridge hooks
3. Confirm page-composer.tsx: keyboard shortcuts use useSyncExternalStore (grep for useEffect ‚Äî must be zero hits)
4. Confirm section-list-sidebar.tsx: DndContext + SortableContext + useSortable from @dnd-kit
5. Confirm prop-editor.tsx: @rjsf/core Form with validator from @rjsf/validator-ajv8
6. Confirm preview-panel.tsx: pointer events controlled by mode ("edit" = blocked, "interact" = auto)
7. Run `bun run fmt` ‚Äî formatting passes
</verification>

<success_criteria>
- Composer compiles cleanly
- Slide navigation: section list ‚Üî prop editor in same left panel panel
- DnD reordering implemented
- RJSF form with custom widgets
- Loader binding drawer
- Preview iframe with edit/interact mode
- Undo/redo with Cmd+Z / Cmd+Shift+Z (useSyncExternalStore)
- Zero useEffect imports across all new files
</success_criteria>

<output>
After completion, create `.planning/phases/17-site-editor-plugin/17-05-SUMMARY.md`
</output>
