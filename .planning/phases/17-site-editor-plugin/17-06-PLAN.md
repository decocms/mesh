---
phase: 17-site-editor-plugin
plan: 06
type: execute
wave: 5
depends_on:
  - 17-05
files_modified:
  - packages/mesh-plugin-site-editor/client/components/footer-bar.tsx
  - packages/mesh-plugin-site-editor/client/components/commit-dialog.tsx
  - packages/mesh-plugin-site-editor/client/components/revert-dialog.tsx
  - packages/mesh-plugin-site-editor/client/components/page-composer.tsx
  - packages/mesh-plugin-site-editor/server/index.ts
  - apps/mesh/src/web/plugins.ts
  - apps/mesh/package.json
autonomous: true
requirements:
  - EDT-11
  - EDT-12
  - EDT-13
  - EDT-14
  - EDT-15

must_haves:
  truths:
    - "Footer bar appears at the bottom of the composer showing pending change count for the current page"
    - "Footer is hidden when the connection does not have a bash tool (hasBashTool returns false)"
    - "Clicking the footer expands it to show: list of git commits, diff panel (inline), and a commit button"
    - "Clicking commit opens a dialog showing Claude-generated commit message (from server route); user can edit then confirm"
    - "Committing runs git add -A && git commit via bash tool; composer refreshes after"
    - "Clicking a commit in history expands an inline diff panel (git show output)"
    - "Revert button on a commit opens a confirmation dialog; confirming runs git checkout {hash} -- .deco/pages/{id}.json"
    - "The site-editor plugin is registered in apps/mesh/src/web/plugins.ts"
    - "Server route POST /api/plugins/site-editor/commit-message returns { message: string }"
  artifacts:
    - path: "packages/mesh-plugin-site-editor/client/components/footer-bar.tsx"
      provides: "Footer with pending changes badge, git history list, diff preview"
    - path: "packages/mesh-plugin-site-editor/client/components/commit-dialog.tsx"
      provides: "Commit message review/edit dialog"
    - path: "packages/mesh-plugin-site-editor/client/components/revert-dialog.tsx"
      provides: "Revert confirmation dialog"
    - path: "packages/mesh-plugin-site-editor/server/index.ts"
      provides: "ServerPlugin with POST /commit-message route calling Claude Haiku"
    - path: "apps/mesh/src/web/plugins.ts"
      provides: "site-editor plugin registered alongside other plugins"
  key_links:
    - from: "packages/mesh-plugin-site-editor/client/components/footer-bar.tsx"
      to: "packages/mesh-plugin-site-editor/client/lib/git-api.ts"
      via: "gitStatus(), gitLog(), gitShow() via bash tool"
      pattern: "gitStatus|gitLog|gitShow"
    - from: "packages/mesh-plugin-site-editor/client/components/footer-bar.tsx"
      to: "packages/mesh-plugin-site-editor/client/lib/git-api.ts"
      via: "hasBashTool(connection.tools) — gates git UX visibility"
      pattern: "hasBashTool"
    - from: "packages/mesh-plugin-site-editor/client/components/commit-dialog.tsx"
      to: "packages/mesh-plugin-site-editor/server/index.ts"
      via: "fetch('/api/plugins/site-editor/commit-message', { method: 'POST', body: { diff } })"
      pattern: "commit-message"
    - from: "apps/mesh/src/web/plugins.ts"
      to: "packages/mesh-plugin-site-editor/client/index.tsx"
      via: "import { clientPlugin as siteEditorPlugin } from 'mesh-plugin-site-editor/client'"
      pattern: "siteEditorPlugin"
---

<objective>
Build the git UX footer (pending changes, commit flow, history with diff, revert) and the server-side commit message generation route. Register the plugin in apps/mesh to make it discoverable and activatable.

Purpose: EDT-11 through EDT-14 (git UX) gated on bash tool availability, EDT-15 completion (plugin registered and activatable in Mesh).
Output: footer-bar.tsx, commit-dialog.tsx, revert-dialog.tsx, updated server/index.ts, updated page-composer.tsx, updated apps/mesh plugins.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/17-site-editor-plugin/17-CONTEXT.md
@.planning/phases/17-site-editor-plugin/17-RESEARCH.md
@.planning/phases/17-site-editor-plugin/17-05-SUMMARY.md

Apps mesh plugins registration: @apps/mesh/src/web/plugins.ts
Apps mesh package.json: @apps/mesh/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Footer bar with git UX, commit dialog, revert dialog, updated server/index.ts</name>
  <files>
    packages/mesh-plugin-site-editor/client/components/footer-bar.tsx
    packages/mesh-plugin-site-editor/client/components/commit-dialog.tsx
    packages/mesh-plugin-site-editor/client/components/revert-dialog.tsx
    packages/mesh-plugin-site-editor/server/index.ts
  </files>
  <action>
**commit-dialog.tsx** — shows generated commit message, lets user edit before committing:

```typescript
import { useState } from "react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@deco/ui/components/dialog";
import { Button } from "@deco/ui/components/button";
import { Textarea } from "@deco/ui/components/textarea";
import { Label } from "@deco/ui/components/label";

interface CommitDialogProps {
  open: boolean;
  onClose: () => void;
  onConfirm: (message: string) => Promise<void>;
  generatedMessage: string;
  isGenerating: boolean;
}

export function CommitDialog({ open, onClose, onConfirm, generatedMessage, isGenerating }: CommitDialogProps) {
  const [message, setMessage] = useState(generatedMessage);
  const [committing, setCommitting] = useState(false);

  // Sync message when generatedMessage changes (when dialog opens with new content)
  if (message === "" && generatedMessage !== "") {
    setMessage(generatedMessage);
  }

  const handleConfirm = async () => {
    if (!message.trim()) return;
    setCommitting(true);
    try {
      await onConfirm(message);
      onClose();
    } finally {
      setCommitting(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={(v) => !v && onClose()}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Commit changes</DialogTitle>
        </DialogHeader>
        <div className="flex flex-col gap-3">
          <div className="flex flex-col gap-1.5">
            <Label>Commit message</Label>
            {isGenerating ? (
              <div className="text-sm text-muted-foreground italic">Generating message...</div>
            ) : (
              <Textarea
                value={message}
                onChange={(e) => setMessage(e.target.value)}
                rows={3}
                placeholder="Describe your changes..."
                autoFocus
              />
            )}
          </div>
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose} disabled={committing}>
            Cancel
          </Button>
          <Button onClick={handleConfirm} disabled={committing || isGenerating || !message.trim()}>
            {committing ? "Committing..." : "Commit"}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**revert-dialog.tsx** — confirmation before git checkout:

```typescript
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@deco/ui/components/alert-dialog";
import type { GitCommit } from "../lib/git-api";

interface RevertDialogProps {
  open: boolean;
  onClose: () => void;
  onConfirm: () => Promise<void>;
  commit: GitCommit | null;
}

export function RevertDialog({ open, onClose, onConfirm, commit }: RevertDialogProps) {
  if (!commit) return null;

  const handleConfirm = async () => {
    await onConfirm();
    onClose();
  };

  return (
    <AlertDialog open={open} onOpenChange={(v) => !v && onClose()}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Revert to this commit?</AlertDialogTitle>
          <AlertDialogDescription>
            This will restore the page to commit{" "}
            <code className="bg-muted px-1 rounded text-xs">{commit.hash.slice(0, 8)}</code>
            {" "}— "{commit.message}". Any unsaved changes will be replaced.
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>Cancel</AlertDialogCancel>
          <AlertDialogAction onClick={handleConfirm}>
            Revert
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

Note: if AlertDialog isn't in @deco/ui, use a regular Dialog with explicit cancel/confirm buttons instead.

**footer-bar.tsx** — bottom bar with pending changes, git history, commit:

```typescript
import { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { ChevronUp, ChevronDown, GitCommit as GitCommitIcon } from "lucide-react";
import { Button } from "@deco/ui/components/button";
import { toast } from "sonner";
import type { GenericToolCaller } from "../lib/page-api";
import {
  hasBashTool,
  gitStatus,
  gitLog,
  gitShow,
  gitCheckout,
  gitCommit,
  type GitCommit,
} from "../lib/git-api";
import { QUERY_KEYS } from "../lib/query-keys";
import { CommitDialog } from "./commit-dialog";
import { RevertDialog } from "./revert-dialog";

interface FooterBarProps {
  pageId: string;
  projectId: string;
  toolCaller: GenericToolCaller;
  connectionTools: Array<{ name: string }> | null | undefined;
  onPageReverted: () => void;
}

export function FooterBar({ pageId, projectId, toolCaller, connectionTools, onPageReverted }: FooterBarProps) {
  const [expanded, setExpanded] = useState(false);
  const [commitDialogOpen, setCommitDialogOpen] = useState(false);
  const [generatedMessage, setGeneratedMessage] = useState("");
  const [isGenerating, setIsGenerating] = useState(false);
  const [expandedCommitHash, setExpandedCommitHash] = useState<string | null>(null);
  const [diffContent, setDiffContent] = useState<string>("");
  const [revertTarget, setRevertTarget] = useState<GitCommit | null>(null);
  const queryClient = useQueryClient();

  // Hide git UX if no bash tool on connection
  if (!hasBashTool(connectionTools)) return null;

  const { data: statusResult } = useQuery({
    queryKey: QUERY_KEYS.gitStatus(projectId, pageId),
    queryFn: () => gitStatus(toolCaller, pageId),
    refetchInterval: 5000, // Poll every 5s for changes
  });

  const { data: commits = [] } = useQuery({
    queryKey: QUERY_KEYS.gitLog(projectId, pageId),
    queryFn: () => gitLog(toolCaller, pageId),
    enabled: expanded,
  });

  const hasPendingChanges = statusResult?.status !== "clean";
  const statusBadge = hasPendingChanges ? statusResult?.status : null;

  const handleOpenCommit = async () => {
    setIsGenerating(true);
    setGeneratedMessage("");
    setCommitDialogOpen(true);
    try {
      // Get diff for commit message generation
      const diffResult = await toolCaller("bash", {
        command: `git diff HEAD .deco/pages/${pageId}.json`,
      }) as { stdout: string };
      const diff = diffResult.stdout;

      // Call server route for Claude-generated message
      const response = await fetch("/api/plugins/site-editor/commit-message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ diff }),
      });
      const data = (await response.json()) as { message?: string };
      setGeneratedMessage(data.message || "");
    } catch {
      setGeneratedMessage("Update site page");
    } finally {
      setIsGenerating(false);
    }
  };

  const handleCommit = async (message: string) => {
    await gitCommit(toolCaller, message);
    queryClient.invalidateQueries({ queryKey: QUERY_KEYS.gitStatus(projectId, pageId) });
    queryClient.invalidateQueries({ queryKey: QUERY_KEYS.gitLog(projectId, pageId) });
    toast.success("Changes committed");
  };

  const handleExpandCommit = async (commit: GitCommit) => {
    if (expandedCommitHash === commit.hash) {
      setExpandedCommitHash(null);
      return;
    }
    setExpandedCommitHash(commit.hash);
    const content = await gitShow(toolCaller, commit.hash, pageId);
    setDiffContent(content);
  };

  const handleRevert = async () => {
    if (!revertTarget) return;
    await gitCheckout(toolCaller, revertTarget.hash, pageId);
    queryClient.invalidateQueries({ queryKey: QUERY_KEYS.page(projectId, pageId) });
    queryClient.invalidateQueries({ queryKey: QUERY_KEYS.gitStatus(projectId, pageId) });
    toast.success("Page reverted");
    onPageReverted();
  };

  return (
    <div className="border-t bg-background">
      {/* Footer header bar */}
      <div
        className="flex items-center gap-2 px-3 py-1.5 cursor-pointer hover:bg-muted/30 select-none"
        onClick={() => setExpanded((v) => !v)}
      >
        <GitCommitIcon size={12} className="text-muted-foreground" />
        <span className="text-xs text-muted-foreground flex-1">
          {hasPendingChanges ? (
            <span>
              <span className={`inline-block w-1.5 h-1.5 rounded-full mr-1.5 ${
                statusBadge === "A" ? "bg-green-500" : statusBadge === "D" ? "bg-red-500" : "bg-yellow-500"
              }`} />
              Pending changes
            </span>
          ) : (
            "No pending changes"
          )}
        </span>
        {hasPendingChanges && (
          <Button
            variant="outline"
            size="sm"
            className="h-5 text-xs px-2"
            onClick={(e) => { e.stopPropagation(); void handleOpenCommit(); }}
          >
            Commit
          </Button>
        )}
        {expanded ? <ChevronDown size={12} /> : <ChevronUp size={12} />}
      </div>

      {/* Expanded footer panel */}
      {expanded && (
        <div className="border-t max-h-64 overflow-y-auto">
          {commits.length === 0 ? (
            <p className="text-xs text-muted-foreground px-3 py-2">No commit history for this page.</p>
          ) : (
            <ul className="divide-y">
              {commits.map((commit) => (
                <li key={commit.hash}>
                  <div
                    className="flex items-start gap-2 px-3 py-2 hover:bg-muted/30 cursor-pointer"
                    onClick={() => void handleExpandCommit(commit)}
                  >
                    <GitCommitIcon size={12} className="mt-0.5 text-muted-foreground flex-shrink-0" />
                    <div className="flex-1 min-w-0">
                      <div className="text-xs font-medium truncate">{commit.message}</div>
                      <div className="text-xs text-muted-foreground">
                        {commit.author} · {new Date(commit.date).toLocaleDateString()}
                        · <code className="bg-muted px-0.5 rounded">{commit.hash.slice(0, 7)}</code>
                      </div>
                    </div>
                    <Button
                      variant="ghost"
                      size="sm"
                      className="h-5 text-xs px-1.5 flex-shrink-0"
                      onClick={(e) => { e.stopPropagation(); setRevertTarget(commit); }}
                    >
                      Revert
                    </Button>
                  </div>

                  {/* Inline diff panel */}
                  {expandedCommitHash === commit.hash && (
                    <div className="bg-muted/20 px-3 py-2 border-t">
                      <pre className="text-xs font-mono whitespace-pre-wrap overflow-x-auto max-h-40 text-muted-foreground">
                        {diffContent || "Loading diff..."}
                      </pre>
                    </div>
                  )}
                </li>
              ))}
            </ul>
          )}
        </div>
      )}

      <CommitDialog
        open={commitDialogOpen}
        onClose={() => setCommitDialogOpen(false)}
        onConfirm={handleCommit}
        generatedMessage={generatedMessage}
        isGenerating={isGenerating}
      />

      <RevertDialog
        open={!!revertTarget}
        onClose={() => setRevertTarget(null)}
        onConfirm={handleRevert}
        commit={revertTarget}
      />
    </div>
  );
}
```

Note: `void handleOpenCommit()` pattern to call async function in event handler without await (React event handlers can't be async directly).

**server/index.ts** — add commit-message route (replace the stub from plan 17-01):

```typescript
import type { ServerPlugin } from "@decocms/bindings/server-plugin";
import { PLUGIN_ID, PLUGIN_DESCRIPTION } from "../shared";

export const serverPlugin: ServerPlugin = {
  id: PLUGIN_ID,
  description: PLUGIN_DESCRIPTION,
  routes: (app, _ctx) => {
    /**
     * POST /api/plugins/site-editor/commit-message
     * Body: { diff: string }
     * Returns: { message: string }
     *
     * Calls Claude Haiku to generate a conventional commit message from a git diff.
     * Falls back to empty string if ANTHROPIC_API_KEY is not set.
     */
    app.post("/commit-message", async (c) => {
      const apiKey = process.env.ANTHROPIC_API_KEY;
      if (!apiKey) {
        return c.json({ message: "" });
      }

      let diff = "";
      try {
        const body = await c.req.json() as { diff?: string };
        diff = body.diff ?? "";
      } catch {
        return c.json({ message: "" });
      }

      if (!diff.trim()) {
        return c.json({ message: "Update site page" });
      }

      try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": apiKey,
            "anthropic-version": "2023-06-01",
          },
          body: JSON.stringify({
            model: "claude-haiku-4-5-20251001",
            max_tokens: 200,
            messages: [
              {
                role: "user",
                content: `Generate a conventional commit message (50 chars max subject line) for this git diff. Output ONLY the commit message, nothing else.\n\nDiff:\n${diff.slice(0, 3000)}`,
              },
            ],
          }),
        });

        const data = await response.json() as {
          content?: Array<{ type: string; text: string }>;
        };
        const message = data.content?.[0]?.text?.trim() ?? "";
        return c.json({ message });
      } catch {
        return c.json({ message: "" });
      }
    });
  },
};
```
  </action>
  <verify>
    bun run --cwd=packages/mesh-plugin-site-editor check 2>&1 | grep error | head -10
    Expect: 0 TypeScript errors
  </verify>
  <done>footer-bar.tsx, commit-dialog.tsx, revert-dialog.tsx compile; server/index.ts has working commit-message route; hasBashTool gates all git UX</done>
</task>

<task type="auto">
  <name>Task 2: Wire footer into page-composer and register plugin in apps/mesh</name>
  <files>
    packages/mesh-plugin-site-editor/client/components/page-composer.tsx
    apps/mesh/src/web/plugins.ts
    apps/mesh/package.json
  </files>
  <action>
**Update page-composer.tsx** — add FooterBar at the bottom of the composer layout:

1. Add import: `import { FooterBar } from "./footer-bar";`
2. In the JSX, after the main composer area div (the flex-1 flex overflow-hidden div), add:

```tsx
{/* Git footer — hidden if no bash tool */}
<FooterBar
  pageId={pageId}
  projectId={projectId}
  toolCaller={genericCaller}
  connectionTools={connection?.tools}
  onPageReverted={() => {
    queryClient.invalidateQueries({ queryKey: QUERY_KEYS.page(projectId, pageId) });
  }}
/>
```

The outer flex-col container already exists in page-composer.tsx. Place FooterBar as the last child inside the outermost `<div className="flex flex-col h-full">`.

**Update apps/mesh/src/web/plugins.ts** — add site-editor plugin:

Read the current file first, then add the import and registration:
```typescript
import { clientPlugin as siteEditorPlugin } from "mesh-plugin-site-editor/client";
```

Add `siteEditorPlugin` to the `sourcePlugins` array.

**Update apps/mesh/package.json** — add mesh-plugin-site-editor as a workspace dependency:

Add to dependencies:
```json
"mesh-plugin-site-editor": "workspace:*"
```

After updating package.json, run `bun install` from the repo root to link the workspace:
```bash
bun install 2>&1 | tail -5
```

Then verify apps/mesh TypeScript compiles:
```bash
bun run --cwd=apps/mesh check 2>&1 | grep -E "error.*site-editor|site-editor.*error" | head -10
```

If there are errors specific to site-editor imports, fix them. Common issues:
- Wrong export path in package.json (check it matches the import "./client": "./client/index.tsx")
- Missing React types — add to devDependencies if needed
- JSX in tsx files — tsconfig needs "jsx": "react-jsx"

Also run the site-editor package check one final time:
```bash
bun run --cwd=packages/mesh-plugin-site-editor check 2>&1 | tail -5
```

Run formatter:
```bash
bun run fmt 2>&1 | tail -3
```
  </action>
  <verify>
    bun run --cwd=packages/mesh-plugin-site-editor check 2>&1 | tail -5
    Expect: 0 errors

    cat apps/mesh/src/web/plugins.ts | grep site-editor
    Expect: shows siteEditorPlugin import and registration

    bun run fmt:check 2>&1 | tail -5
    Expect: no formatting errors
  </verify>
  <done>FooterBar is mounted in page-composer; site-editor plugin registered in apps/mesh plugins.ts; apps/mesh package.json has workspace dep; bun install succeeds</done>
</task>

</tasks>

<verification>
1. Run `bun run --cwd=packages/mesh-plugin-site-editor check` — 0 errors
2. Run `bun run fmt:check` — no formatting issues
3. Confirm `apps/mesh/src/web/plugins.ts`: imports and registers siteEditorPlugin
4. Confirm `apps/mesh/package.json`: has "mesh-plugin-site-editor": "workspace:*"
5. Confirm footer-bar.tsx: `hasBashTool(connectionTools)` check gates entire footer render
6. Confirm server/index.ts: POST /commit-message route calls claude-haiku-4-5-20251001 via fetch
7. Confirm page-composer.tsx: FooterBar at bottom with pageId, projectId, toolCaller, connectionTools props
</verification>

<success_criteria>
- Git footer appears at the bottom of the composer (only when bash tool is available)
- Pending changes badge shows modification status
- Commit flow: diff → server → Haiku → user reviews → bash git commit
- Git history: commits listed, clicking expands inline diff (git show)
- Revert: confirmation dialog → git checkout → composer refreshes
- site-editor plugin registered in apps/mesh and discoverable in project settings
</success_criteria>

<output>
After completion, create `.planning/phases/17-site-editor-plugin/17-06-SUMMARY.md`
</output>
