# v1.1 Integration Architecture

**Project:** Site Editor Plugin (Mesh) v1.1
**Milestone:** Polish & Integration Fixes
**Researched:** 2026-02-15
**Confidence:** HIGH (direct code inspection)

## Executive Summary

v1.1 focuses on **integrating existing components** rather than building new architecture. Five polish items:

1. **Connection wizard** â€” âœ… Already implemented, needs polish
2. **Sections/Loaders pages** â€” âœ… Already exist, need sidebar wiring
3. **Iframe bridge cleanup** â€” âš ï¸ **BLOCKER**: Dead ref in PageComposer
4. **i18n variants** â€” âœ… Already working, needs UX polish
5. **Blocks spec** â€” Documentation task, no code

**Critical Finding:** PageComposer has dead `iframeRef` that's never attached to the actual iframe. Manual postMessage sends are no-ops. System works because PreviewPanel's bridge auto-sends on state changes, masking the bug.

## Integration Points

### 1. Connection Wizard (plugin-empty-state.tsx)

**Status:** âœ… COMPLETE â€” needs cosmetic polish only

**Current Implementation:**
```tsx
// Uses FILESYSTEM_PICK_DIRECTORY from SELF_MCP_ALIAS_ID
const result = await selfClient.callTool({
  name: "FILESYSTEM_PICK_DIRECTORY",
  arguments: {},
});

// Creates STDIO connection
const newConnection = await create.mutateAsync({
  title: `Site: ${folderName}`,
  connection_type: "STDIO",
  connection_headers: {
    command: "npx",
    args: ["-y", "@modelcontextprotocol/server-filesystem", trimmed],
  },
});

// Binds to plugin
await selfClient.callTool({
  name: "PROJECT_PLUGIN_CONFIG_UPDATE",
  arguments: { projectId, pluginId, connectionId: newConnection.id },
});

// Invalidates queries â†’ triggers PluginLayout re-render with connection
```

**Polish Tasks:**
- Add path validation (folder exists, readable, has package.json?)
- Improve error messages (permission denied, invalid path, not a site)
- Add success toast after connection created
- Show loading state with descriptive text

**Modification Type:** Cosmetic (error handling + UX)
**Estimated Effort:** 2-3 hours

### 2. Sections & Loaders Pages

**Status:** âœ… ROUTES EXIST â€” sidebar wiring unclear

**Existing Routes (router.ts):**
```tsx
const sectionsRoute = createRoute({
  getParentRoute: () => layoutRoute,
  path: "/sections",
  component: lazyRouteComponent(() => import("../components/sections-list")),
});

const loadersRoute = createRoute({
  getParentRoute: () => layoutRoute,
  path: "/loaders",
  component: lazyRouteComponent(() => import("../components/loaders-list")),
});
```

**Existing Components:**
- `/Users/guilherme/Projects/mesh/packages/mesh-plugin-site-editor/client/components/sections-list.tsx`
- `/Users/guilherme/Projects/mesh/packages/mesh-plugin-site-editor/client/components/loaders-list.tsx`
- `/Users/guilherme/Projects/mesh/packages/mesh-plugin-site-editor/client/components/block-detail.tsx`
- `/Users/guilherme/Projects/mesh/packages/mesh-plugin-site-editor/client/components/loader-detail.tsx`

**Sidebar Registration (client/index.tsx):**
```tsx
registerSidebarGroup({
  id: "site-editor",
  label: "CMS",
  items: [
    { icon: <File06 size={16} />, label: "Pages" },
    { icon: <LayoutAlt03 size={16} />, label: "Sections" },
    { icon: <Database01 size={16} />, label: "Loaders" },
  ],
  defaultExpanded: true,
});
```

**Unknown:** Whether sidebar items auto-navigate or need manual `to`/`onClick` prop.

**Required Investigation:**
1. Check `registerSidebarGroup` API signature (from `@decocms/bindings/plugins`)
2. Test if items navigate automatically via label matching or need explicit wiring
3. Add active state highlighting if not automatic

**Modification Type:** Configuration/Wiring
**Estimated Effort:** 1 hour

### 3. Iframe Bridge Cleanup

**Status:** âš ï¸ **BROKEN** â€” Critical architecture issue

**Problem:**

```tsx
// PageComposer.tsx (lines 74-75):
const iframeRef = useRef<HTMLIFrameElement>(null);  // âŒ NEVER ATTACHED
const { send } = useEditorMessages(iframeRef);      // âŒ Uses dead ref

// Manual sends throughout component:
send({ type: "deco:page-config", page: localPage });  // âŒ No-op
send({ type: "deco:update-block", ... });             // âŒ No-op

// PreviewPanel.tsx (lines 41-44):
const { setIframeRef } = useIframeBridge({...});  // âœ… Correct
// Line 110:
<iframe ref={setIframeRef} ... />                 // âœ… Attached to bridge
```

**Why It Works Despite Being Broken:**

`useIframeBridge` in PreviewPanel auto-sends messages when props change:

```tsx
// use-iframe-bridge.ts (lines 64-85):
if (readyRef.current) {
  if (page && page !== prevPageRef.current) {
    queueMicrotask(() => {
      if (readyRef.current && pageRef.current) {
        send({ type: "deco:page-config", page: pageRef.current });
      }
    });
  }
  if (selectedBlockId && selectedBlockId !== prevSelectedBlockIdRef.current) {
    queueMicrotask(() => {
      if (readyRef.current && selectedBlockIdRef.current) {
        send({ type: "deco:select-block", blockId: selectedBlockIdRef.current });
      }
    });
  }
}
```

PageComposer's manual sends are redundant â€” bridge already handles them automatically.

**Recommended Fix:** Expose bridge's `send()` via imperative handle

```tsx
// PreviewPanel.tsx:
export interface PreviewPanelHandle {
  send: (msg: EditorMessage) => void;
}

export const PreviewPanel = forwardRef<PreviewPanelHandle, Props>((props, ref) => {
  const { setIframeRef, send } = useIframeBridge({...});

  useImperativeHandle(ref, () => ({ send }), [send]);

  return <iframe ref={setIframeRef} ... />;
});

// PageComposer.tsx:
const previewRef = useRef<PreviewPanelHandle>(null);

// Remove:
const iframeRef = useRef<HTMLIFrameElement>(null);
const { send } = useEditorMessages(iframeRef);

// Update all send() calls:
previewRef.current?.send({ type: "deco:update-block", ... });

// Update JSX:
<PreviewPanel ref={previewRef} ... />
```

**Files to Modify:**
1. `preview-panel.tsx` â€” Add `forwardRef` + `useImperativeHandle`
2. `page-composer.tsx` â€” Remove dead ref, use preview ref
3. `use-editor-messages.ts` â€” Consider deprecating (may be unused elsewhere)

**Modification Type:** Refactor (no behavior change, just fixes dead code)
**Estimated Effort:** 2-3 hours

### 4. i18n Variants (Locale Switcher)

**Status:** âœ… WORKING â€” needs UX polish

**Current Implementation:**

- Locale variants fully working (page-api.ts)
- Filename pattern: `page_home.json` (default), `page_home.en-US.json` (variant)
- Locale switcher in PageComposer (lines 425-484)
- Create variant copies default page (page-api.ts line 242-271)
- Query key includes locale for automatic refetch

**Locale Switcher UI (PageComposer.tsx lines 425-484):**
```tsx
<div className="flex items-center gap-1 ml-3 bg-muted/50 rounded-full p-0.5">
  <Globe02 size={14} className="text-muted-foreground ml-1.5" />
  <button onClick={() => setActiveLocale(null)}>Default</button>
  {availableVariants.map((v) => (
    <button onClick={() => setActiveLocale(v.locale)}>{v.locale}</button>
  ))}
  {showNewLocale && <input ... />}
  <button onClick={() => setShowNewLocale(true)}><Plus /></button>
</div>
```

**Polish Tasks:**
- Replace text badges with flag emojis or country codes (en ğŸ‡ºğŸ‡¸, pt ğŸ‡§ğŸ‡·)
- Add keyboard shortcuts (Cmd+Shift+1/2/3 for first 3 locales)
- Improve new locale input UX (validation, common locale suggestions)
- Optional: Add delete variant button

**Modification Type:** Cosmetic (UX improvements)
**Estimated Effort:** 2-3 hours

### 5. Blocks Spec (Documentation)

**Status:** Not started â€” documentation task, not code

**File Structure:**
```json
{
  "id": "sections--Hero",
  "component": "components/sections/Hero.tsx",
  "label": "Hero",
  "category": "Marketing",
  "description": "Large hero section with CTA",
  "schema": { /* JSON Schema for props */ },
  "defaults": { /* Default prop values */ },
  "metadata": {
    "scannedAt": "2026-02-15T...",
    "scanMethod": "ts-morph",
    "propsTypeName": "HeroProps",
    "customized": []
  }
}
```

**Documentation Required:**
- Schema format requirements (JSON Schema Draft 7)
- Prop type mappings (string â†’ text input, number â†’ number input, boolean â†’ checkbox, etc.)
- Custom widgets (@rjsf/core â€” how to register, example implementations)
- Category conventions (Marketing, Content, Layout, E-commerce, etc.)
- Naming conventions (id format: `category--ComponentName`, label vs component path)
- Example blocks (Hero, Features, ProductGrid, Testimonials, CTA)

**Consumers:**
- `block-api.ts` â†’ `listBlocks()`, `getBlock()`
- `block-picker.tsx` â†’ Shows blocks when adding to page
- `block-detail.tsx` â†’ Shows schema + prop editor
- `page-composer.tsx` â†’ Fetches schema for selected block's prop editor

**Modification Type:** Documentation
**Estimated Effort:** 4-6 hours

## Component Modifications

### New Components: ZERO

### Modified Components: 3

| Component | Change | Priority |
|-----------|--------|----------|
| `preview-panel.tsx` | Add `forwardRef` + `useImperativeHandle` | HIGH (blocker) |
| `page-composer.tsx` | Remove dead ref, use preview ref | HIGH (blocker) |
| `plugin-empty-state.tsx` | Polish error states, validation | MEDIUM |
| `page-composer.tsx` (i18n) | Polish locale switcher UI | LOW |

### Configuration Changes: 1

| File | Change | Priority |
|------|--------|----------|
| `client/index.tsx` | Wire sidebar items to routes | HIGH (blocker) |

## Data Flow

### Before (v1.0) â€” Broken Bridge

```
PageComposer
  â”œâ”€ iframeRef = useRef(null)        â† âŒ Never attached
  â”œâ”€ send = useEditorMessages(ref)   â† âŒ Uses null ref
  â”‚    â””â”€ iframe.contentWindow.postMessage(...)  â† âŒ contentWindow is null
  â””â”€ <PreviewPanel>
       â”œâ”€ useIframeBridge()          â† âœ… Auto-sends on state change
       â””â”€ <iframe ref={setIframeRef}>â† âœ… Attached to bridge
```

Manual sends from PageComposer are no-ops. Bridge auto-sends cover most cases.

### After (v1.1) â€” Clean Bridge

```
PageComposer
  â”œâ”€ previewRef = useRef<PreviewPanelHandle>(null)
  â””â”€ <PreviewPanel ref={previewRef}>
       â”œâ”€ useIframeBridge()
       â”‚    â”œâ”€ Auto-sends: page-config, select-block on prop change
       â”‚    â””â”€ Exposes send() via useImperativeHandle
       â””â”€ <iframe ref={setIframeRef}>

Manual sends:
  previewRef.current?.send({ type: "deco:update-block", ... })
    â†’ Forwards to bridge's send()
    â†’ Reaches iframe.contentWindow.postMessage()
```

Single source of truth for iframe ref. All sends reach the iframe.

## Build Order

### Phase 1: Iframe Bridge Fix (BLOCKER)
**Dependencies:** None
**Risk:** Low (refactor existing code)
**Time:** 2-3 hours

**Tasks:**
1. Add `PreviewPanelHandle` interface
2. Convert `PreviewPanel` to `forwardRef`
3. Add `useImperativeHandle` to expose `send()`
4. Update `PageComposer` to use `previewRef.current?.send()`
5. Remove dead `iframeRef` and `useEditorMessages` from PageComposer
6. Test all postMessage flows work

**Acceptance:**
- âœ… Prop editor changes update preview immediately
- âœ… Undo/redo triggers preview updates
- âœ… Block reordering updates preview
- âœ… No console errors about null contentWindow

### Phase 2: Sidebar Navigation Wiring
**Dependencies:** Phase 1 (shared navigation context)
**Risk:** Low (configuration change)
**Time:** 1 hour

**Tasks:**
1. Check `registerSidebarGroup` API for `to` or `onClick` props
2. Add route binding if needed
3. Test navigation between Pages / Sections / Loaders
4. Verify active state highlighting

**Acceptance:**
- âœ… Clicking "Sections" navigates to `/sections`
- âœ… Clicking "Loaders" navigates to `/loaders`
- âœ… Active tab highlighted
- âœ… Browser back button works

### Phase 3: Connection Wizard Polish
**Dependencies:** None (independent)
**Risk:** Low (cosmetic)
**Time:** 2-3 hours

**Tasks:**
1. Add path validation (folder exists, readable, has package.json)
2. Improve error messages (specific reasons)
3. Add success toast after connection created
4. Polish loading states

**Acceptance:**
- âœ… Invalid paths show helpful error
- âœ… Success toast on connection
- âœ… Loading states clear

### Phase 4: i18n Polish
**Dependencies:** None (independent)
**Risk:** Low (cosmetic + keyboard shortcuts)
**Time:** 2-3 hours

**Tasks:**
1. Replace text badges with flag emojis or ISO codes
2. Add keyboard shortcuts (Cmd+Shift+1/2/3)
3. Improve new locale input UX (validation)
4. Optional: Add delete variant button

**Acceptance:**
- âœ… Locale switcher shows flags/codes
- âœ… Keyboard shortcuts work
- âœ… Creating new locale validates input

### Phase 5: Blocks Spec Documentation
**Dependencies:** None (parallel track)
**Risk:** Low (docs only)
**Time:** 4-6 hours

**Tasks:**
1. Document block JSON schema format
2. Document prop type mappings
3. Document category conventions
4. Document custom widgets
5. Provide example blocks

**Acceptance:**
- âœ… Developer can hand-write block definition
- âœ… All schema fields explained
- âœ… Category naming conventions clear

## Timeline

```
Day 1: Phase 1 (Iframe Bridge Fix)
  â””â”€ Blocker for thorough testing

Day 2: Phase 2 (Sidebar) + Phase 3 (Connection Polish)
  â””â”€ Independent, can parallelize

Day 3: Phase 4 (i18n Polish)
  â””â”€ Independent, can overlap with Phase 5

Day 3-4: Phase 5 (Blocks Spec Docs)
  â””â”€ Parallel track, can hand off to tech writer
```

**Critical Path:** Phase 1 must complete before extensive testing, as it affects all preview interactions.

**Parallelizable:** Phases 2-5 have no dependencies on each other.

## Verification

### Per-Phase Testing

**Phase 1 (Iframe Bridge):**
- [ ] Open page editor
- [ ] Edit block props â†’ preview updates immediately
- [ ] Undo (Cmd+Z) â†’ preview reverts
- [ ] Redo (Cmd+Shift+Z) â†’ preview re-applies change
- [ ] Reorder blocks â†’ preview updates order
- [ ] No console errors about null contentWindow

**Phase 2 (Sidebar):**
- [ ] Click "Sections" â†’ navigates to `/sections`
- [ ] Click "Loaders" â†’ navigates to `/loaders`
- [ ] Click "Pages" â†’ navigates to `/`
- [ ] Active tab highlighted
- [ ] Browser back button works

**Phase 3 (Connection):**
- [ ] Invalid path â†’ helpful error
- [ ] Valid path â†’ connection created, success toast
- [ ] Connection appears in header selector

**Phase 4 (i18n):**
- [ ] Locale badges show flags/codes
- [ ] Cmd+Shift+1 switches to first locale
- [ ] Creating new locale validates input
- [ ] Switching locale updates preview

**Phase 5 (Blocks Spec):**
- [ ] Documentation published
- [ ] Example blocks provided
- [ ] Schema format clear

### Integration Testing (All Phases Complete)

- [ ] End-to-end: Connect site â†’ Browse sections â†’ Add block â†’ Edit props â†’ Switch locale â†’ Preview updates
- [ ] Cross-browser: Chrome, Safari, Firefox
- [ ] Performance: Editor loads < 2s, preview updates < 100ms
- [ ] Error handling: Network failure, invalid schema, missing files

## Known Limitations

### v1.1 Scope Exclusions

**Not included:**
- Loader bindings in Sections/Loaders detail pages (browsing only)
- Block scanning UI (placeholder button exists)
- Page folders / hierarchical organization
- Bulk operations
- Collaborative editing
- Version history UI polish

**Technical Debt:**
- `useEditorMessages` may be unused after bridge fix (consider deprecating)
- Sidebar API unclear from code review (needs runtime verification)
- Block/loader scanning tools exist but not wired to UI

## Sources

**Code Inspection (HIGH confidence):**
- `/Users/guilherme/Projects/mesh/packages/mesh-plugin-site-editor/client/` (all components)
- `/Users/guilherme/Projects/mesh/packages/mesh-plugin-site-editor/client/lib/` (all APIs)
- `/Users/guilherme/Projects/mesh/packages/mesh-plugin-site-editor/server/` (tools)
