---
title: "Kubernetes: Helm Chart"
description: Deploy do MCP Mesh no Kubernetes usando o Helm chart
icon: Rocket
---

import Callout from "../../../../components/ui/Callout.astro";

Este guia explica como fazer deploy do MCP Mesh no Kubernetes usando o Helm chart.

Saiba mais: [página do MCP Mesh](https://www.decocms.com/mesh)

Código-fonte do Helm chart: [decocms/helm-chart-deco-mcp-mesh](https://github.com/decocms/helm-chart-deco-mcp-mesh)

## Visão Geral

Este Helm chart encapsula todos os recursos Kubernetes necessários para executar a aplicação:

- **Deployment**: aplicação principal com configurações de segurança
- **Service**: exposição interna da aplicação
- **ConfigMap**: configurações não sensíveis
- **Secret**: dados sensíveis (autenticação)
- **PersistentVolumeClaim**: armazenamento persistente para o banco
- **ServiceAccount**: service account para o pod
- **HorizontalPodAutoscaler**: autoscaling automático (opcional)

### Principais recursos

- ✅ **Parametrizável**: todas as configurações via `values.yaml`
- ✅ **Reutilizável**: deploy em múltiplos ambientes com valores diferentes
- ✅ **Flexível**: suporte a volumes adicionais, tolerations e affinity
- ✅ **Observável**: health checks e labels padronizadas
- ✅ **Escalável**: HPA opcional para autoscaling

### Arquitetura

![Infraestrutura](https://raw.githubusercontent.com/decocms/helm-chart-deco-mcp-mesh/main/img/mcp-mesh-infra-arch.jpg)

## Pré-requisitos

- Kubernetes 1.32+
- Helm 3.0+
- `kubectl` configurado para acessar o cluster
- StorageClass configurado (para PVC)

## Início Rápido

A forma mais simples de colocar a aplicação no ar no k8s:

```bash
# 1. Gere um secret seguro para autenticação
SECRET=$(openssl rand -base64 32)

# 2. Instale o chart com o secret gerado
helm install deco-mcp-mesh . \
  --namespace deco-mcp-mesh \
  --create-namespace \
  --set secret.BETTER_AUTH_SECRET="$SECRET"

# 3. Aguarde os pods ficarem prontos
kubectl wait --for=condition=ready pod \
  -l app.kubernetes.io/instance=deco-mcp-mesh \
  -n deco-mcp-mesh \
  --timeout=300s

# 4. Acesse via port-forward
kubectl port-forward svc/deco-mcp-mesh 8080:80 -n deco-mcp-mesh
```

A aplicação ficará disponível em `http://localhost:8080`.

<Callout type="warning">
  **Importante para Produção:** esta configuração usa SQLite e é adequada apenas para desenvolvimento/testes. Para produção, configure:

  - **PostgreSQL** como engine do banco (`database.engine: postgresql`)
  - **Autoscaling** habilitado (`autoscaling.enabled: true`) com valores apropriados
  - **Persistência distribuída** (`persistence.distributed: true`) ou PostgreSQL para permitir múltiplas réplicas

  Veja a seção de Configuração abaixo para mais detalhes de configuração de produção.
</Callout>

## Instalação

### Instalação básica

```bash
# Preparando parâmetros necessários
# Ajuste o values.yaml com as configurações desejadas para seu ambiente

# Instale com valores padrão
helm install deco-mcp-mesh . --namespace deco-mcp-mesh --create-namespace

# Instale com valores customizados
helm install deco-mcp-mesh . -f my-values.yaml -n deco-mcp-mesh --create-namespace
```

### Verificar instalação

```bash
# Ver status do release
helm status deco-mcp-mesh -n deco-mcp-mesh

# Ver recursos criados
kubectl get all -l app.kubernetes.io/instance=deco-mcp-mesh -n deco-mcp-mesh

# Ver logs
kubectl logs -l app.kubernetes.io/instance=deco-mcp-mesh -n deco-mcp-mesh
```

### Usando External Secrets

Para manter valores sensíveis fora do `values.yaml` (útil em GitOps como ArgoCD), você pode criar Secrets manualmente e referenciá-los no values.

#### Passo 1: Criar Secrets manualmente

Edite `examples/secrets-example.yaml` com seus valores reais e aplique:

```bash
# Edite o arquivo com seus valores reais
# Depois aplique os Secrets
kubectl apply -f examples/secrets-example.yaml -n deco-mcp-mesh
```

O arquivo de Secrets contém:
- **Secret principal** (`deco-mcp-mesh-secrets`): contém `BETTER_AUTH_SECRET` e `DATABASE_URL`
- **Secret de Auth Config** (`deco-mcp-mesh-auth-secrets`): contém client IDs/secrets de OAuth e API keys

#### Passo 2: Configurar values.yaml para usar Secrets

```yaml
secret:
  # Referencie o Secret existente criado manualmente
  secretName: "deco-mcp-mesh-secrets"
  
  # Referencie o Secret de authConfig
  authConfigSecretName: "deco-mcp-mesh-auth-secrets"

database:
  engine: postgresql
  # Deixe url vazio quando usar Secret - o valor vem de DATABASE_URL no Secret
  url: ""

configMap:
  authConfig:
    socialProviders:
      google:
        # Deixe vazio quando usar Secret - valores vêm do Secret
        clientId: ""
        clientSecret: ""
      github:
        clientId: ""
        clientSecret: ""
    emailProviders:
      - id: "resend-primary"
        provider: "resend"
        config:
          apiKey: ""  # Deixe vazio quando usar Secret
          fromEmail: "noreply@decocms.com"
```

#### Passo 3: Instalar/atualizar

```bash
# Instale com values que referenciam external Secrets
helm install deco-mcp-mesh . -f values-custom.yaml -n deco-mcp-mesh --create-namespace

# Ou atualize um release existente
helm upgrade deco-mcp-mesh . -f values-custom.yaml -n deco-mcp-mesh
```

**Nota**: quando `secret.secretName` é definido, o chart usará o Secret existente em vez de criar um novo. Valores definidos em `values.yaml` têm precedência sobre valores do Secret (para compatibilidade retroativa).

### Desinstalar

```bash
helm uninstall deco-mcp-mesh -n deco-mcp-mesh
```

## Configuração

### Valores principais

Os principais valores configuráveis estão em `values.yaml`.

| Parâmetro | Descrição | Padrão |
|-----------|-----------|--------|
| `replicaCount` | Número de réplicas | `3` |
| `image.repository` | Repositório da imagem | `ghcr.io/decocms/mesh/mesh` |
| `image.tag` | Tag da imagem | `latest` |
| `service.type` | Tipo do Service | `ClusterIP` |
| `persistence.enabled` | Habilitar PVC | `true` |
| `persistence.distributed` | PVC suporta ReadWriteMany | `true` |
| `persistence.accessMode` | Modo de acesso do PVC | `ReadWriteMany` |
| `persistence.storageClass` | StorageClass do PVC | `efs` |
| `autoscaling.enabled` | Habilitar HPA | `false` |
| `database.engine` | Banco (`sqlite`/`postgresql`) | `sqlite` |
| `database.url` | URL do banco quando PostgreSQL | `""` |
| `database.caCert` | Certificado CA para validação SSL (bancos gerenciados) | `""` |

### Customizando valores

Crie um arquivo `custom-values.yaml`:

```yaml
replicaCount: 2

image:
  tag: "v1.2.3" # Exemplo

service:
  type: LoadBalancer
  port: 80

database:
  engine: postgresql
  url: "postgresql://mesh_user:mesh_password@mesh.example.com:5432/mesh_db"  
  caCert: |
    -----BEGIN CERTIFICATE-----
    aaaaaaaabbbbbbcccccccccddddddd
    aaaaaaaabbbbbbcccccccccddddddd
    -----END CERTIFICATE-----

resources:
  requests:
    memory: "300Mi"
    cpu: "250m"
  limits:
    memory: "512Mi"
    cpu: "500m"

persistence:
  size: 10Gi
  storageClass: "gp3"
```

Instale com valores customizados:

```bash
helm install deco-mcp-mesh . -f custom-values.yaml -n deco-mcp-mesh --create-namespace
```

## Estrutura do chart

```
chart-deco-mcp-mesh/
├── Chart.yaml              # Metadados do chart
├── values.yaml             # Valores padrão
├── templates/              # Templates Kubernetes
│   ├── _helpers.tpl        # Funções auxiliares
│   ├── deployment.yaml     # Deployment da aplicação
│   ├── service.yaml        # Service
│   ├── configmap.yaml      # ConfigMap principal
│   ├── configmap-auth.yaml # ConfigMap de autenticação
│   ├── secret.yaml         # Secret
│   ├── pvc.yaml            # PersistentVolumeClaim
│   ├── serviceaccount.yaml # ServiceAccount
│   ├── hpa.yaml            # HorizontalPodAutoscaler
│   └── NOTES.txt           # Mensagens pós-instalação
└── README.md               # Este arquivo
```

## Templates e funcionalidade

Esta seção explica como o chart se comporta (render/runtime). Para o código completo, veja o repositório: [decocms/helm-chart-deco-mcp-mesh](https://github.com/decocms/helm-chart-deco-mcp-mesh).

### `_helpers.tpl` (naming + labels)

- **`name`**: usa `nameOverride` (ou o nome do chart) e trunca em 63 chars.
- **`fullname`**: usa `fullnameOverride` se definido; caso contrário, usa **apenas** `.Release.Name` (importante ao escolher o nome do release).
- **Labels/selectorLabels**: labels padrão Helm/K8s usadas nos templates.

### `deployment.yaml` (pods)

- **HPA vs replicas**: quando `autoscaling.enabled: true`, o deployment **não** define `replicas` (o HPA controla).
- **Auto-detecção de strategy** (quando `strategy.type` não é definido):
  - **RollingUpdate** ao usar PostgreSQL ou storage distribuído
  - **Recreate** para SQLite com storage single-writer (default seguro)
- **Persistência**:
  - `persistence.enabled: true` → monta um PVC em `/app/data`
  - `persistence.enabled: false` → usa `emptyDir` (dados efêmeros)

### `service.yaml` (exposição)

- Usa `service.type` (`ClusterIP`, `NodePort`, `LoadBalancer`) e selectors padrão.
- `sessionAffinity` opcional, se configurado.

### `configmap*.yaml` e `secret.yaml` (config + secrets)

- Configurações não sensíveis vão para **ConfigMap**.
- Valores sensíveis vão para **Secret**.
- `secret.secretName` permite “trazer seu próprio Secret” (External Secrets Operator, etc).

### `pvc.yaml` (storage)

- Cria um PVC apenas quando `persistence.enabled: true` **e** `persistence.claimName` está vazio.
- Se `persistence.claimName` estiver definido, o chart **referencia** um PVC existente.

### `hpa.yaml` (autoscaling)

- Renderizado apenas quando `autoscaling.enabled: true`.

## Valores configuráveis

A lista completa está em `values.yaml`; abaixo estão os knobs mais importantes.

### Image

```yaml
image:
  repository: ghcr.io/decocms/mesh/mesh
  pullPolicy: Always # Always, IfNotPresent, Never
  tag: "latest"
```

### Réplicas, scaling e strategy

```yaml
replicaCount: 3 # Ignorado se autoscaling.enabled: true

autoscaling:
  enabled: false
  minReplicas: 3
  maxReplicas: 6
  targetMemoryUtilizationPercentage: 80

strategy:
  # type: "" # deixe vazio para auto-detecção
```

**Restrição de escalabilidade**:

- Use `replicaCount > 1` ou `autoscaling.enabled: true` apenas quando tiver **PostgreSQL** (`database.engine: postgresql`) ou **storage distribuído** (`persistence.distributed: true` / `accessMode: ReadWriteMany`).

### Persistência

```yaml
persistence:
  enabled: true
  storageClass: "efs"
  accessMode: ReadWriteMany
  size: 10Gi
  claimName: "" # se definido, usa um PVC existente
  distributed: true
```

### Banco (SQLite vs PostgreSQL)

```yaml
database:
  engine: sqlite # sqlite | postgresql
  url: "" # obrigatório quando engine=postgresql
  caCert: "" # CA opcional para validação SSL de Postgres gerenciado
```

### Service

```yaml
service:
  type: ClusterIP # ClusterIP, NodePort, LoadBalancer
  port: 80
  targetPort: 3000
```

### Recursos

```yaml
resources:
  requests:
    memory: "300Mi"
    cpu: "250m"
  limits:
    memory: "600Mi"
    cpu: "500m"
```

## Exemplos de uso

### Exemplo 1: Deploy básico

```bash
helm install deco-mcp-mesh . -n deco-mcp-mesh --create-namespace
```

### Exemplo 2: Deploy com values customizados

```bash
helm install deco-mcp-mesh . -f production-values.yaml -n deco-mcp-mesh --create-namespace
```

### Exemplo 3: Deploy com autoscaling

```bash
helm install deco-mcp-mesh . -f autoscaling-values.yaml -n deco-mcp-mesh --create-namespace
```

### Exemplo 4: Deploy com Secret existente

```bash
helm install deco-mcp-mesh . -f existing-secret-values.yaml -n deco-mcp-mesh --create-namespace
```

## Manutenção e atualizações

### Atualizar values

```bash
# Edite values.yaml ou crie um novo arquivo
vim custom-values.yaml

# Atualize o release
helm upgrade deco-mcp-mesh . -f custom-values.yaml -n deco-mcp-mesh

# Ver histórico
helm history deco-mcp-mesh -n deco-mcp-mesh

# Rollback
helm rollback deco-mcp-mesh -n deco-mcp-mesh
```

### Atualizar image

```bash
# Opção 1: Atualize values e faça upgrade
helm upgrade deco-mcp-mesh . \
  --set image.tag=v1.2.3 \
  -n deco-mcp-mesh

# Opção 2: Se pullPolicy=Always, reinicie
kubectl rollout restart deployment/deco-mcp-mesh -n deco-mcp-mesh
```

### Atualizar ConfigMap/Secret

```bash
# Edite values.yaml
vim values.yaml

# Aplique mudanças
helm upgrade deco-mcp-mesh . -n deco-mcp-mesh

# Reinicie pods para aplicar mudanças
kubectl rollout restart deployment/deco-mcp-mesh -n deco-mcp-mesh
```

### Verificar mudanças antes de aplicar

```bash
# Renderize manifests localmente
helm template deco-mcp-mesh . -n deco-mcp-mesh

# Se você usa helm-diff
helm diff upgrade deco-mcp-mesh . -n deco-mcp-mesh
```

### Backup do banco (SQLite)

```bash
POD=$(kubectl get pod -l app.kubernetes.io/instance=deco-mcp-mesh -n deco-mcp-mesh -o jsonpath='{.items[0].metadata.name}')
kubectl cp deco-mcp-mesh/$POD:/app/data/mesh.db ./backup-$(date +%Y%m%d).db
```

## Segurança

<Callout type="warning">
  **Não commit secrets no Git.** Prefira External Secrets Operator (ou similar) ou passe secrets no momento do install.
</Callout>

Exemplo:

```bash
helm install deco-mcp-mesh . \
  --set secret.BETTER_AUTH_SECRET="$(openssl rand -base64 32)" \
  -n deco-mcp-mesh --create-namespace
```

## Monitoramento

```bash
# Ver todos os recursos do release
kubectl get all -l app.kubernetes.io/instance=deco-mcp-mesh -n deco-mcp-mesh

# Logs
kubectl logs -l app.kubernetes.io/instance=deco-mcp-mesh -n deco-mcp-mesh

# Métricas (se metrics-server estiver instalado)
kubectl top pods -l app.kubernetes.io/instance=deco-mcp-mesh -n deco-mcp-mesh
```



