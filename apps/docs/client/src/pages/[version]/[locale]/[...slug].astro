---
import { useTranslations } from "../../../i18n/utils";
import { ui, languages } from "../../../i18n/ui";
import DocsLayout from "../../../layouts/DocsLayout.astro";
import { getCollection } from "astro:content";
import RenderDocument from "../../../components/ui/RenderDocument.astro";

const version = Astro.params.version;
const lang = Astro.params.locale;
const t = useTranslations(lang as keyof typeof ui);

export async function getStaticPaths() {
  const allDocs = await getCollection("docs");

  const versions = ["latest", "draft"];

  return versions.flatMap((version) => [
    // Root version paths
    ...Object.keys(languages).map((locale) => ({
      params: { version, locale },
      props: { doc: null, version },
    })),
    // Legacy path redirects
    ...Object.keys(languages).flatMap((locale) => [
      {
        params: { version, locale, slug: "getting-started/context-engineers" },
        props: { doc: null, version },
      },
    ]),
    // All docs filtered by version
    ...allDocs
      .filter((doc) => doc.id.startsWith(`${version}/`))
      .map((doc) => {
        const parts = doc.id.split("/");
        const locale = parts[1];
        const slug = parts.slice(2).join("/");

        return {
          params: { version, locale, slug },
          props: { doc, version },
        };
      }),
  ]);
}

const { doc, version: propVersion } = Astro.props;
const slug = Astro.params.slug;

// Legacy redirects
if (slug === "getting-started/context-engineers") {
  return Astro.redirect(`/${version}/${lang}/getting-started/developers`);
}

// Redirect to quickstart if no document is found
if (!doc) {
  return Astro.redirect(`/${version}/${lang}/mcp-mesh/quickstart`);
}
---

<DocsLayout title={doc.data.title} doc={doc} version={propVersion}>
  <RenderDocument doc={doc} />
</DocsLayout>
