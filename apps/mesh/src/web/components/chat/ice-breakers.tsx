import {
  fetchVirtualMCPPrompt,
  useVirtualMCPPrompts,
  type VirtualMCPPrompt,
} from "@/web/hooks/use-virtual-mcp-prompts";
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@deco/ui/components/popover.tsx";
import { Skeleton } from "@deco/ui/components/skeleton.tsx";
import { Spinner } from "@deco/ui/components/spinner.tsx";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@deco/ui/components/tooltip.tsx";
import { cn } from "@deco/ui/lib/utils.ts";
import { Suspense, useReducer, useState } from "react";
import { toast } from "sonner";
import { ErrorBoundary } from "../error-boundary";
import { useChat } from "./context";
import {
  PromptArgsDialog,
  type PromptArgumentValues,
} from "./dialog-prompt-arguments";
import { appendToTiptapDoc } from "./tiptap/utils";
import { createMentionDoc } from "./tiptap/mention/node";

interface IceBreakersProps {
  prompts: VirtualMCPPrompt[];
  onSelect: (prompt: VirtualMCPPrompt) => void;
  loadingPrompt?: VirtualMCPPrompt | null;
  className?: string;
}

const MAX_VISIBLE = 3;

function PromptPill({
  prompt,
  onSelect,
  isSelected,
  isDisabled,
  isLoading,
}: {
  prompt: VirtualMCPPrompt;
  onSelect: (prompt: VirtualMCPPrompt) => void;
  isSelected?: boolean;
  isDisabled?: boolean;
  isLoading?: boolean;
}) {
  const promptText = prompt.description ?? prompt.name;
  return (
    <Tooltip>
      <TooltipTrigger asChild>
        <button
          type="button"
          onClick={() => onSelect(prompt)}
          disabled={isDisabled || isLoading}
          className={cn(
            "px-3 py-1.5 text-xs text-muted-foreground hover:text-foreground border border-border rounded-full hover:bg-accent/50 transition-colors cursor-pointer flex items-center gap-1.5",
            isSelected && "bg-accent/50 text-foreground",
            isLoading && "bg-accent/50 text-foreground",
            (isDisabled || isLoading) &&
              "cursor-not-allowed hover:bg-accent/50",
          )}
        >
          {(prompt.title ?? prompt.name).replace(/_/g, " ")}
          {isLoading && <Spinner size="xs" />}
        </button>
      </TooltipTrigger>
      <TooltipContent side="bottom" className="max-w-xs">
        <p className="text-xs">{promptText}</p>
      </TooltipContent>
    </Tooltip>
  );
}

/**
 * IceBreakers - Displays virtual MCP prompts as clickable conversation starters
 *
 * Shows prompts as compact pills that, when clicked, submit the prompt as the first message
 */
function IceBreakers({
  prompts,
  onSelect,
  loadingPrompt,
  className,
}: IceBreakersProps) {
  if (prompts.length === 0) return null;

  const visiblePrompts = prompts.slice(0, MAX_VISIBLE);
  const hiddenPrompts = prompts.slice(MAX_VISIBLE);
  const hasMore = hiddenPrompts.length > 0;
  const isAnyLoading = !!loadingPrompt;

  return (
    <TooltipProvider delayDuration={300}>
      <div
        className={cn(
          "flex flex-wrap items-center justify-center gap-2",
          className,
        )}
      >
        {visiblePrompts.map((prompt) => (
          <PromptPill
            key={prompt.name}
            prompt={prompt}
            onSelect={onSelect}
            isLoading={loadingPrompt?.name === prompt.name}
            isDisabled={isAnyLoading && loadingPrompt?.name !== prompt.name}
          />
        ))}
        {hasMore && (
          <Popover>
            <PopoverTrigger asChild>
              <button
                type="button"
                disabled={isAnyLoading}
                className={cn(
                  "size-7 flex items-center justify-center text-xs text-muted-foreground hover:text-foreground border border-border rounded-full hover:bg-accent/50 transition-colors cursor-pointer",
                  isAnyLoading && "opacity-60 cursor-not-allowed",
                )}
              >
                +{hiddenPrompts.length}
              </button>
            </PopoverTrigger>
            <PopoverContent side="bottom" align="center" className="w-auto p-2">
              <div className="flex flex-col gap-1">
                {hiddenPrompts.map((prompt) => {
                  const promptText = prompt.description ?? prompt.name;
                  const isLoading = loadingPrompt?.name === prompt.name;
                  return (
                    <Tooltip key={prompt.name}>
                      <TooltipTrigger asChild>
                        <button
                          type="button"
                          onClick={() => onSelect(prompt)}
                          disabled={isAnyLoading && !isLoading}
                          className={cn(
                            "px-3 py-1.5 text-xs text-muted-foreground hover:text-foreground hover:bg-accent/50 rounded-md transition-colors cursor-pointer text-left flex items-center gap-1.5",
                            isLoading && "bg-accent/50 text-foreground",
                            isAnyLoading &&
                              !isLoading &&
                              "opacity-60 cursor-not-allowed",
                          )}
                        >
                          {(prompt.title ?? prompt.name).replace(/_/g, " ")}
                          {isLoading && <Spinner size="xs" />}
                        </button>
                      </TooltipTrigger>
                      <TooltipContent side="right" className="max-w-xs">
                        <p className="text-xs">{promptText}</p>
                      </TooltipContent>
                    </Tooltip>
                  );
                })}
              </div>
            </PopoverContent>
          </Popover>
        )}
      </div>
    </TooltipProvider>
  );
}

interface GatewayIceBreakersProps {
  className?: string;
}

/**
 * Fallback component for Suspense that maintains min-height to prevent layout shift
 * Shows skeleton pills matching the actual IceBreakers appearance
 */
function IceBreakersFallback() {
  return (
    <>
      <Skeleton className="h-6 w-20 rounded-full border border-border" />
      <Skeleton className="h-6 w-24 rounded-full border border-border" />
    </>
  );
}

/**
 * State machine for ice breakers
 */
type IceBreakerState =
  | { stage: "idle" }
  | {
      stage: "loading";
      prompt: VirtualMCPPrompt;
      arguments?: PromptArgumentValues;
    };

type IceBreakerAction =
  | { type: "SELECT_PROMPT"; prompt: VirtualMCPPrompt }
  | {
      type: "START_LOADING";
      prompt: VirtualMCPPrompt;
      arguments?: PromptArgumentValues;
    }
  | { type: "RESET" };

function iceBreakerReducer(
  state: IceBreakerState,
  action: IceBreakerAction,
): IceBreakerState {
  switch (action.type) {
    case "SELECT_PROMPT":
      // If prompt has no arguments, go directly to loading
      if (!action.prompt.arguments || action.prompt.arguments.length === 0) {
        return { stage: "loading", prompt: action.prompt };
      }
      // Otherwise, will open dialog - stay idle until dialog submits
      return { stage: "idle" };

    case "START_LOADING":
      return {
        stage: "loading",
        prompt: action.prompt,
        arguments: action.arguments,
      };

    case "RESET":
      return { stage: "idle" };

    default:
      return state;
  }
}

/**
 * Inner component that fetches and displays prompts for a specific virtual MCP
 */
function VirtualMCPIceBreakersContent({
  virtualMcpId,
}: {
  virtualMcpId: string;
}) {
  const { tiptapDoc, sendMessage } = useChat();
  const { data: prompts } = useVirtualMCPPrompts(virtualMcpId);
  const [state, dispatch] = useReducer(iceBreakerReducer, { stage: "idle" });
  const [dialogPrompt, setDialogPrompt] =
    useState<VirtualMCPPrompt | null>(null);

  const loadPrompt = async (
    prompt: VirtualMCPPrompt,
    args?: PromptArgumentValues,
  ) => {
    try {
      const result = await fetchVirtualMCPPrompt(
        virtualMcpId,
        prompt.name,
        args,
      );

      dispatch({ type: "RESET" });

      // Append prompt to current tiptapDoc and send
      const newTiptapDoc = appendToTiptapDoc(
        tiptapDoc,
        createMentionDoc({
          id: prompt.name,
          name: prompt.name,
          metadata: result.messages,
          char: "/",
        }),
      );

      await sendMessage(newTiptapDoc);
    } catch (error) {
      console.error("[ice-breakers] Failed to fetch prompt:", error);
      toast.error("Failed to load prompt. Please try again.");
      dispatch({ type: "RESET" });
    }
  };

  const handlePromptSelection = async (prompt: VirtualMCPPrompt) => {
    // If prompt has arguments, open dialog
    if (prompt.arguments && prompt.arguments.length > 0) {
      dispatch({ type: "SELECT_PROMPT", prompt });
      setDialogPrompt(prompt);
      return;
    }

    // No arguments - fetch directly
    dispatch({ type: "START_LOADING", prompt });
    await loadPrompt(prompt);
  };

  const handleDialogSubmit = async (values: PromptArgumentValues) => {
    if (!dialogPrompt) return;

    dispatch({
      type: "START_LOADING",
      prompt: dialogPrompt,
      arguments: values,
    });
    setDialogPrompt(null);
    await loadPrompt(dialogPrompt, values);
  };

  if (prompts.length === 0) {
    return null;
  }

  return (
    <div className="relative w-full">
      <IceBreakers
        prompts={prompts}
        onSelect={handlePromptSelection}
        loadingPrompt={state.stage === "loading" ? state.prompt : null}
      />
      <PromptArgsDialog
        prompt={dialogPrompt}
        setPrompt={() => {
          setDialogPrompt(null);
          dispatch({ type: "RESET" });
        }}
        onSubmit={handleDialogSubmit}
      />
    </div>
  );
}

/**
 * Ice breakers component that uses suspense to fetch virtual MCP prompts
 * Uses the chat context for virtual MCP selection and message sending.
 * Includes ErrorBoundary, Suspense, and container internally.
 */
export function GatewayIceBreakers({ className }: GatewayIceBreakersProps) {
  const { selectedVirtualMcp } = useChat();

  return (
    <div
      className={cn(
        "flex flex-wrap items-center justify-center gap-2",
        className,
      )}
      style={{ minHeight: "32px" }}
    >
      {selectedVirtualMcp && (
        <ErrorBoundary key={selectedVirtualMcp.id} fallback={null}>
          <Suspense fallback={<IceBreakersFallback />}>
            <VirtualMCPIceBreakersContent
              virtualMcpId={selectedVirtualMcp.id}
            />
          </Suspense>
        </ErrorBoundary>
      )}
    </div>
  );
}
