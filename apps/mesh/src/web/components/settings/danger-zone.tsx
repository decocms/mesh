import { useState } from "react";
import { useNavigate } from "@tanstack/react-router";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import {
  useProjectContext,
  useMCPClient,
  SELF_MCP_ALIAS_ID,
  ORG_ADMIN_PROJECT_SLUG,
} from "@decocms/mesh-sdk";
import { KEYS } from "@/web/lib/query-keys";
import { Button } from "@deco/ui/components/button.tsx";
import { Input } from "@deco/ui/components/input.tsx";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@deco/ui/components/alert-dialog.tsx";
import { toast } from "sonner";

type ProjectDeleteOutput = {
  success: boolean;
  message?: string;
};

export function DangerZone() {
  const { org, project } = useProjectContext();
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [confirmName, setConfirmName] = useState("");
  const [isOpen, setIsOpen] = useState(false);
  const isOrgAdmin = project.slug === ORG_ADMIN_PROJECT_SLUG;

  const client = useMCPClient({
    connectionId: SELF_MCP_ALIAS_ID,
    orgId: org.id,
  });

  const mutation = useMutation({
    mutationFn: async () => {
      const result = (await client.callTool({
        name: "PROJECT_DELETE",
        arguments: {
          projectId: project.id,
        },
      })) as { structuredContent?: unknown };
      return (result.structuredContent ?? result) as ProjectDeleteOutput;
    },
    onSuccess: (result) => {
      if (result.success) {
        queryClient.invalidateQueries({
          queryKey: KEYS.projects(org.id),
        });
        toast.success("Project deleted");
        navigate({
          to: "/$org/$project",
          params: { org: org.slug, project: ORG_ADMIN_PROJECT_SLUG },
        });
      } else {
        toast.error(result.message ?? "Failed to delete project");
      }
    },
    onError: (error) => {
      toast.error(
        "Failed to delete project: " +
          (error instanceof Error ? error.message : "Unknown error"),
      );
    },
  });

  // Don't show danger zone for org-admin
  if (isOrgAdmin) {
    return null;
  }

  const canDelete = confirmName === project.name;

  const handleDelete = () => {
    mutation.mutate();
  };

  const handleOpenChange = (open: boolean) => {
    setIsOpen(open);
    if (!open) {
      setConfirmName("");
    }
  };

  return (
    <div className="border border-destructive/50 rounded-lg p-4 space-y-4">
      <div>
        <h3 className="font-semibold text-destructive">Danger Zone</h3>
        <p className="text-sm text-muted-foreground mt-1">
          Irreversible and destructive actions.
        </p>
      </div>

      <AlertDialog open={isOpen} onOpenChange={handleOpenChange}>
        <AlertDialogTrigger asChild>
          <Button variant="destructive">Delete Project</Button>
        </AlertDialogTrigger>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete "{project.name}"?</AlertDialogTitle>
            <AlertDialogDescription>
              This action cannot be undone. All project data will be permanently
              deleted.
            </AlertDialogDescription>
          </AlertDialogHeader>

          <div className="py-4">
            <p className="text-sm mb-2">
              Type <strong>{project.name}</strong> to confirm:
            </p>
            <Input
              value={confirmName}
              onChange={(e) => setConfirmName(e.target.value)}
              placeholder={project.name}
            />
          </div>

          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              disabled={!canDelete || mutation.isPending}
              className="bg-destructive hover:bg-destructive/90 text-destructive-foreground"
            >
              {mutation.isPending ? "Deleting..." : "Delete Project"}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}
